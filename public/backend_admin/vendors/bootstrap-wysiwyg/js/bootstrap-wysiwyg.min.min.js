!function(a){var b=function(d){var f=a.Deferred(),c=new FileReader;return c.onload=function(e){f.resolve(e.target.result)},c.onerror=f.reject,c.onprogress=f.notify,c.readAsDataURL(d),f.promise()};a.fn.cleanHtml=function(g){if(a(this).data("wysiwyg-html-mode")===!0&&(a(this).html(a(this).text()),a(this).attr("contenteditable",!0),a(this).data("wysiwyg-html-mode",!1)),g===!0&&a(this).parent().is("form")){var j=a(this).html;if(a(j).has("img").length){var c=a("img",a(j)),h=[],d=a(this).parent();a.each(c,function(i,k){a(k).attr("src").match(/^data:image\/.*$/)&&(h.push(c[i]),a(d).prepend("<input value='"+a(k).attr("src")+"' type='hidden' name='postedimage/"+i+"' />"),a(k).attr("src","postedimage/"+i))})}}var f=a(this).html();return f&&f.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},a.fn.wysiwyg=function(q){var E,k,w,e=this,v=function(){k.activeToolbarClass&&a(k.toolbarSelector).find(w).each(function(){var c=a(this).data(k.commandRole).split(" "),d=c[0];c.length>1&&document.queryCommandEnabled(d)&&document.queryCommandValue(d)===c[1]?a(this).addClass(k.activeToolbarClass):1===c.length&&document.queryCommandEnabled(d)&&document.queryCommandState(d)?a(this).addClass(k.activeToolbarClass):a(this).removeClass(k.activeToolbarClass)})},G=function(f,g){var l=f.split(" "),c=l.shift(),h=l.join(" ")+(g||""),d=f.split("-");1===d.length?document.execCommand(c,!1,h):"format"===d[0]&&2===d.length&&document.execCommand("formatBlock",!1,d[1]),e.trigger("change"),v()},B=function(c){a.each(c,function(d,f){e.keydown(d,function(g){e.attr("contenteditable")&&e.is(":visible")&&(g.preventDefault(),g.stopPropagation(),G(f))}).keyup(d,function(g){e.attr("contenteditable")&&e.is(":visible")&&(g.preventDefault(),g.stopPropagation())})}),e.keyup(function(){e.trigger("change")})},C=function(){var c,d;return window.getSelection?(c=window.getSelection(),c.getRangeAt&&c.rangeCount&&(d=c.getRangeAt(0))):document.selection&&(d=document.selection.createRange()),d},F=function(){E=C()},t=function(){var c;if(window.getSelection||document.createRange){if(c=window.getSelection(),E){try{c.removeAllRanges()}catch(d){document.body.createTextRange().select(),document.selection.empty()}c.addRange(E)}}else{document.selection&&E&&E.select()}},x=function(){if(a(e).data("wysiwyg-html-mode")!==!0){var c=a(e).html(),d=a("<pre />");a(d).append(document.createTextNode(c)),a(d).attr("contenteditable",!0),a(e).html(" "),a(e).append(a(d)),a(e).attr("contenteditable",!1),a(e).data("wysiwyg-html-mode",!0),a(d).focus()}else{a(e).html(a(e).text()),a(e).attr("contenteditable",!0),a(e).data("wysiwyg-html-mode",!1),a(e).focus()}},A=function(c){e.focus(),a.each(c,function(f,d){/^image\//.test(d.type)?a.when(b(d)).done(function(g){G("insertimage",g),e.trigger("image-inserted")}).fail(function(g){k.fileUploadError("file-reader",g)}):k.fileUploadError("unsupported-file-type",d.type)})},j=function(c,d){t(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",!1,d||"transparent"),F(),c.data(k.selectionMarker,d)},z=function(c,d){c.find(w).click(function(){t(),e.focus(),"html"===a(this).data(d.commandRole)?x():G(a(this).data(d.commandRole)),F()}),c.find("[data-toggle=dropdown]").click(t),c.find("input[type=text][data-"+d.commandRole+"]").on("webkitspeechchange change",function(){var f=this.value;this.value="",t(),f&&(e.focus(),G(a(this).data(d.commandRole),f)),F()}).on("focus",function(){var f=a(this);f.data(d.selectionMarker)||(j(f,d.selectionColor),f.focus())}).on("blur",function(){var f=a(this);f.data(d.selectionMarker)&&j(f,!1)}),c.find("input[type=file][data-"+d.commandRole+"]").change(function(){t(),"file"===this.type&&this.files&&this.files.length>0&&A(this.files),F(),this.value=""})},D=function(){e.on("dragenter dragover",!1).on("drop",function(c){var d=c.originalEvent.dataTransfer;c.stopPropagation(),c.preventDefault(),d&&d.files&&d.files.length>0&&A(d.files)})};return k=a.extend(!0,{},a.fn.wysiwyg.defaults,q),w="a[data-"+k.commandRole+"],button[data-"+k.commandRole+"],input[type=button][data-"+k.commandRole+"]",B(k.hotKeys),""!==a(this).attr("placeholder")&&(a(this).addClass("placeholderText"),a(this).html(a(this).attr("placeholder")),a(this).bind("focus",function(){""!==a(this).attr("placeholder")&&a(this).text()===a(this).attr("placeholder")&&(a(this).removeClass("placeholderText"),a(this).html(""))}),a(this).bind("blur",function(){""!==a(this).attr("placeholder")&&""===a(this).text()&&(a(this).addClass("placeholderText"),a(this).html(a(this).attr("placeholder")))})),k.dragAndDropImages&&D(),z(a(k.toolbarSelector),k),e.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){F(),v()}),a(window).bind("touchend",function(d){var f=e.is(d.target)||e.has(d.target).length>0,g=C(),c=g&&g.startContainer===g.endContainer&&g.startOffset===g.endOffset;(!c||f)&&(F(),v())}),this},a.fn.wysiwyg.defaults={hotKeys:{"Ctrl+b meta+b":"bold","Ctrl+i meta+i":"italic","Ctrl+u meta+u":"underline","Ctrl+z":"undo","Ctrl+y meta+y meta+shift+z":"redo","Ctrl+l meta+l":"justifyleft","Ctrl+r meta+r":"justifyright","Ctrl+e meta+e":"justifycenter","Ctrl+j meta+j":"justifyfull","Shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,keypressTimeout:200,fileUploadError:function(c,d){console.log("File upload error",c,d)}}}(window.jQuery);