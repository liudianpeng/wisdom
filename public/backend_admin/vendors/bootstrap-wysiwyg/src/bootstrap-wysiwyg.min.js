(function(b){var a=function(e){var c=b.Deferred(),d=new FileReader();d.onload=function(f){c.resolve(f.target.result)};d.onerror=c.reject;d.onprogress=c.notify;d.readAsDataURL(e);return c.promise()};b.fn.cleanHtml=function(h){if(b(this).data("wysiwyg-html-mode")===true){b(this).html(b(this).text());b(this).attr("contenteditable",true);b(this).data("wysiwyg-html-mode",false)}if(h===true&&b(this).parent().is("form")){var g=b(this).html;if(b(g).has("img").length){var c=b("img",b(g));var e=[];var f=b(this).parent();b.each(c,function(k,j){if(b(j).attr("src").match(/^data:image\/.*$/)){e.push(c[k]);b(f).prepend("<input value='"+b(j).attr("src")+"' type='hidden' name='postedimage/"+k+"' />");b(j).attr("src","postedimage/"+k)}})}}var d=b(this).html();return d&&d.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")};b.fn.wysiwyg=function(l){var m=this,h,r,d,q=function(){if(r.activeToolbarClass){b(r.toolbarSelector).find(d).each(function(){var s=b(this).data(r.commandRole).split(" "),t=s[0];if(s.length>1&&document.queryCommandEnabled(t)&&document.queryCommandValue(t)===s[1]){b(this).addClass(r.activeToolbarClass)}else{if(s.length===1&&document.queryCommandEnabled(t)&&document.queryCommandState(t)){b(this).addClass(r.activeToolbarClass)}else{b(this).removeClass(r.activeToolbarClass)}}})}},p=function(s,t){var v=s.split(" "),x=v.shift(),u=v.join(" ")+(t||"");var w=s.split("-");if(w.length===1){document.execCommand(x,false,u)}else{if(w[0]==="format"&&w.length===2){document.execCommand("formatBlock",false,w[1])}}m.trigger("change");q()},f=function(s){b.each(s,function(t,u){m.keydown(t,function(v){if(m.attr("contenteditable")&&m.is(":visible")){v.preventDefault();v.stopPropagation();p(u)}}).keyup(t,function(v){if(m.attr("contenteditable")&&m.is(":visible")){v.preventDefault();v.stopPropagation()}})});m.keyup(function(){m.trigger("change")})},g=function(){var t,s;if(window.getSelection){t=window.getSelection();if(t.getRangeAt&&t.rangeCount){s=t.getRangeAt(0)}}else{if(document.selection){s=document.selection.createRange()}}return s},j=function(){h=g()},e=function(){var t;if(window.getSelection||document.createRange){t=window.getSelection();if(h){try{t.removeAllRanges()}catch(s){document.body.createTextRange().select();document.selection.empty()}t.addRange(h)}}else{if(document.selection&&h){h.select()}}},i=function(){if(b(m).data("wysiwyg-html-mode")!==true){var s=b(m).html();var t=b("<pre />");b(t).append(document.createTextNode(s));b(t).attr("contenteditable",true);b(m).html(" ");b(m).append(b(t));b(m).attr("contenteditable",false);b(m).data("wysiwyg-html-mode",true);b(t).focus()}else{b(m).html(b(m).text());b(m).attr("contenteditable",true);b(m).data("wysiwyg-html-mode",false);b(m).focus()}},k=function(s){m.focus();b.each(s,function(t,u){if(/^image\//.test(u.type)){b.when(a(u)).done(function(v){p("insertimage",v);m.trigger("image-inserted")}).fail(function(v){r.fileUploadError("file-reader",v)})}else{r.fileUploadError("unsupported-file-type",u.type)}})},c=function(t,s){e();if(document.queryCommandSupported("hiliteColor")){document.execCommand("hiliteColor",false,s||"transparent")}j();t.data(r.selectionMarker,s)},n=function(t,s){t.find(d).click(function(){e();m.focus();if(b(this).data(s.commandRole)==="html"){i()}else{p(b(this).data(s.commandRole))}j()});t.find("[data-toggle=dropdown]").click(e);t.find("input[type=text][data-"+s.commandRole+"]").on("webkitspeechchange change",function(){var u=this.value;this.value="";e();if(u){m.focus();p(b(this).data(s.commandRole),u)}j()}).on("focus",function(){var u=b(this);if(!u.data(s.selectionMarker)){c(u,s.selectionColor);u.focus()}}).on("blur",function(){var u=b(this);if(u.data(s.selectionMarker)){c(u,false)}});t.find("input[type=file][data-"+s.commandRole+"]").change(function(){e();if(this.type==="file"&&this.files&&this.files.length>0){k(this.files)}j();this.value=""})},o=function(){m.on("dragenter dragover",false).on("drop",function(t){var s=t.originalEvent.dataTransfer;t.stopPropagation();t.preventDefault();if(s&&s.files&&s.files.length>0){k(s.files)}})};r=b.extend(true,{},b.fn.wysiwyg.defaults,l);d="a[data-"+r.commandRole+"],button[data-"+r.commandRole+"],input[type=button][data-"+r.commandRole+"]";f(r.hotKeys);if(b(this).attr("placeholder")!==""){b(this).addClass("placeholderText");b(this).html(b(this).attr("placeholder"));b(this).bind("focus",function(){if(b(this).attr("placeholder")!==""&&b(this).text()===b(this).attr("placeholder")){b(this).removeClass("placeholderText");b(this).html("")}});b(this).bind("blur",function(){if(b(this).attr("placeholder")!==""&&b(this).text()===""){b(this).addClass("placeholderText");b(this).html(b(this).attr("placeholder"))}})}if(r.dragAndDropImages){o()}n(b(r.toolbarSelector),r);m.attr("contenteditable",true).on("mouseup keyup mouseout",function(){j();q()});b(window).bind("touchend",function(v){var u=(m.is(v.target)||m.has(v.target).length>0),t=g(),s=t&&(t.startContainer===t.endContainer&&t.startOffset===t.endOffset);if(!s||u){j();q()}});return this};b.fn.wysiwyg.defaults={hotKeys:{"Ctrl+b meta+b":"bold","Ctrl+i meta+i":"italic","Ctrl+u meta+u":"underline","Ctrl+z":"undo","Ctrl+y meta+y meta+shift+z":"redo","Ctrl+l meta+l":"justifyleft","Ctrl+r meta+r":"justifyright","Ctrl+e meta+e":"justifycenter","Ctrl+j meta+j":"justifyfull","Shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:true,keypressTimeout:200,fileUploadError:function(d,c){console.log("File upload error",d,c)}}}(window.jQuery));