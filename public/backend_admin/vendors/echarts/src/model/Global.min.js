define(function(i){var q=i("zrender/core/util");var p=i("../util/model");var l=i("./Model");var d=q.each;var o=q.filter;var v=q.map;var n=q.isArray;var a=q.indexOf;var k=q.isObject;var h=i("./Component");var b=i("./globalDefault");var g="\0_ec_inner";var j=l.extend({constructor:j,init:function(y,x,z,w){z=z||{};this.option=null;this._theme=new l(z);this._optionManager=w},setOption:function(w,x){q.assert(!(g in w),"please use chart.getOption()");this._optionManager.setOption(w,x);this.resetOption()},resetOption:function(y){var A=false;var x=this._optionManager;if(!y||y==="recreate"){var z=x.mountOption(y==="recreate");if(!this.option||y==="recreate"){f.call(this,z)}else{this.restoreData();this.mergeOption(z)}A=true}if(y==="timeline"||y==="media"){this.restoreData()}if(!y||y==="recreate"||y==="timeline"){var B=x.getTimelineOption(this);B&&(this.mergeOption(B),A=true)}if(!y||y==="recreate"||y==="media"){var w=x.getMediaOption(this,this._api);if(w.length){d(w,function(C){this.mergeOption(C,A=true)},this)}}return A},mergeOption:function(z){var y=this.option;var w=this._componentsMap;var x=[];d(z,function(B,C){if(B==null){return}if(!h.hasClass(C)){y[C]=y[C]==null?q.clone(B):q.merge(y[C],B,true)}else{x.push(C)}});h.topologicalTravel(x,h.getAllClassMainTypes(),A,this);function A(F,E){var B=p.normalizeToArray(z[F]);var D=p.mappingToExists(w[F],B);r(F,D);var C=t(w,E);y[F]=[];w[F]=[];d(D,function(H,I){var G=H.exist;var J=H.option;q.assert(k(J)||G,"Empty component definition");if(!J){G.mergeOption({},this);G.optionUpdated(this)}else{var K=h.getClass(F,H.keyInfo.subType,true);if(G&&G instanceof K){G.mergeOption(J,this);G.optionUpdated(this)}else{G=new K(J,this,this,q.extend({dependentModels:C,componentIndex:I},H.keyInfo));G.optionUpdated(this)}}w[F][I]=G;y[F][I]=G.option},this);if(F==="series"){this._seriesIndices=c(w.series)}}},getOption:function(){var w=q.clone(this.option);d(w,function(y,z){if(h.hasClass(z)){var y=p.normalizeToArray(y);for(var x=y.length-1;x>=0;x--){if(p.isIdInner(y[x])){y.splice(x,1)}}w[z]=y}});delete w[g];return w},getTheme:function(){return this._theme},getComponent:function(y,w){var x=this._componentsMap[y];if(x){return x[w||0]}},queryComponents:function(z){var C=z.mainType;if(!C){return[]}var B=z.index;var x=z.id;var w=z.name;var y=this._componentsMap[C];if(!y||!y.length){return[]}var E;if(B!=null){if(!n(B)){B=[B]}E=o(v(B,function(F){return y[F]}),function(F){return !!F})}else{if(x!=null){var A=n(x);E=o(y,function(F){return(A&&a(x,F.id)>=0)||(!A&&F.id===x)})}else{if(w!=null){var D=n(w);E=o(y,function(F){return(D&&a(w,F.name)>=0)||(!D&&F.name===w)})}}}return u(E,z)},findComponents:function(C){var z=C.query;var B=C.mainType;var x=A(z);var w=x?this.queryComponents(x):this._componentsMap[B];return y(u(w,C));function A(F){var E=B+"Index";var G=B+"Id";var D=B+"Name";return F&&(F.hasOwnProperty(E)||F.hasOwnProperty(G)||F.hasOwnProperty(D))?{mainType:B,index:F[E],id:F[G],name:F[D]}:null}function y(D){return C.filter?o(D,C.filter):D}},eachComponent:function(A,w,y){var x=this._componentsMap;if(typeof A==="function"){y=w;w=A;d(x,function(C,B){d(C,function(E,D){w.call(y,B,E,D)})})}else{if(q.isString(A)){d(x[A],w,y)}else{if(k(A)){var z=this.findComponents(A);d(z,w,y)}}}},getSeriesByName:function(w){var x=this._componentsMap.series;return o(x,function(y){return y.name===w})},getSeriesByIndex:function(w){return this._componentsMap.series[w]},getSeriesByType:function(x){var w=this._componentsMap.series;return o(w,function(y){return y.subType===x})},getSeries:function(){return this._componentsMap.series.slice()},eachSeries:function(w,x){e(this);d(this._seriesIndices,function(z){var y=this._componentsMap.series[z];w.call(x,y,z)},this)},eachRawSeries:function(w,x){d(this._componentsMap.series,w,x)},eachSeriesByType:function(y,w,x){e(this);d(this._seriesIndices,function(A){var z=this._componentsMap.series[A];if(z.subType===y){w.call(x,z,A)}},this)},eachRawSeriesByType:function(y,w,x){return d(this.getSeriesByType(y),w,x)},isSeriesFiltered:function(w){e(this);return q.indexOf(this._seriesIndices,w.componentIndex)<0},filterSeries:function(w,y){e(this);var x=o(this._componentsMap.series,w,y);this._seriesIndices=c(x)},restoreData:function(){var x=this._componentsMap;this._seriesIndices=c(x.series);var w=[];d(x,function(z,y){w.push(y)});h.topologicalTravel(w,h.getAllClassMainTypes(),function(y,z){d(x[y],function(A){A.restoreData()})})}});function m(x,y){for(var w in y){if(!h.hasClass(w)){if(typeof y[w]==="object"){x[w]=!x[w]?q.clone(y[w]):q.merge(x[w],y[w],false)}else{if(x[w]==null){x[w]=y[w]}}}}}function f(w){w=w;this.option={};this.option[g]=1;this._componentsMap={};this._seriesIndices=null;m(w,this._theme.option);q.merge(w,b,false);this.mergeOption(w)}function t(w,y){if(!q.isArray(y)){y=y?[y]:[]}var x={};d(y,function(z){x[z]=(w[z]||[]).slice()});return x}function r(y,x){var w={};d(x,function(B,z){var A=B.exist;A&&(w[A.id]=B)});d(x,function(B,z){var A=B.option;q.assert(!A||A.id==null||!w[A.id]||w[A.id]===B,"id duplicates: "+(A&&A.id));A&&A.id!=null&&(w[A.id]=B);if(k(A)){var C=s(y,A,B.exist);B.keyInfo={mainType:y,subType:C}}});d(x,function(C,z){var B=C.exist;var A=C.option;var E=C.keyInfo;if(!k(A)){return}E.name=A.name!=null?A.name+"":B?B.name:"\0-";if(B){E.id=B.id}else{if(A.id!=null){E.id=A.id+""}else{var D=0;do{E.id="\0"+E.name+"\0"+D++}while(w[E.id])}}w[E.id]=C})}function s(z,x,w){var y=x.type?x.type:w?w.subType:h.determineSubType(z,x);return y}function c(w){return v(w,function(x){return x.componentIndex})||[]}function u(w,x){return x.hasOwnProperty("subType")?o(w,function(y){return y.subType===x.subType}):w}function e(w){if(!w._seriesIndices){throw new Error("Series has not been initialized yet.")}}return j});