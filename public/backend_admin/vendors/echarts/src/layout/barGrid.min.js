define(function(d){var b=d("zrender/core/util");var c=d("../util/number");var e=c.parsePercent;function a(h){return h.get("stack")||"__ec_stack_"+h.seriesIndex}function f(i,k){var j={};b.each(i,function(p,t){var r=p.coordinateSystem;var n=r.getBaseAxis();var u=j[n.index]||{remainedWidth:n.getBandWidth(),autoWidthCount:0,categoryGap:"20%",gap:"30%",axis:n,stacks:{}};var m=u.stacks;j[n.index]=u;var q=a(p);if(!m[q]){u.autoWidthCount++}m[q]=m[q]||{width:0,maxWidth:0};var v=p.get("barWidth");var l=p.get("barMaxWidth");var s=p.get("barGap");var o=p.get("barCategoryGap");if(v&&!m[q].width){v=Math.min(u.remainedWidth,v);m[q].width=v;u.remainedWidth-=v}l&&(m[q].maxWidth=l);(s!=null)&&(u.gap=s);(o!=null)&&(u.categoryGap=o)});var h={};b.each(j,function(x,o){h[o]={};var l=x.stacks;var n=x.axis;var q=n.getBandWidth();var m=e(x.categoryGap,q);var v=e(x.gap,1);var p=x.remainedWidth;var u=x.autoWidthCount;var t=(p-m)/(u+(u-1)*v);t=Math.max(t,0);b.each(l,function(z,y){var A=z.maxWidth;if(!z.width&&A&&A<t){A=Math.min(A,p);p-=A;z.width=A;u--}});t=(p-m)/(u+(u-1)*v);t=Math.max(t,0);var s=0;var w;b.each(l,function(z,y){if(!z.width){z.width=t}w=z;s+=z.width*(1+v)});if(w){s-=w.width*v}var r=-s/2;b.each(l,function(z,y){h[o][y]=h[o][y]||{offset:r,width:z.width};r+=z.width*(1+v)})});return h}function g(i,h,j){var k=f(b.filter(h.getSeriesByType(i),function(m){return !h.isSeriesFiltered(m)&&m.coordinateSystem&&m.coordinateSystem.type==="cartesian2d"}));var l={};h.eachSeriesByType(i,function(q){var s=q.getData();var u=q.coordinateSystem;var p=u.getBaseAxis();var r=a(q);var w=k[p.index][r];var o=w.offset;var n=w.width;var x=u.getOtherAxis(p);var t=q.get("barMinHeight")||0;var m=p.onZero?x.toGlobalCoord(x.dataToCoord(0)):x.getGlobalExtent()[0];var v=u.dataToPoints(s,true);l[r]=l[r]||[];s.setLayout({offset:o,size:n});s.each(x.dim,function(F,G){if(isNaN(F)){return}if(!l[r][G]){l[r][G]={p:m,n:m}}var A=F>=0?"p":"n";var C=v[G];var B=l[r][G][A];var E,D,z,H;if(x.isHorizontal()){E=B;D=C[1]+o;z=C[0]-B;H=n;if(Math.abs(z)<t){z=(z<0?-1:1)*t}l[r][G][A]+=z}else{E=C[0]+o;D=B;z=n;H=C[1]-B;if(Math.abs(H)<t){H=(H<=0?-1:1)*t}l[r][G][A]+=H}s.setItemLayout(G,{x:E,y:D,width:z,height:H})},true)},this)}return g});