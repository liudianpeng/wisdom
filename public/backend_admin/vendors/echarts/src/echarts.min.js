/*
 * ECharts, a javascript interactive chart library.
 *
 * Copyright (c) 2015, Baidu Inc.
 * All rights reserved.
 *
 * LICENSE
 * https://github.com/ecomfe/echarts/blob/master/LICENSE.txt
 */
define(function(e){var l=e("./model/Global");var h=e("./ExtensionAPI");var z=e("./CoordinateSystem");var V=e("./model/OptionManager");var f=e("./model/Component");var t=e("./model/Series");var G=e("./view/Component");var R=e("./view/Chart");var j=e("./util/graphic");var P=e("zrender");var J=e("zrender/core/util");var x=e("zrender/tool/color");var g=e("zrender/core/env");var o=e("zrender/mixin/Eventful");var L=J.each;var w=["echarts","chart","component"];var A=["transform","filter","statistic"];function K(W){return function(X,Z,Y){X=X&&X.toLowerCase();o.prototype[W].call(this,X,Z,Y)}}function E(){o.call(this)}E.prototype.on=K("on");E.prototype.off=K("off");E.prototype.one=K("one");J.mixin(E,o);function N(Y,X,W){W=W||{};if(typeof X==="string"){X=I[X]}if(X){L(q,function(Z){Z(X)})}this.id;this.group;this._dom=Y;this._zr=P.init(Y,{renderer:W.renderer||"canvas",devicePixelRatio:W.devicePixelRatio});this._theme=J.clone(X);this._chartsViews=[];this._chartsMap={};this._componentsViews=[];this._componentsMap={};this._api=new h(this);this._coordSysMgr=new z();o.call(this);this._messageCenter=new E();this._initEvents();this.resize=J.bind(this.resize,this)}var i=N.prototype;i.getDom=function(){return this._dom};i.getZr=function(){return this._zr};i.setOption=function(X,Y,W){if(!this._model||Y){this._model=new l(null,null,this._theme,new V(this._api))}this._model.setOption(X,q);b.prepareAndUpdate.call(this);!W&&this._zr.refreshImmediately()};i.setTheme=function(){console.log("ECharts#setTheme() is DEPRECATED in ECharts 3.0")};i.getModel=function(){return this._model};i.getOption=function(){return this._model.getOption()};i.getWidth=function(){return this._zr.getWidth()};i.getHeight=function(){return this._zr.getHeight()};i.getRenderedCanvas=function(W){if(!g.canvasSupported){return}W=W||{};W.pixelRatio=W.pixelRatio||1;W.backgroundColor=W.backgroundColor||this._model.get("backgroundColor");var Y=this._zr;var X=Y.storage.getDisplayList();J.each(X,function(Z){Z.stopAnimation(true)});return Y.painter.getRenderedCanvas(W)};i.getDataURL=function(aa){aa=aa||{};var ab=aa.excludeComponents;var W=this._model;var Z=[];var X=this;L(ab,function(ac){W.eachComponent({mainType:ac},function(ae){var ad=X._componentsMap[ae.__viewId];if(!ad.group.ignore){Z.push(ad);ad.group.ignore=true}})});var Y=this.getRenderedCanvas(aa).toDataURL("image/"+(aa&&aa.type||"png"));L(Z,function(ac){ac.group.ignore=false});return Y};i.getConnectedDataURL=function(ah){if(!g.canvasSupported){return}var af=this.group;var ac=Math.min;var ae=Math.max;var Y=Infinity;if(M[af]){var aa=Y;var ai=Y;var ao=-Y;var ad=-Y;var ab=[];var W=(ah&&ah.pixelRatio)||1;for(var al in y){var aj=y[al];if(aj.group===af){var Z=aj.getRenderedCanvas(J.clone(ah));var ag=aj.getDom().getBoundingClientRect();aa=ac(ag.left,aa);ai=ac(ag.top,ai);ao=ae(ag.right,ao);ad=ae(ag.bottom,ad);ab.push({dom:Z,left:ag.left,top:ag.top})}}aa*=W;ai*=W;ao*=W;ad*=W;var am=ao-aa;var ak=ad-ai;var an=J.createCanvas();an.width=am;an.height=ak;var X=P.init(an);L(ab,function(aq){var ap=new j.Image({style:{x:aq.left*W-aa,y:aq.top*W-ai,image:aq.dom}});X.add(ap)});X.refreshImmediately();return an.toDataURL("image/"+(ah&&ah.type||"png"))}else{return this.getDataURL(ah)}};var b={update:function(ac){var W=this._model;var Z=this._api;var ab=this._coordSysMgr;if(!W){return}W.restoreData();ab.create(this._model,this._api);C.call(this,W,Z);Q.call(this,W);ab.update(W,Z);n.call(this,W,ac);D.call(this,W,ac);m.call(this,W,ac);var Y=W.get("backgroundColor")||"transparent";var X=this._zr.painter;if(X.isSingleCanvas&&X.isSingleCanvas()){this._zr.configLayer(0,{clearColor:Y})}else{if(!g.canvasSupported){var aa=x.parse(Y);Y=x.stringify(aa,"rgb");if(aa[3]===0){Y="transparent"}}Y=Y;this._dom.style.backgroundColor=Y}},updateView:function(X){var W=this._model;if(!W){return}n.call(this,W,X);D.call(this,W,X);s.call(this,"updateView",W,X)},updateVisual:function(X){var W=this._model;if(!W){return}D.call(this,W,X);s.call(this,"updateVisual",W,X)},updateLayout:function(X){var W=this._model;if(!W){return}n.call(this,W,X);s.call(this,"updateLayout",W,X)},highlight:function(W){a.call(this,"highlight",W)},downplay:function(W){a.call(this,"downplay",W)},prepareAndUpdate:function(X){var W=this._model;H.call(this,"component",W);H.call(this,"chart",W);b.update.call(this,X)}};function a(Y,X){var W=this._model;if(!W){return}W.eachComponent({mainType:"series",query:X},function(aa,ab){var Z=this._chartsMap[aa.__viewId];if(Z&&Z.__alive){Z[Y](aa,W,this._api,X)}},this)}i.resize=function(){this._zr.resize();var W=this._model&&this._model.resetOption("media");b[W?"prepareAndUpdate":"update"].call(this);this._loadingFX&&this._loadingFX.resize()};var B=e("./loading/default");i.showLoading=function(X,W){if(J.isObject(X)){W=X;X="default"}this.hideLoading();var Y=B(this._api,W);var Z=this._zr;this._loadingFX=Y;Z.add(Y)};i.hideLoading=function(){this._loadingFX&&this._zr.remove(this._loadingFX);this._loadingFX=null};i.makeActionFromEvent=function(W){var X=J.extend({},W);X.type=O[W.type];return X};i.dispatchAction=function(ag,ad){var ae=F[ag.type];if(ae){var af=ae.actionInfo;var Y=af.update||"update";var aa=[ag];var W=false;if(ag.batch){W=true;aa=J.map(ag.batch,function(ai){ai=J.defaults(J.extend({},ai),ag);ai.batch=null;return ai})}var ah=[];var ac;var ab=ag.type==="highlight"||ag.type==="downplay";for(var X=0;X<aa.length;X++){var Z=aa[X];ac=ae.action(Z,this._model);ac=ac||J.extend({},Z);ac.type=af.event||ac.type;ah.push(ac);ab&&b[Y].call(this,Z)}(Y!=="none"&&!ab)&&b[Y].call(this,ag);if(!ad){if(W){ac={type:af.event||ag.type,batch:ah}}else{ac=ah[0]}this._messageCenter.trigger(ac.type,ac)}}};i.on=K("on");i.off=K("off");i.one=K("one");function s(X,W,Z){var Y=this._api;L(this._componentsViews,function(ab){var aa=ab.__model;ab[X](aa,W,Y,Z);k(aa,ab)},this);W.eachSeries(function(ab,aa){var ac=this._chartsMap[ab.__viewId];ac[X](ab,W,Y,Z);k(ab,ac)},this)}function H(ac,X){var ab=ac==="component";var Z=ab?this._componentsViews:this._chartsViews;var W=ab?this._componentsMap:this._chartsMap;var ad=this._zr;for(var aa=0;aa<Z.length;aa++){Z[aa].__alive=false}X[ab?"eachComponent":"eachSeries"](function(ah,ag){if(ab){if(ah==="series"){return}}else{ag=ah}var ae=ag.id+"_"+ag.type;var af=W[ae];if(!af){var ai=f.parseClassType(ag.type);var aj=ab?G.getClass(ai.main,ai.sub):R.getClass(ai.sub);if(aj){af=new aj();af.init(X,this._api);W[ae]=af;Z.push(af);ad.add(af.group)}else{return}}ag.__viewId=ae;af.__alive=true;af.__id=ae;af.__model=ag},this);for(var aa=0;aa<Z.length;){var Y=Z[aa];if(!Y.__alive){ad.remove(Y.group);Y.dispose(X,this._api);Z.splice(aa,1);delete W[Y.__id]}else{aa++}}}function C(W,X){L(A,function(Y){L(c[Y]||[],function(Z){Z(W,X)})})}function Q(W){var X={};W.eachSeries(function(Z){var Y=Z.get("stack");var ab=Z.getData();if(Y&&ab.type==="list"){var aa=X[Y];if(aa){ab.stackedOn=aa}X[Y]=ab}})}function n(W,Y){var X=this._api;L(r,function(Z){Z(W,X,Y)})}function D(W,X){L(w,function(Y){L(T[Y]||[],function(Z){Z(W,X)})})}function m(W,Y){var X=this._api;L(this._componentsViews,function(aa){var Z=aa.__model;aa.render(Z,W,X,Y);k(Z,aa)},this);L(this._chartsViews,function(Z){Z.__alive=false},this);W.eachSeries(function(ab,Z){var aa=this._chartsMap[ab.__viewId];aa.__alive=true;aa.render(ab,W,X,Y);aa.group.silent=!!ab.get("silent");k(ab,aa)},this);L(this._chartsViews,function(Z){if(!Z.__alive){Z.remove(W,X)}},this)}var u=["click","dblclick","mouseover","mouseout","mousedown","mouseup","globalout"];i._initEvents=function(){L(u,function(W){this._zr.on(W,function(aa){var X=this.getModel();var Z=aa.target;if(Z&&Z.dataIndex!=null){var Y=Z.dataModel||X.getSeriesByIndex(Z.seriesIndex);var ab=Y&&Y.getDataParams(Z.dataIndex,Z.dataType)||{};ab.event=aa;ab.type=W;this.trigger(W,ab)}else{if(Z&&Z.eventData){this.trigger(W,Z.eventData)}}},this)},this);L(O,function(W,X){this._messageCenter.on(X,function(Y){this.trigger(X,Y)},this)},this)};i.isDisposed=function(){return this._disposed};i.clear=function(){this.setOption({},true)};i.dispose=function(){this._disposed=true;var X=this._api;var W=this._model;L(this._componentsViews,function(Y){Y.dispose(W,X)});L(this._chartsViews,function(Y){Y.dispose(W,X)});this._zr.dispose();delete y[this.id]};J.mixin(N,o);function k(Y,X){var Z=Y.get("z");var W=Y.get("zlevel");X.group.traverse(function(aa){Z!=null&&(aa.z=Z);W!=null&&(aa.zlevel=W)})}var F=[];var O={};var r=[];var c={};var q=[];var T={};var I={};var y={};var M={};var d=new Date()-0;var U=new Date()-0;var p="_echarts_instance_";var v={version:"3.1.10",dependencies:{zrender:"3.1.0"}};function S(Z){var W=0;var aa=1;var Y=2;var X="__connectUpdateStatus";function ab(af,ac){for(var ae=0;ae<af.length;ae++){var ad=af[ae];ad[X]=ac}}J.each(O,function(ac,ad){Z._messageCenter.on(ad,function(af){if(M[Z.group]&&Z[X]!==W){var ag=Z.makeActionFromEvent(af);var ah=[];for(var ai in y){var ae=y[ai];if(ae!==Z&&ae.group===Z.group){ah.push(ae)}}ab(ah,W);L(ah,function(aj){if(aj[X]!==aa){aj.dispatchAction(ag)}});ab(ah,Y)}})})}v.init=function(Z,Y,X){if((P.version.replace(".","")-0)<(v.dependencies.zrender.replace(".","")-0)){throw new Error("ZRender "+P.version+" is too old for ECharts "+v.version+". Current version need ZRender "+v.dependencies.zrender+"+")}if(!Z){throw new Error("Initialize failed: invalid dom.")}var W=new N(Z,Y,X);W.id="ec_"+d++;y[W.id]=W;Z.setAttribute&&Z.setAttribute(p,W.id);S(W);return W};v.connect=function(W){if(J.isArray(W)){var X=W;W=null;J.each(X,function(Y){if(Y.group!=null){W=Y.group}});W=W||("g_"+U++);J.each(X,function(Y){Y.group=W})}M[W]=true;return W};v.disConnect=function(W){M[W]=false};v.dispose=function(W){if(J.isDom(W)){W=v.getInstanceByDom(W)}else{if(typeof W==="string"){W=y[W]}}if((W instanceof N)&&!W.isDisposed()){W.dispose()}};v.getInstanceByDom=function(X){var W=X.getAttribute(p);return y[W]};v.getInstanceById=function(W){return y[W]};v.registerTheme=function(W,X){I[W]=X};v.registerPreprocessor=function(W){q.push(W)};v.registerProcessor=function(X,Y){if(J.indexOf(A,X)<0){throw new Error("stage should be one of "+A)}var W=c[X]||(c[X]=[]);W.push(Y)};v.registerAction=function(Y,W,Z){if(typeof W==="function"){Z=W;W=""}var X=J.isObject(Y)?Y.type:([Y,Y={event:W}][0]);Y.event=(Y.event||X).toLowerCase();W=Y.event;if(!F[X]){F[X]={action:Z,actionInfo:Y}}O[W]=X};v.registerCoordinateSystem=function(X,W){z.register(X,W)};v.registerLayout=function(W){if(J.indexOf(r,W)<0){r.push(W)}};v.registerVisualCoding=function(X,Y){if(J.indexOf(w,X)<0){throw new Error("stage should be one of "+w)}var W=T[X]||(T[X]=[]);W.push(Y)};v.extendChartView=function(W){return R.extend(W)};v.extendComponentModel=function(W){return f.extend(W)};v.extendSeriesModel=function(W){return t.extend(W)};v.extendComponentView=function(W){return G.extend(W)};v.setCanvasCreator=function(W){J.createCanvas=W};v.registerVisualCoding("echarts",J.curry(e("./visual/seriesColor"),"","itemStyle"));v.registerPreprocessor(e("./preprocessor/backwardCompat"));v.registerAction({type:"highlight",event:"highlight",update:"highlight"},J.noop);v.registerAction({type:"downplay",event:"downplay",update:"downplay"},J.noop);v.graphic=e("./util/graphic");v.number=e("./util/number");v.format=e("./util/format");v.matrix=e("zrender/core/matrix");v.vector=e("zrender/core/vector");v.util={};L(["map","each","filter","indexOf","inherits","reduce","filter","bind","curry","isArray","isString","isObject","isFunction","extend"],function(W){v.util[W]=J[W]});return v});