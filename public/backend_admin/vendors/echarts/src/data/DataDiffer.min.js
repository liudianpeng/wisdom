define(function(b){function c(e){return e}function a(f,h,e,g){this._old=f;this._new=h;this._oldKeyGetter=e||c;this._newKeyGetter=g||c}a.prototype={constructor:a,add:function(e){this._add=e;return this},update:function(e){this._update=e;return this},remove:function(e){this._remove=e;return this},execute:function(){var e=this._old;var g=this._new;var m=this._oldKeyGetter;var l=this._newKeyGetter;var j={};var f={};var h;d(e,j,m);d(g,f,l);for(h=0;h<e.length;h++){var o=m(e[h]);var n=f[o];if(n!=null){var k=n.length;if(k){k===1&&(f[o]=null);n=n.unshift()}else{f[o]=null}this._update&&this._update(n,h)}else{this._remove&&this._remove(h)}}for(var o in f){if(f.hasOwnProperty(o)){var n=f[o];if(n==null){continue}if(!n.length){this._add&&this._add(n)}else{for(var h=0,k=n.length;h<k;h++){this._add&&this._add(n[h])}}}}}};function d(e,j,h){for(var g=0;g<e.length;g++){var f=h(e[g]);var k=j[f];if(k==null){j[f]=g}else{if(!k.length){j[f]=k=[k]}k.push(g)}}}return a});