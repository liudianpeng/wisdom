define(function(i){var o=i("zrender/core/util");var b=i("zrender/tool/color");var c=i("../util/number").linearMap;var d=o.each;var l=o.isObject;var e=-1;var r=function(v){var t=v.mappingMethod;var w=v.type;var u=this.option=o.clone(v);this.type=w;this.mappingMethod=t;this._normalizeData=m[t];this._getSpecifiedVisual=o.bind(k[t],this,w);o.extend(this,p[w]);if(t==="piecewise"){g(u);j(u)}else{if(t==="category"){u.categories?q(u):g(u,true)}else{o.assert(u.dataExtent);g(u)}}};r.prototype={constructor:r,applyVisual:null,isValueActive:null,mapValueToVisual:null,getNormalizer:function(){return o.bind(this._normalizeData,this)}};var p=r.visualHandlers={color:{applyVisual:h,getColorMapper:function(){var t=a(this)?this.option.visual:o.map(this.option.visual,b.parse);return o.bind(a(this)?function(v,u){!u&&(v=this._normalizeData(v));return n(this,t,v)}:function(x,w,u){var v=!!u;!w&&(x=this._normalizeData(x));u=b.fastMapToColor(x,t,u);return v?u:o.stringify(u,"rgba")},this)},mapValueToVisual:function(v){var u=this.option.visual;var w=this._normalizeData(v);var t=this._getSpecifiedVisual(v);if(t==null){t=a(this)?n(this,u,w):b.mapToColor(w,u)}return t}},colorHue:f(function(t,u){return b.modifyHSL(t,u)}),colorSaturation:f(function(t,u){return b.modifyHSL(t,null,u)}),colorLightness:f(function(t,u){return b.modifyHSL(t,null,null,u)}),colorAlpha:f(function(t,u){return b.modifyAlpha(t,u)}),opacity:{applyVisual:function(u,t,v){v("opacity",this.mapValueToVisual(u))},mapValueToVisual:function(v){var w=this._normalizeData(v);var t=this._getSpecifiedVisual(v);var u=this.option.visual;if(t==null){t=a(this)?n(this,u,w):c(w,[0,1],u,true)}return t}},symbol:{applyVisual:function(v,t,x){var w=this.mapValueToVisual(v);if(o.isString(w)){x("symbol",w)}else{if(l(w)){for(var u in w){if(w.hasOwnProperty(u)){x(u,w[u])}}}}},mapValueToVisual:function(v){var w=this._normalizeData(v);var t=this._getSpecifiedVisual(v);var u=this.option.visual;if(t==null){t=a(this)?n(this,u,w):(s(u,w)||{})}return t}},symbolSize:{applyVisual:function(u,t,v){v("symbolSize",this.mapValueToVisual(u))},mapValueToVisual:function(v){var w=this._normalizeData(v);var t=this._getSpecifiedVisual(v);var u=this.option.visual;if(t==null){t=a(this)?n(this,u,w):c(w,[0,1],u,true)}return t}}};function j(u){var t=u.pieceList;u.hasSpecialVisual=false;o.each(t,function(w,v){w.originIndex=v;if(w.visual!=null){u.hasSpecialVisual=true}})}function q(w){var t=w.categories;var y=w.visual;var x=w.categoryMap={};d(t,function(A,z){x[A]=z});if(!o.isArray(y)){var v=[];if(o.isObject(y)){d(y,function(z,B){var A=x[B];v[A!=null?A:e]=z})}else{v[e]=y}y=w.visual=v}for(var u=t.length-1;u>=0;u--){if(y[u]==null){delete x[t[u]];t.pop()}}}function g(v,t){var w=v.visual;var u=[];if(o.isObject(w)){d(w,function(y){u.push(y)})}else{if(w!=null){u.push(w)}}var x={color:1,symbol:1};if(!t&&u.length===1&&!(v.type in x)){u[1]=u[0]}v.visual=u}function f(t){return{applyVisual:function(v,u,w){v=this.mapValueToVisual(v);w("color",t(u("color"),v))},mapValueToVisual:function(w){var x=this._normalizeData(w);var u=this._getSpecifiedVisual(w);var v=this.option.visual;if(u==null){u=a(this)?n(this,v,x):c(x,[0,1],v,true)}return u}}}function s(t,u){return t[Math.round(c(u,[0,1],[0,t.length-1],true))]}function h(u,t,v){v("color",this.mapValueToVisual(u))}function n(u,t,v){return t[(u.option.loop&&v!==e)?v%t.length:v]}function a(t){return t.option.mappingMethod==="category"}var m={linear:function(t){return c(t,this.option.dataExtent,[0,1],true)},piecewise:function(v){var t=this.option.pieceList;var u=r.findPieceIndex(v,t);if(u!=null){return c(u,[0,t.length-1],[0,1],true)}},category:function(u){var t=this.option.categories?this.option.categoryMap[u]:u;return t==null?e:t}};var k={linear:o.noop,piecewise:function(y,x){var u=this.option;var t=u.pieceList;if(u.hasSpecialVisual){var w=r.findPieceIndex(x,t);var v=t[w];if(v&&v.visual){return v.visual[y]}}},category:o.noop};r.addVisualHandler=function(t,u){p[t]=u};r.isValidType=function(t){return p.hasOwnProperty(t)};r.eachVisual=function(u,v,t){if(o.isObject(u)){o.each(u,v,t)}else{v.call(t,u)}};r.mapVisual=function(u,x,t){var w;var v=o.isArray(u)?[]:o.isObject(u)?{}:(w=true,null);r.eachVisual(u,function(y,A){var z=x.call(t,y,A);w?(v=z):(v[A]=z)});return v};r.retrieveVisuals=function(v){var u={};var t;v&&d(p,function(w,x){if(v.hasOwnProperty(x)){u[x]=v[x];t=true}});return t?u:null};r.prepareVisualTypes=function(u){if(l(u)){var t=[];d(u,function(w,v){t.push(v)});u=t}else{if(o.isArray(u)){u=u.slice()}else{return[]}}u.sort(function(w,v){return(v==="color"&&w!=="color"&&w.indexOf("color")===0)?1:-1});return u};r.dependsOn=function(u,t){return t==="color"?!!(u&&u.indexOf(t)===0):u===t};r.findPieceIndex=function(y,u){for(var w=0,t=u.length;w<t;w++){var x=u[w];if(x.value!=null&&x.value===y){return w}}for(var w=0,t=u.length;w<t;w++){var x=u[w];var v=x.interval;if(v){if(v[0]===-Infinity){if(y<v[1]){return w}}else{if(v[1]===Infinity){if(v[0]<y){return w}}else{if(x.interval[0]<=y&&y<=x.interval[1]){return w}}}}}};return r});