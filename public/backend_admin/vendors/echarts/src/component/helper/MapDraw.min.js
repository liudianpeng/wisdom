define(function(d){var e=d("./RoamController");var h=d("../../util/graphic");var c=d("zrender/core/util");function b(j,l){var k=j.getItemStyle();var i=j.get("areaColor");if(i){k.fill=i}return k}function g(i,l,k,j){l.off("click");i.get("selectedMode")&&l.on("click",function(p){var m=p.target;while(!m.__region){m=m.parent}if(!m){return}var o=m.__region;var n={type:(i.mainType==="geo"?"geo":"map")+"ToggleSelect",name:o.name,from:j.uid};n[i.mainType+"Id"]=i.id;k.dispatchAction(n);f(i,l)})}function f(i,j){j.eachChild(function(k){if(k.__region){k.trigger(i.isSelected(k.__region.name)?"emphasis":"normal")}})}function a(j,i){var k=new h.Group();this._controller=new e(j.getZr(),i?k:null,null);this.group=k;this._updateGroup=i}a.prototype={constructor:a,draw:function(r,n,o,j,q){var m=r.getData&&r.getData();var l=r.coordinateSystem;var s=this.group;var k=l.scale;var p={position:l.position,scale:k};if(!s.childAt(0)||q){s.attr(p)}else{h.updateProps(s,p,r)}s.removeAll();var t=["itemStyle","normal"];var v=["itemStyle","emphasis"];var i=["label","normal"];var u=["label","emphasis"];c.each(l.regions,function(B){var y=new h.Group();var L=new h.CompoundPath({shape:{paths:[]}});y.add(L);var Q=r.getRegionModel(B.name)||r;var x=Q.getModel(t);var w=Q.getModel(v);var G=b(x,k);var z=b(w,k);var J=Q.getModel(i);var M=Q.getModel(u);var N;if(m){N=m.indexOfName(B.name);var C=m.getItemVisual(N,"color",true);if(C){G.fill=C}}var H=J.getModel("textStyle");var F=M.getModel("textStyle");c.each(B.contours,function(T){var S=new h.Polygon({shape:{points:T}});L.shape.paths.push(S)});L.setStyle(G);L.style.strokeNoScale=true;L.culling=true;var P=J.get("show");var A=M.get("show");var I=m&&isNaN(m.get("value",N));var R=m&&m.getItemLayout(N);if((!m||I&&(P||A))||(R&&R.showLabel)){var D=m?N:B.name;var E=r.getFormattedLabel(D,"normal");var O=r.getFormattedLabel(D,"emphasis");var K=new h.Text({style:{text:P?(E||B.name):"",fill:H.getTextColor(),textFont:H.getFont(),textAlign:"center",textVerticalAlign:"middle"},hoverStyle:{text:A?(O||B.name):"",fill:F.getTextColor(),textFont:F.getFont()},position:B.center.slice(),scale:[1/k[0],1/k[1]],z2:10,silent:true});y.add(K)}if(m){m.setItemGraphicEl(N,y)}else{var Q=r.getRegionModel(B.name);L.eventData={componentType:"geo",geoIndex:r.componentIndex,name:B.name,region:(Q&&Q.option)||{}}}y.__region=B;h.setHoverStyle(y,z);s.add(y)});this._updateController(r,n,o);g(r,s,o,j);f(r,s)},remove:function(){this.group.removeAll();this._controller.dispose()},_updateController:function(j,i,m){var n=j.coordinateSystem;var k=this._controller;k.zoomLimit=j.get("scaleLimit");k.zoom=n.getZoom();k.enable(j.get("roam")||false);var o=j.mainType;function l(){var p={type:"geoRoam",componentType:o};p[o+"Id"]=j.id;return p}k.off("pan").on("pan",function(q,p){m.dispatchAction(c.extend(l(),{dx:q,dy:p}))});k.off("zoom").on("zoom",function(r,q,p){m.dispatchAction(c.extend(l(),{zoom:r,originX:q,originY:p}));if(this._updateGroup){var s=this.group;var t=s.scale;s.traverse(function(u){if(u.type==="text"){u.attr("scale",[1/t[0],1/t[1]])}})}},this);k.rectProvider=function(){return n.getViewRectAfterRoam()}}};return a});