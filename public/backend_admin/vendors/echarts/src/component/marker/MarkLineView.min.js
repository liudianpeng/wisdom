define(function(e){var g=e("zrender/core/util");var o=e("../../data/List");var b=e("../../util/format");var q=e("../../util/model");var d=e("../../util/number");var l=b.addCommas;var n=b.encodeHTML;var a=e("./markerHelper");var i=e("../../chart/helper/LineDraw");var h=function(t,v,y,E){var w=t.getData();var r=E.type;if(!g.isArray(E)&&(r==="min"||r==="max"||r==="average"||(E.xAxis!=null||E.yAxis!=null))){var D;var z;var C;if(E.yAxis!=null||E.xAxis!=null){z=E.yAxis!=null?"y":"x";D=v.getAxis(z);C=g.retrieve(E.yAxis,E.xAxis)}else{var u=a.getAxisInfo(E,w,v,t);z=u.valueDataDim;D=u.valueAxis;C=a.numCalculate(w,z,r)}var A=z==="x"?0:1;var B=1-A;var s=g.clone(E);var F={};s.type=null;s.coord=[];F.coord=[];s.coord[B]=-Infinity;F.coord[B]=Infinity;var x=y.get("precision");if(x>=0){C=+C.toFixed(x)}s.coord[A]=F.coord[A]=C;E=[s,F,{type:r,valueIndex:E.valueIndex,value:C}]}E=[a.dataTransform(t,E[0]),a.dataTransform(t,E[1]),g.extend({},E[2])];E[2].type=E[2].type||"";g.merge(E[2],E[0]);g.merge(E[2],E[1]);return E};function f(r){return !isNaN(r)&&!isFinite(r)}function p(v,r,t,s){var w=1-v;var u=s.dimensions[v];return f(r[w])&&f(t[w])&&r[v]===t[v]&&s.getAxis(u).containData(r[v])}function j(t,u){if(t.type==="cartesian2d"){var r=u[0].coord;var s=u[1].coord;if(r&&s&&(p(1,r,s,t)||p(0,r,s,t))){return true}}return a.dataFilter(t,u[0])&&a.dataFilter(t,u[1])}function m(B,I,A,t,E,w,C){var z=w.coordinateSystem;var J=B.getItemModel(I);var H;var r=J.get("x");var v=J.get("y");if(r!=null&&v!=null){H=[d.parsePercent(r,C.getWidth()),d.parsePercent(v,C.getHeight())]}else{if(w.getMarkerPosition){H=w.getMarkerPosition(B.getValues(B.dimensions,I))}else{var G=z.dimensions;var F=B.get(G[0],I);var D=B.get(G[1],I);H=z.dataToPoint([F,D])}if(z.type==="cartesian2d"){var u=z.getAxis("x");var s=z.getAxis("y");var G=z.dimensions;if(f(B.get(G[0],I))){H[0]=u.toGlobalCoord(u.getExtent()[A?0:1])}else{if(f(B.get(G[1],I))){H[1]=s.toGlobalCoord(s.getExtent()[A?0:1])}}}}B.setItemLayout(I,H)}var k={formatTooltip:function(s){var v=this._data;var u=this.getRawValue(s);var t=g.isArray(u)?g.map(u,l).join(", "):l(u);var r=v.getName(s);return this.name+"<br />"+((r?n(r)+" : ":"")+t)},getData:function(){return this._data},setData:function(r){this._data=r}};g.defaults(k,q.dataFormatMixin);e("../../echarts").extendComponentView({type:"markLine",init:function(){this._markLineMap={}},render:function(s,r,v){var u=this._markLineMap;for(var t in u){u[t].__keep=false}r.eachSeries(function(x){var w=x.markLineModel;w&&this._renderSeriesML(x,w,r,v)},this);for(var t in u){if(!u[t].__keep){this.group.remove(u[t].group)}}},updateLayout:function(s,r,t){r.eachSeries(function(v){var u=v.markLineModel;if(u){var x=u.getData();var y=u.__from;var w=u.__to;y.each(function(z){var C=x.getItemModel(z);var A=C.get("type");var B=C.get("valueIndex");m(y,z,true,A,B,v,t);m(w,z,false,A,B,v,t)});x.each(function(z){x.setItemLayout(z,[y.getItemLayout(z),w.getItemLayout(z)])});this._markLineMap[v.name].updateLayout()}},this)},_renderSeriesML:function(u,w,x,y){var v=u.coordinateSystem;var B=u.name;var r=u.getData();var F=this._markLineMap;var z=F[B];if(!z){z=F[B]=new i()}this.group.add(z.group);var C=c(v,u,w);var E=C.from;var A=C.to;var t=C.line;w.__from=E;w.__to=A;g.extend(w,k);w.setData(t);var G=w.get("symbol");var s=w.get("symbolSize");if(!g.isArray(G)){G=[G,G]}if(typeof s==="number"){s=[s,s]}C.from.each(function(H){var K=t.getItemModel(H);var I=K.get("type");var J=K.get("valueIndex");D(E,H,true,I,J);D(A,H,false,I,J)});t.each(function(H){var I=t.getItemModel(H).get("lineStyle.normal.color");t.setItemVisual(H,{color:I||E.getItemVisual(H,"color")});t.setItemLayout(H,[E.getItemLayout(H),A.getItemLayout(H)]);t.setItemVisual(H,{fromSymbolSize:E.getItemVisual(H,"symbolSize"),fromSymbol:E.getItemVisual(H,"symbol"),toSymbolSize:A.getItemVisual(H,"symbolSize"),toSymbol:A.getItemVisual(H,"symbol")})});z.updateData(t);C.line.eachItemGraphicEl(function(I,H){I.traverse(function(J){J.dataModel=w})});function D(L,I,H,J,M){var K=L.getItemModel(I);m(L,I,H,J,M,u,y);L.setItemVisual(I,{symbolSize:K.get("symbolSize")||s[H?0:1],symbol:K.get("symbol",true)||G[H?0:1],color:K.get("itemStyle.normal.color")||r.getVisual("color")})}z.__keep=true}});function c(u,s,v){var w;if(u){w=g.map(u&&u.dimensions,function(A){var B=s.getData().getDimensionInfo(s.coordDimToDataDim(A)[0])||{};B.name=A;return B})}else{w=[{name:"value",type:"float"}]}var z=new o(w,v);var x=new o(w,v);var r=new o([],v);var t=g.map(v.get("data"),g.curry(h,s,u,v));if(u){t=g.filter(t,g.curry(j,u))}var y=u?a.dimValueGetter:function(A){return A.value};z.initData(g.map(t,function(A){return A[0]}),null,y);x.initData(g.map(t,function(A){return A[1]}),null,y);r.initData(g.map(t,function(A){return A[2]}));return{from:z,to:x,line:r}}});