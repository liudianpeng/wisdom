define(function(e){var g=e("zrender/core/util");var q=e("zrender/core/event");var d=new Array(60).join("-");var o="\t";function f(r){var s={};var u=[];var t=[];r.eachRawSeries(function(v){var x=v.coordinateSystem;if(x&&(x.type==="cartesian2d"||x.type==="polar")){var y=x.getBaseAxis();if(y.type==="category"){var w=y.dim+"_"+y.index;if(!s[w]){s[w]={categoryAxis:y,valueAxis:x.getOtherAxis(y),series:[]};t.push({axisDim:y.dim,axisIndex:y.index})}s[w].series.push(v)}else{u.push(v)}}else{u.push(v)}});return{seriesGroupByCategoryAxis:s,other:u,meta:t}}function a(s){var r=[];g.each(s,function(A,B){var x=A.categoryAxis;var C=A.valueAxis;var y=C.dim;var t=[" "].concat(g.map(A.series,function(E){return E.name}));var u=[x.model.getCategories()];g.each(A.series,function(E){u.push(E.getRawData().mapArray(y,function(F){return F}))});var D=[t.join(o)];for(var w=0;w<u[0].length;w++){var z=[];for(var v=0;v<u.length;v++){z.push(u[v][w])}D.push(z.join(o))}r.push(D.join("\n"))});return r.join("\n\n"+d+"\n\n")}function j(r){return g.map(r,function(t){var v=t.getRawData();var s=[t.name];var u=[];v.each(v.dimensions,function(){var w=arguments.length;var z=arguments[w-1];var x=v.getName(z);for(var y=0;y<w-1;y++){u[y]=arguments[y]}s.push((x?(x+o):"")+u.join(o))});return s.join("\n")}).join("\n\n"+d+"\n\n")}function i(s){var r=f(s);return{value:g.filter([a(r.seriesGroupByCategoryAxis),j(r.other)],function(t){return t.replace(/[\n\t\s]/g,"")}).join("\n\n"+d+"\n\n"),meta:r.meta}}function c(r){return r.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function n(s){var r=s.slice(0,s.indexOf("\n"));if(r.indexOf(o)>=0){return true}}var h=new RegExp("["+o+"]+","g");function b(y){var w=y.split(/\n+/g);var x=c(w.shift()).split(h);var s=[];var v=g.map(x,function(z){return{name:z,data:[]}});for(var u=0;u<w.length;u++){var r=c(w[u]).split(h);s.push(r.shift());for(var t=0;t<r.length;t++){v[t]&&(v[t].data[u]=r[t])}}return{series:v,categories:s}}function m(x){var A=x.split(/\n+/g);var y=c(A.shift());var t=[];for(var u=0;u<A.length;u++){var w=c(A[u]).split(h);var r="";var z;var v=false;if(isNaN(w[0])){v=true;r=w[0];w=w.slice(1);t[u]={name:r,value:[]};z=t[u].value}else{z=t[u]=[]}for(var s=0;s<w.length;s++){z.push(+w[s])}if(z.length===1){v?(t[u].value=z[0]):(t[u]=z[0])}}return{name:y,data:t}}function l(u,t){var s=u.split(new RegExp("\n*"+d+"\n*","g"));var r={series:[]};g.each(s,function(z,w){if(n(z)){var v=b(z);var y=t[w];var x=y.axisDim+"Axis";if(y){r[x]=r[x]||[];r[x][y.axisIndex]={data:v.categories};r.series=r.series.concat(v.series)}}else{var v=m(z);r.series.push(v)}});return r}function k(r){this._dom=null;this.model=r}k.defaultOption={show:true,readOnly:false,optionToContent:null,contentToOption:null,icon:"M17.5,17.3H33 M17.5,17.3H33 M45.4,29.5h-28 M11.5,2v56H51V14.8L38.4,2H11.5z M38.4,2.2v12.7H51 M45.4,41.7h-28",title:"数据视图",lang:["数据视图","关闭","刷新"],backgroundColor:"#fff",textColor:"#000",textareaColor:"#fff",textareaBorderColor:"#333",buttonColor:"#c23531",buttonTextColor:"#fff"};k.prototype.onclick=function(J,x){var w=x.getDom();var t=this.model;if(this._dom){w.removeChild(this._dom)}var B=document.createElement("div");B.style.cssText="position:absolute;left:5px;top:5px;bottom:5px;right:5px;";B.style.backgroundColor=t.get("backgroundColor")||"#fff";var D=document.createElement("h4");var K=t.get("lang")||[];D.innerHTML=K[0]||t.get("title");D.style.cssText="margin: 10px 20px;";D.style.color=t.get("textColor");var I=document.createElement("div");var z=document.createElement("textarea");I.style.cssText="display:block;width:100%;overflow:hidden;";var C=t.get("optionToContent");var u=t.get("contentToOption");var v=i(J);if(typeof C==="function"){var H=C(x.getOption());if(typeof H==="string"){I.innerHTML=H}else{if(g.isDom(H)){I.appendChild(H)}}}else{I.appendChild(z);z.readOnly=t.get("readOnly");z.style.cssText="width:100%;height:100%;font-family:monospace;font-size:14px;line-height:1.6rem;";z.style.color=t.get("textColor");z.style.borderColor=t.get("textareaBorderColor");z.style.backgroundColor=t.get("textareaColor");z.value=v.value}var F=v.meta;var E=document.createElement("div");E.style.cssText="position:absolute;bottom:0;left:0;right:0;";var G="float:right;margin-right:20px;border:none;cursor:pointer;padding:2px 5px;font-size:12px;border-radius:3px";var r=document.createElement("div");var s=document.createElement("div");G+=";background-color:"+t.get("buttonColor");G+=";color:"+t.get("buttonTextColor");var A=this;function y(){w.removeChild(B);A._dom=null}q.addEventListener(r,"click",y);q.addEventListener(s,"click",function(){var L;try{if(typeof u==="function"){L=u(I,x.getOption())}else{L=l(z.value,F)}}catch(M){y();throw new Error("Data view format error "+M)}if(L){x.dispatchAction({type:"changeDataView",newOption:L})}y()});r.innerHTML=K[1];s.innerHTML=K[2];s.style.cssText=G;r.style.cssText=G;!t.get("readOnly")&&E.appendChild(s);E.appendChild(r);q.addEventListener(z,"keydown",function(M){if((M.keyCode||M.which)===9){var N=this.value;var O=this.selectionStart;var L=this.selectionEnd;this.value=N.substring(0,O)+o+N.substring(L);this.selectionStart=this.selectionEnd=O+1;q.stop(M)}});B.appendChild(D);B.appendChild(I);B.appendChild(E);I.style.height=(w.clientHeight-80)+"px";w.appendChild(B);this._dom=B};k.prototype.remove=function(r,s){this._dom&&s.getDom().removeChild(this._dom)};k.prototype.dispose=function(r,s){this.remove(r,s)};function p(r,s){return g.map(r,function(u,t){var v=s&&s[t];if(g.isObject(v)&&!g.isArray(v)){if(g.isObject(u)&&!g.isArray(u)){u=u.value}return g.defaults({value:u},v)}else{return u}})}e("../featureManager").register("dataView",k);e("../../../echarts").registerAction({type:"changeDataView",event:"dataViewChanged",update:"prepareAndUpdate"},function(t,r){var s=[];g.each(t.newOption.series,function(u){var v=r.getSeriesByName(u.name)[0];if(!v){s.push(g.extend({type:"scatter"},u))}else{var w=v.get("data");s.push({name:u.name,data:p(u.data,w)})}});r.mergeOption(g.defaults({series:s},t.newOption))});return k});