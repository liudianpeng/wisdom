define(function(j){var m=j("./VisualMapView");var n=j("../../util/graphic");var p=j("zrender/core/util");var h=j("../../util/number");var o=j("../helper/sliderMove");var e=j("zrender/graphic/LinearGradient");var b=j("./helper");var c=h.linearMap;var q=b.convertDataIndicesToBatch;var d=p.each;var i=Math.min;var l=Math.max;var s=6;var f=6;var k=m.extend({type:"visualMap.continuous",init:function(){m.prototype.init.apply(this,arguments);this._shapes={};this._dataInterval=[];this._handleEnds=[];this._orient;this._useHandle;this._hoverLinkDataIndices=[]},doRender:function(u,t,v,w){if(!w||w.type!=="selectDataRange"||w.from!==this.uid){this._buildView()}else{this._updateView()}},_buildView:function(){this.group.removeAll();var v=this.visualMapModel;var u=this.group;this._orient=v.get("orient");this._useHandle=v.get("calculable");this._resetInterval();this._renderBar(u);var t=v.get("text");this._renderEndsText(u,t,0);this._renderEndsText(u,t,1);this._updateView(true);this.renderBackground(u);this._updateView();this._enableHoverLinkToSeries();this._enableHoverLinkFromSeries();this.positionGroup(u)},_renderEndsText:function(B,u,E){if(!u){return}var C=u[1-E];C=C!=null?C+"":"";var A=this.visualMapModel;var t=A.get("textGap");var D=A.itemSize;var z=this._shapes.barGroup;var w=this._applyTransform([D[0]/2,E===0?-t:D[1]+t],z);var x=this._applyTransform(E===0?"bottom":"top",z);var v=this._orient;var y=this.visualMapModel.textStyleModel;this.group.add(new n.Text({style:{x:w[0],y:w[1],textVerticalAlign:v==="horizontal"?"middle":x,textAlign:v==="horizontal"?x:"center",text:C,textFont:y.getFont(),fill:y.getTextColor()}}))},_renderBar:function(y){var B=this.visualMapModel;var v=this._shapes;var C=B.itemSize;var w=this._orient;var x=this._useHandle;var u=b.getItemAlign(B,this.api,C);var z=v.barGroup=this._createBarGroup(u);z.add(v.outOfRange=a());z.add(v.inRange=a(null,p.bind(this._modifyHandle,this,"all"),x?"move":null));var A=B.textStyleModel.getTextRect("å›?");var t=Math.max(A.width,A.height);if(x){v.handleThumbs=[];v.handleLabels=[];v.handleLabelPoints=[];this._createHandle(z,0,C,t,w,u);this._createHandle(z,1,C,t,w,u)}this._createIndicator(z,C,t,w);y.add(z)},_createHandle:function(A,v,D,t,x){var C=p.bind(this._modifyHandle,this,v);var z=a(g(v,t),C,"move");z.position[0]=D[0];A.add(z);var B=this.visualMapModel.textStyleModel;var w=new n.Text({draggable:true,drift:C,style:{x:0,y:0,text:"",textFont:B.getFont(),fill:B.getTextColor()}});this.group.add(w);var y=[x==="horizontal"?t/2:t*1.5,x==="horizontal"?(v===0?-(t*1.5):(t*1.5)):(v===0?-t/2:t/2)];var u=this._shapes;u.handleThumbs[v]=z;u.handleLabelPoints[v]=y;u.handleLabels[v]=w},_createIndicator:function(x,B,t,w){var z=a([[0,0]],null,"move");z.position[0]=B[0];z.attr({invisible:true,silent:true});x.add(z);var y=this.visualMapModel.textStyleModel;var u=new n.Text({silent:true,invisible:true,style:{x:0,y:0,text:"",textFont:y.getFont(),fill:y.getTextColor()}});this.group.add(u);var A=[w==="horizontal"?t/2:f+3,0];var v=this._shapes;v.indicator=z;v.indicatorLabel=u;v.indicatorLabelPoint=A},_modifyHandle:function(w,u,t){if(!this._useHandle){return}var v=this._applyTransform([u,t],this._shapes.barGroup,true);this._updateInterval(w,v[1]);this.api.dispatchAction({type:"selectDataRange",from:this.uid,visualMapId:this.visualMapModel.id,selected:this._dataInterval.slice()})},_resetInterval:function(){var u=this.visualMapModel;var v=this._dataInterval=u.getSelected();var w=u.getExtent();var t=[0,u.itemSize[1]];this._handleEnds=[c(v[0],w,t,true),c(v[1],w,t,true)]},_updateInterval:function(y,x){x=x||0;var u=this.visualMapModel;var w=this._handleEnds;o(x,w,[0,u.itemSize[1]],y==="all"?"rigid":"push",y);var v=u.getExtent();var t=[0,u.itemSize[1]];this._dataInterval=[c(w[0],t,v,true),c(w[1],t,v,true)]},_updateView:function(A){var w=this.visualMapModel;var y=w.getExtent();var v=this._shapes;var u=[0,w.itemSize[1]];var x=A?u:this._handleEnds;var z=this._createBarVisual(this._dataInterval,y,x,"inRange");var t=this._createBarVisual(y,y,u,"outOfRange");v.inRange.setStyle({fill:z.barColor,opacity:z.opacity}).setShape("points",z.barPoints);v.outOfRange.setStyle({fill:t.barColor,opacity:t.opacity}).setShape("points",t.barPoints);this._updateHandle(x,z)},_createBarVisual:function(y,z,A,v){var x={forceState:v,convertOpacityToAlpha:true};var u=this._makeColorGradient(y,x);var w=[this.getControllerVisual(y[0],"symbolSize",x),this.getControllerVisual(y[1],"symbolSize",x)];var t=this._createBarPoints(A,w);return{barColor:new e(0,0,1,1,u),barPoints:t,handlesColor:[u[0].color,u[u.length-1].color]}},_makeColorGradient:function(z,y){var t=100;var v=[];var x=(z[1]-z[0])/t;v.push({color:this.getControllerVisual(z[0],"color",y),offset:0});for(var w=1;w<t;w++){var u=z[0]+x*w;if(u>z[1]){break}v.push({color:this.getControllerVisual(u,"color",y),offset:w/t})}v.push({color:this.getControllerVisual(z[1],"color",y),offset:1});return v},_createBarPoints:function(v,t){var u=this.visualMapModel.itemSize;return[[u[0]-t[0],v[0]],[u[0],v[0]],[u[0],v[1]],[u[0]-t[1],v[1]]]},_createBarGroup:function(u){var v=this._orient;var t=this.visualMapModel.get("inverse");return new n.Group((v==="horizontal"&&!t)?{scale:u==="bottom"?[1,1]:[-1,1],rotation:Math.PI/2}:(v==="horizontal"&&t)?{scale:u==="bottom"?[-1,1]:[1,1],rotation:-Math.PI/2}:(v==="vertical"&&!t)?{scale:u==="left"?[1,-1]:[-1,-1]}:{scale:u==="left"?[1,1]:[-1,1]})},_updateHandle:function(y,x){if(!this._useHandle){return}var t=this._shapes;var v=this.visualMapModel;var w=t.handleThumbs;var u=t.handleLabels;d([0,1],function(B){var A=w[B];A.setStyle("fill",x.handlesColor[B]);A.position[1]=y[B];var z=n.applyTransform(t.handleLabelPoints[B],n.getTransform(A,this.group));u[B].setStyle({x:z[0],y:z[1],text:v.formatValueText(this._dataInterval[B]),textVerticalAlign:"middle",textAlign:this._applyTransform(this._orient==="horizontal"?(B===0?"bottom":"top"):"left",t.barGroup)})},this)},_showIndicator:function(E,z){var F=this.visualMapModel;var H=F.getExtent();var G=F.itemSize;var A=[0,G[1]];var C=c(E,H,A,true);var v=this._shapes;var D=v.indicator;if(!D){return}D.position[1]=C;D.attr("invisible",false);D.setShape("points",r(z,C,G[1]));var t={convertOpacityToAlpha:true};var x=this.getControllerVisual(E,"color",t);D.setStyle("fill",x);var w=n.applyTransform(v.indicatorLabelPoint,n.getTransform(D,this.group));var u=v.indicatorLabel;u.attr("invisible",false);var B=this._applyTransform("left",v.barGroup);var y=this._orient;u.setStyle({text:(z?"â‰?":"")+F.formatValueText(E),textVerticalAlign:y==="horizontal"?B:"middle",textAlign:y==="horizontal"?"center":B,x:w[0],y:w[1]})},_enableHoverLinkToSeries:function(){this._shapes.barGroup.on("mousemove",p.bind(t,this)).on("mouseout",p.bind(this._clearHoverLinkToSeries,this));function t(v){var B=this.visualMapModel;var D=B.itemSize;if(!B.option.hoverLink){return}var A=this._applyTransform([v.offsetX,v.offsetY],this._shapes.barGroup,true,true);var y=[A[1]-s/2,A[1]+s/2];var u=[0,D[1]];var E=B.getExtent();var x=[c(y[0],u,E,true),c(y[1],u,E,true)];if(0<=A[0]&&A[0]<=D[0]){this._showIndicator((x[0]+x[1])/2,true)}var w=q(this._hoverLinkDataIndices);this._hoverLinkDataIndices=B.findTargetDataIndices(x);var z=q(this._hoverLinkDataIndices);var C=b.removeDuplicateBatch(w,z);this.api.dispatchAction({type:"downplay",batch:C[0]});this.api.dispatchAction({type:"highlight",batch:C[1]})}},_enableHoverLinkFromSeries:function(){var t=this.api.getZr();if(this.visualMapModel.option.hoverLink){t.on("mouseover",this._hoverLinkFromSeriesMouseOver,this);t.on("mouseout",this._hideIndicator,this)}else{this._clearHoverLinkFromSeries()}},_hoverLinkFromSeriesMouseOver:function(y){var u=y.target;if(!u||u.dataIndex==null){return}var t=u.dataModel||this.ecModel.getSeriesByIndex(u.seriesIndex);var w=t.getData(u.dataType);var x=w.getDimension(this.visualMapModel.getDataDimension(w));var v=w.get(x,u.dataIndex,true);this._showIndicator(v)},_hideIndicator:function(){var t=this._shapes;t.indicator&&t.indicator.attr("invisible",true);t.indicatorLabel&&t.indicatorLabel.attr("invisible",true)},_clearHoverLinkToSeries:function(){this._hideIndicator();var t=this._hoverLinkDataIndices;this.api.dispatchAction({type:"downplay",batch:q(t)});t.length=0},_clearHoverLinkFromSeries:function(){this._hideIndicator();var t=this.api.getZr();t.off("mouseover",this._hoverLinkFromSeriesMouseOver);t.off("mouseout",this._hideIndicator)},_applyTransform:function(x,v,t,w){var u=n.getTransform(v,w?null:this.group);return n[p.isArray(x)?"applyTransform":"transformDirection"](x,u,t)},dispose:function(){this._clearHoverLinkFromSeries();this._clearHoverLinkToSeries()},remove:function(){this._clearHoverLinkFromSeries();this._clearHoverLinkToSeries()}});function a(u,t,v){return new n.Polygon({shape:{points:u},draggable:!!t,cursor:v,drift:t})}function g(u,t){return u===0?[[0,0],[t,0],[t,-t]]:[[0,0],[t,0],[t,t]]}function r(u,v,t){return u?[[0,-i(s,l(v,0))],[f,0],[0,i(s,l(t-v,0))]]:[[0,0],[5,-5],[5,5]]}return k});