define(function(c){var f=c("./VisualMapView");var b=c("zrender/core/util");var h=c("../../util/graphic");var a=c("../../util/symbol");var e=c("../../util/layout");var d=c("./helper");var g=f.extend({type:"visualMap.piecewise",doRender:function(){var m=this.group;m.removeAll();var q=this.visualMapModel;var i=q.get("textGap");var p=q.textStyleModel;var l=p.getFont();var t=p.getTextColor();var j=this._getItemAlign();var s=q.itemSize;var k=this._getViewData();var o=!k.endsText;var r=!o;r&&this._renderEndsText(m,k.endsText[0],s);b.each(k.viewPieceList,n,this);r&&this._renderEndsText(m,k.endsText[1],s);e.box(q.get("orient"),m,q.get("itemGap"));this.renderBackground(m);this.positionGroup(m);function n(w){var v=w.piece;var y=new h.Group();y.onclick=b.bind(this._onItemClick,this,v);this._enableHoverLink(y,w.indexInModelPieceList);var u=this._getRepresentValue(v);this._createItemSymbol(y,u,[0,0,s[0],s[1]]);if(o){var x=this.visualMapModel.getValueState(u);y.add(new h.Text({style:{x:j==="right"?-i:s[0]+i,y:s[1]/2,text:v.text,textVerticalAlign:"middle",textAlign:j,textFont:l,fill:t,opacity:x==="outOfRange"?0.5:1}}))}m.add(y)}},_enableHoverLink:function(k,j){k.on("mouseover",b.bind(i,this,"highlight")).on("mouseout",b.bind(i,this,"downplay"));function i(m){var l=this.visualMapModel;l.option.hoverLink&&this.api.dispatchAction({type:m,batch:d.convertDataIndicesToBatch(l.findTargetDataIndices(j))})}},_getItemAlign:function(){var i=this.visualMapModel;var j=i.option;if(j.orient==="vertical"){return d.getItemAlign(i,this.api,i.itemSize)}else{var k=j.align;if(!k||k==="auto"){k="left"}return k}},_renderEndsText:function(k,l,j){if(!l){return}var m=new h.Group();var i=this.visualMapModel.textStyleModel;m.add(new h.Text({style:{x:j[0]/2,y:j[1]/2,textVerticalAlign:"middle",textAlign:"center",text:l,textFont:i.getFont(),fill:i.getTextColor()}}));k.add(m)},_getViewData:function(){var l=this.visualMapModel;var m=b.map(l.getPieceList(),function(o,n){return{piece:o,indexInModelPieceList:n}});var j=l.get("text");var k=l.get("orient");var i=l.get("inverse");if(k==="horizontal"?i:!i){m.reverse()}else{if(j){j=j.slice().reverse()}}return{viewPieceList:m,endsText:j}},_getRepresentValue:function(j){var i;if(this.visualMapModel.isCategory()){i=j.value}else{if(j.value!=null){i=j.value}else{var k=j.interval||[];i=(k[0]+k[1])/2}}return i},_createItemSymbol:function(j,i,k){j.add(a.createSymbol(this.getControllerVisual(i,"symbol"),k[0],k[1],k[2],k[3],this.getControllerVisual(i,"color")))},_onItemClick:function(l){var i=this.visualMapModel;var k=i.option;var j=b.clone(k.selected);var m=i.getSelectedMapKey(l);if(k.selectedMode==="single"){j[m]=true;b.each(j,function(p,n){j[n]=n===m})}else{j[m]=!j[m]}this.api.dispatchAction({type:"selectDataRange",from:this.uid,visualMapId:this.visualMapModel.id,selected:j})}});return g});