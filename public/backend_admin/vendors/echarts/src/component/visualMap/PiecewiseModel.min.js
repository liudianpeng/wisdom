define(function(b){var f=b("./VisualMapModel");var a=b("zrender/core/util");var g=b("../../visual/VisualMapping");var c=f.extend({type:"visualMap.piecewise",defaultOption:{selected:null,align:"auto",itemWidth:20,itemHeight:14,itemSymbol:"roundRect",pieceList:null,categories:null,splitNumber:5,selectedMode:"multiple",itemGap:10,hoverLink:true},doMergeOption:function(i,k){c.superApply(this,"doMergeOption",arguments);this._pieceList=[];this.resetTargetSeries(i,k);this.resetExtent();var j=this._mode=this._decideMode();e[this._mode].call(this);this._resetSelected(i,k);var h=this.option.categories;this.resetVisual(function(m,l){if(j==="categories"){m.mappingMethod="category";m.categories=a.clone(h)}else{m.mappingMethod="piecewise";m.pieceList=a.map(this._pieceList,function(n){var n=a.clone(n);if(l!=="inRange"){n.visual=null}return n})}})},_resetSelected:function(l,m){var i=this.option;var h=this._pieceList;var j=(m?i:l).selected||{};i.selected=j;a.each(h,function(p,n){var o=this.getSelectedMapKey(p);if(!(o in j)){j[o]=true}},this);if(i.selectedMode==="single"){var k=false;a.each(h,function(p,n){var o=this.getSelectedMapKey(p);if(j[o]){k?(j[o]=false):(k=true)}},this)}},getSelectedMapKey:function(h){return this._mode==="categories"?h.value+"":h.index+""},getPieceList:function(){return this._pieceList},_decideMode:function(){var h=this.option;return h.pieces&&h.pieces.length>0?"pieces":this.option.categories?"categories":"splitNumber"},setSelected:function(h){this.option.selected=a.clone(h)},getValueState:function(i){var h=g.findPieceIndex(i,this._pieceList);return h!=null?(this.option.selected[this.getSelectedMapKey(this._pieceList[h])]?"inRange":"outOfRange"):"outOfRange"},findTargetDataIndices:function(i){var h=[];this.eachTargetSeries(function(j){var l=[];var k=j.getData();k.each(this.getDataDimension(k),function(o,n){var m=g.findPieceIndex(o,this._pieceList);m===i&&l.push(n)},true,this);h.push({seriesId:j.id,dataIndices:l})},this);return h}});var e={splitNumber:function(){var m=this.option;var k=m.precision;var n=this.getExtent();var p=m.splitNumber;p=Math.max(parseInt(p,10),1);m.splitNumber=p;var j=(n[1]-n[0])/p;while(+j.toFixed(k)!==j&&k<5){k++}m.precision=k;j=+j.toFixed(k);for(var l=0,o=n[0];l<p;l++,o+=j){var h=l===p-1?n[1]:(o+j);this._pieceList.push({text:this.formatValueText([o,h]),index:l,interval:[o,h]})}},categories:function(){var h=this.option;a.each(h.categories,function(i){this._pieceList.push({text:this.formatValueText(i,true),value:i})},this);d(h,this._pieceList)},pieces:function(){var h=this.option;a.each(h.pieces,function(k,l){if(!a.isObject(k)){k={value:k}}var n={text:"",index:l};var j;if(k.label!=null){n.text=k.label;j=true}if(k.hasOwnProperty("value")){n.value=k.value;if(!j){n.text=this.formatValueText(n.value)}}else{var m=k.min;var i=k.max;m==null&&(m=-Infinity);i==null&&(i=Infinity);if(m===i){n.value=m}n.interval=[m,i];if(!j){n.text=this.formatValueText([m,i])}}n.visual=g.retrieveVisuals(k);this._pieceList.push(n)},this);d(h,this._pieceList)}};function d(j,h){var i=j.inverse;if(j.orient==="vertical"?!i:i){h.reverse()}}return c});