define(function(d){var f=d("zrender/core/util");var k=d("zrender/core/env");var g=d("../../echarts");var p=d("../../util/model");var b=d("../../visual/visualDefault");var a=d("../../visual/VisualMapping");var m=a.mapVisual;var e=a.eachVisual;var c=d("../../util/number");var i=f.isArray;var o=f.each;var n=c.asc;var j=c.linearMap;var l=g.extendComponentModel({type:"visualMap",dependencies:["series"],dataBound:[-Infinity,Infinity],stateList:["inRange","outOfRange"],layoutMode:{type:"box",ignoreSize:true},defaultOption:{show:true,zlevel:0,z:4,min:0,max:200,dimension:null,inRange:null,outOfRange:null,left:0,right:null,top:null,bottom:0,itemWidth:null,itemHeight:null,inverse:false,orient:"vertical",seriesIndex:null,backgroundColor:"rgba(0,0,0,0)",borderColor:"#ccc",contentColor:"#5793f3",inactiveColor:"#aaa",borderWidth:0,padding:5,textGap:10,precision:0,color:["#bf444c","#d88273","#f6efa6"],formatter:null,text:null,textStyle:{color:"#333"}},init:function(s,r,q){this._dataExtent;this.controllerVisuals={};this.targetVisuals={};this.textStyleModel;this.itemSize;this.mergeDefaultAndTheme(s,q);this.doMergeOption({},true)},mergeOption:function(q){l.superApply(this,"mergeOption",arguments);this.doMergeOption(q,false)},doMergeOption:function(r,s){var q=this.option;!s&&h(q,r);if(!k.canvasSupported){q.realtime=false}this.textStyleModel=this.getModel("textStyle");this.resetItemSize();this.completeVisualOption()},formatValueText:function(w,v){var s=this.option;var t=s.precision;var u=this.dataBound;var x=s.formatter;var y;var r;if(f.isArray(w)){w=w.slice();y=true}r=v?w:(y?[q(w[0]),q(w[1])]:q(w));if(f.isString(x)){return x.replace("{value}",y?r[0]:r).replace("{value2}",y?r[1]:r)}else{if(f.isFunction(x)){return y?x(w[0],w[1]):x(w)}}if(y){if(w[0]===u[0]){return"< "+r[1]}else{if(w[1]===u[1]){return"> "+r[0]}else{return r[0]+" - "+r[1]}}}else{return r}function q(z){return z===u[0]?"min":z===u[1]?"max":(+z).toFixed(t)}},resetTargetSeries:function(r,t){var q=this.option;var s=q.seriesIndex==null;q.seriesIndex=s?[]:p.normalizeToArray(q.seriesIndex);s&&this.ecModel.eachSeries(function(u,v){var w=u.getData();if(w.type==="list"){q.seriesIndex.push(v)}})},resetExtent:function(){var q=this.option;var r=n([q.min,q.max]);this._dataExtent=r},getDataDimension:function(q){var r=this.option.dimension;return r!=null?r:q.dimensions.length-1},getExtent:function(){return this._dataExtent.slice()},resetVisual:function(q){var r=this.getExtent();s.call(this,"controller",this.controllerVisuals);s.call(this,"target",this.targetVisuals);function s(v,u){o(this.stateList,function(x){var y=u[x]||(u[x]=t());var w=this.option[v][x]||{};o(w,function(B,A){if(!a.isValidType(A)){return}var z={type:A,dataExtent:r,visual:B};q&&q.call(this,z,x);y[A]=new a(z);if(v==="controller"&&A==="opacity"){z=f.clone(z);z.type="colorAlpha";y.__hidden.__alphaForOpacity=new a(z)}},this)},this)}function t(){var u=function(){};u.prototype.__hidden=u.prototype;var v=new u();return v}},completeVisualOption:function(){var t=this.option;var u={inRange:t.inRange,outOfRange:t.outOfRange};var w=t.target||(t.target={});var r=t.controller||(t.controller={});f.merge(w,u);f.merge(r,u);var s=this.isCategory();x.call(this,w);x.call(this,r);q.call(this,w,"inRange","outOfRange");q.call(this,w,"outOfRange","inRange");v.call(this,r);function x(y){if(i(t.color)&&!y.inRange){y.inRange={color:t.color.slice().reverse()}}o(this.stateList,function(A){var B=y[A];if(f.isString(B)){var z=b.get(B,"active",s);if(z){y[A]={};y[A][B]=z}else{delete y[A]}}},this)}function q(B,C,z){var A=B[C];var y=B[z];if(A&&!y){y=B[z]={};o(A,function(F,E){if(!a.isValidType(E)){return}var D=b.get(E,"inactive",s);if(D!=null){y[E]=D;if(E==="color"&&!y.hasOwnProperty("opacity")&&!y.hasOwnProperty("colorAlpha")){y.opacity=[0,0]}}})}}function v(y){var B=(y.inRange||{}).symbol||(y.outOfRange||{}).symbol;var A=(y.inRange||{}).symbolSize||(y.outOfRange||{}).symbolSize;var z=this.get("inactiveColor");o(this.stateList,function(F){var G=this.itemSize;var E=y[F];if(!E){E=y[F]={color:s?z:[z]}}if(E.symbol==null){E.symbol=B&&f.clone(B)||(s?"roundRect":["roundRect"])}if(E.symbolSize==null){E.symbolSize=A&&f.clone(A)||(s?G[0]:[G[0],G[0]])}E.symbol=m(E.symbol,function(H){return(H==="none"||H==="square")?"roundRect":H});var D=E.symbolSize;if(D!=null){var C=-Infinity;e(D,function(H){H>C&&(C=H)});E.symbolSize=m(D,function(H){return j(H,[0,C],[0,G[0]],true)})}},this)}},eachTargetSeries:function(r,q){f.each(this.option.seriesIndex,function(s){r.call(q,this.ecModel.getSeriesByIndex(s))},this)},isCategory:function(){return !!this.option.categories},resetItemSize:function(){this.itemSize=[parseFloat(this.get("itemWidth")),parseFloat(this.get("itemHeight"))]},setSelected:f.noop,getValueState:f.noop});function h(r,s){var t=["inRange","outOfRange","target","controller","color"];var q;f.each(t,function(u){if(s.hasOwnProperty(u)){q=true}});q&&f.each(t,function(u){if(s.hasOwnProperty(u)){r[u]=f.clone(s[u])}else{delete r[u]}})}return l});