define(function(e){var n=e("./TooltipContent");var a=e("../../util/graphic");var f=e("zrender/core/util");var b=e("../../util/format");var c=e("../../util/number");var g=c.parsePercent;var i=e("zrender/core/env");function p(r,q){if(!r||!q){return false}var s=c.round;return s(r[0])===s(q[0])&&s(r[1])===s(q[1])}function l(r,t,q,s){return{x1:r,y1:t,x2:q,y2:s}}function j(r,t,s,q){return{x:r,y:t,width:s,height:q}}function o(q,w,t,v,u,s){return{cx:q,cy:w,r0:t,r:v,startAngle:u,endAngle:s,clockwise:true}}function m(r,z,v,u,s){var t=v.clientWidth;var q=v.clientHeight;var w=20;if(r+t+w>u){r-=t+w}else{r+=w}if(z+q+w>s){z-=q+w}else{z+=w}return[r,z]}function k(t,z,r){var u=r.clientWidth;var s=r.clientHeight;var A=5;var B=0;var w=0;var q=z.width;var v=z.height;switch(t){case"inside":B=z.x+q/2-u/2;w=z.y+v/2-s/2;break;case"top":B=z.x+q/2-u/2;w=z.y-s-A;break;case"bottom":B=z.x+q/2-u/2;w=z.y+v+A;break;case"left":B=z.x-u-A;w=z.y+v/2-s/2;break;case"right":B=z.x+q+A;w=z.y+v/2-s/2}return[B,w]}function h(w,C,B,v,s,q,u){var t=u.getWidth();var r=u.getHeight();var A=q&&q.getBoundingRect().clone();q&&A.applyTransform(q.transform);if(typeof w==="function"){w=w([C,B],s,v.el,A)}if(f.isArray(w)){C=g(w[0],t);B=g(w[1],r)}else{if(typeof w==="string"&&q){var z=k(w,A,v.el);C=z[0];B=z[1]}else{var z=m(C,B,v.el,t,r);C=z[0];B=z[1]}}v.moveTo(C,B)}function d(q){var s=q.coordinateSystem;var r=q.get("tooltip.trigger",true);return !(!s||(s.type!=="cartesian2d"&&s.type!=="polar"&&s.type!=="single")||r==="item")}e("../../echarts").extendComponentView({type:"tooltip",_axisPointers:{},init:function(q,r){if(i.node){return}var s=new n(r.getDom(),r);this._tooltipContent=s;r.on("showTip",this._manuallyShowTip,this);r.on("hideTip",this._manuallyHideTip,this)},render:function(u,q,t){if(i.node){return}this.group.removeAll();this._axisPointers={};this._tooltipModel=u;this._ecModel=q;this._api=t;this._lastHover={};var v=this._tooltipContent;v.update();v.enterable=u.get("enterable");this._alwaysShowContent=u.get("alwaysShowContent");this._seriesGroupByAxis=this._prepareAxisTriggerData(u,q);var s=this._crossText;if(s){this.group.add(s)}if(this._lastX!=null&&this._lastY!=null){var r=this;clearTimeout(this._refreshUpdateTimeout);this._refreshUpdateTimeout=setTimeout(function(){r._manuallyShowTip({x:r._lastX,y:r._lastY})})}var w=this._api.getZr();w.off("click",this._tryShow);w.off("mousemove",this._mousemove);w.off("mouseout",this._hide);w.off("globalout",this._hide);if(u.get("triggerOn")==="click"){w.on("click",this._tryShow,this)}else{w.on("mousemove",this._mousemove,this);w.on("mouseout",this._hide,this);w.on("globalout",this._hide,this)}},_mousemove:function(s){var q=this._tooltipModel.get("showDelay");var r=this;clearTimeout(this._showTimeout);if(q>0){this._showTimeout=setTimeout(function(){r._tryShow(s)},q)}else{this._tryShow(s)}},_manuallyShowTip:function(q){if(q.from===this.uid){return}var y=this._ecModel;var w=q.seriesIndex;var B=q.dataIndex;var t=y.getSeriesByIndex(w);var z=this._api;if(q.x==null||q.y==null){if(!t){y.eachSeries(function(D){if(d(D)&&!t){t=D}})}if(t){var x=t.getData();if(B==null){B=x.indexOfName(q.name)}var r=x.getItemGraphicEl(B);var u,s;var v=t.coordinateSystem;if(v&&v.dataToPoint){var C=v.dataToPoint(x.getValues(f.map(v.dimensions,function(D){return t.coordDimToDataDim(D)[0]}),B,true));u=C&&C[0];s=C&&C[1]}else{if(r){var A=r.getBoundingRect().clone();A.applyTransform(r.transform);u=A.x+A.width/2;s=A.y+A.height/2}}if(u!=null&&s!=null){this._tryShow({offsetX:u,offsetY:s,target:r,event:{}})}}}else{var r=z.getZr().handler.findHover(q.x,q.y);this._tryShow({offsetX:q.x,offsetY:q.y,target:r,event:{}})}},_manuallyHideTip:function(q){if(q.from===this.uid){return}this._hide()},_prepareAxisTriggerData:function(s,q){var r={};q.eachSeries(function(t){if(d(t)){var v=t.coordinateSystem;var w;var u;if(v.type==="cartesian2d"){w=v.getBaseAxis();u=w.dim+w.index}else{if(v.type==="single"){w=v.getAxis();u=w.dim+w.type}else{w=v.getBaseAxis();u=w.dim+v.name}}r[u]=r[u]||{coordSys:[],series:[]};r[u].coordSys.push(v);r[u].series.push(t)}},this);return r},_tryShow:function(t){var q=t.target;var x=this._tooltipModel;var v=x.get("trigger");var r=this._ecModel;var s=this._api;if(!x){return}this._lastX=t.offsetX;this._lastY=t.offsetY;if(q&&q.dataIndex!=null){var u=q.dataModel||r.getSeriesByIndex(q.seriesIndex);var w=q.dataIndex;var y=u.getData().getItemModel(w);if((y.get("tooltip.trigger")||v)==="axis"){this._showAxisTooltip(x,r,t)}else{this._ticket="";this._hideAxisPointer();this._resetLastHover();this._showItemTooltipContent(u,w,q.dataType,t)}s.dispatchAction({type:"showTip",from:this.uid,dataIndex:q.dataIndex,seriesIndex:q.seriesIndex})}else{if(v==="item"){this._hide()}else{this._showAxisTooltip(x,r,t)}if(x.get("axisPointer.type")==="cross"){s.dispatchAction({type:"showTip",from:this.uid,x:t.offsetX,y:t.offsetY})}}},_showAxisTooltip:function(y,s,u){var v=y.getModel("axisPointer");var x=v.get("type");if(x==="cross"){var q=u.target;if(q&&q.dataIndex!=null){var r=s.getSeriesByIndex(q.seriesIndex);var w=q.dataIndex;this._showItemTooltipContent(r,w,q.dataType,u)}}this._showAxisPointer();var t=true;f.each(this._seriesGroupByAxis,function(D){var F=D.coordSys;var B=F[0];var G=[u.offsetX,u.offsetY];if(!B.containPoint(G)){this._hideAxisPointer(B.name);return}t=false;var z=B.dimensions;var E=B.pointToData(G,true);G=B.dataToPoint(E);var A=B.getBaseAxis();var H=v.get("axis");if(H==="auto"){H=A.dim}var J=false;var C=this._lastHover;if(x==="cross"){if(p(C.data,E)){J=true}C.data=E}else{var I=f.indexOf(z,H);if(C.data===E[I]){J=true}C.data=E[I]}if(B.type==="cartesian2d"&&!J){this._showCartesianPointer(v,B,H,G)}else{if(B.type==="polar"&&!J){this._showPolarPointer(v,B,H,G)}else{if(B.type==="single"&&!J){this._showSinglePointer(v,B,H,G)}}}if(x!=="cross"){this._dispatchAndShowSeriesTooltipContent(B,D.series,G,E,J)}},this);if(!this._tooltipModel.get("show")){this._hideAxisPointer()}if(t){this._hide()}},_showCartesianPointer:function(u,r,z,y){var A=this;var x=u.get("type");var v=x!=="cross";if(x==="cross"){t("x",y,r.getAxis("y").getGlobalExtent());t("y",y,r.getAxis("x").getGlobalExtent());this._updateCrossText(r,y,u)}else{var q=r.getAxis(z==="x"?"y":"x");var s=q.getGlobalExtent();if(r.type==="cartesian2d"){(x==="line"?t:w)(z,y,s)}}function t(C,B,F){var D=C==="x"?l(B[0],F[0],B[0],F[1]):l(F[0],B[1],F[1],B[1]);var E=A._getPointerElement(r,u,C,D);v?a.updateProps(E,{shape:D},u):E.attr({shape:D})}function w(D,C,I){var H=r.getAxis(D);var B=H.getBandWidth();var G=I[1]-I[0];var E=D==="x"?j(C[0]-B/2,I[0],B,G):j(I[0],C[1]-B/2,G,B);var F=A._getPointerElement(r,u,D,E);v?a.updateProps(F,{shape:E},u):F.attr({shape:E})}},_showSinglePointer:function(s,x,y,w){var z=this;var v=s.get("type");var t=v!=="cross";var u=x.getRect();var r=[u.y,u.y+u.height];q(y,w,r);function q(B,A,G){var F=x.getAxis();var E=F.orient;var C=E==="horizontal"?l(A[0],G[0],A[0],G[1]):l(G[0],A[1],G[1],A[1]);var D=z._getPointerElement(x,s,B,C);t?a.updateProps(D,{shape:C},s):D.attr({shape:C})}},_showPolarPointer:function(x,q,A,z){var B=this;var y=x.get("type");var C=q.getAngleAxis();var s=q.getRadiusAxis();var w=y!=="cross";if(y==="cross"){v("angle",z,s.getExtent());v("radius",z,C.getExtent());this._updateCrossText(q,z,x)}else{var r=q.getAxis(A==="radius"?"angle":"radius");var u=r.getExtent();(y==="line"?v:t)(A,z,u)}function v(E,D,K){var G=q.pointToCoord(D);var F;if(E==="angle"){var J=q.coordToPoint([K[0],G[1]]);var I=q.coordToPoint([K[1],G[1]]);F=l(J[0],J[1],I[0],I[1])}else{F={cx:q.cx,cy:q.cy,r:G[0]}}var H=B._getPointerElement(q,x,E,F);w?a.updateProps(H,{shape:F},x):H.attr({shape:F})}function t(L,K,G){var E=q.getAxis(L);var F=E.getBandWidth();var H=q.pointToCoord(K);var D;var I=Math.PI/180;if(L==="angle"){D=o(q.cx,q.cy,G[0],G[1],(-H[1]-F/2)*I,(-H[1]+F/2)*I)}else{D=o(q.cx,q.cy,H[0]-F/2,H[0]+F/2,0,Math.PI*2)}var J=B._getPointerElement(q,x,L,D);w?a.updateProps(J,{shape:D},x):J.attr({shape:D})}},_updateCrossText:function(q,w,r){var x=r.getModel("crossStyle");var s=x.getModel("textStyle");var v=this._tooltipModel;var y=this._crossText;if(!y){y=this._crossText=new a.Text({style:{textAlign:"left",textVerticalAlign:"bottom"}});this.group.add(y)}var u=q.pointToData(w);var t=q.dimensions;u=f.map(u,function(B,z){var A=q.getAxis(t[z]);if(A.type==="category"||A.type==="time"){B=A.scale.getLabel(B)}else{B=b.addCommas(B.toFixed(A.getPixelPrecision()))}return B});y.setStyle({fill:s.getTextColor()||x.get("color"),textFont:s.getFont(),text:u.join(", "),x:w[0]+5,y:w[1]-5});y.z=v.get("z");y.zlevel=v.get("zlevel")},_getPointerElement:function(v,s,E,y){var D=this._tooltipModel;var C=D.get("z");var x=D.get("zlevel");var F=this._axisPointers;var u=v.name;F[u]=F[u]||{};if(F[u][E]){return F[u][E]}var q=s.get("type");var B=s.getModel(q+"Style");var w=q==="shadow";var r=B[w?"getAreaStyle":"getLineStyle"]();var A=v.type==="polar"?(w?"Sector":(E==="radius"?"Circle":"Line")):(w?"Rect":"Line");w?(r.stroke=null):(r.fill=null);var t=F[u][E]=new a[A]({style:r,z:C,zlevel:x,silent:true,shape:y});this.group.add(t);return t},_dispatchAndShowSeriesTooltipContent:function(u,F,G,E,v){var s=this._tooltipModel;var w=this._tooltipContent;var z=u.getBaseAxis();var r=f.map(F,function(K){return{seriesIndex:K.seriesIndex,dataIndex:K.getAxisTooltipDataIndex?K.getAxisTooltipDataIndex(K.coordDimToDataDim(z.dim),E,z):K.getData().indexOfNearest(K.coordDimToDataDim(z.dim)[0],E[z.dim==="x"||z.dim==="radius"?0:1])}});var x=this._lastHover;var C=this._api;if(x.payloadBatch&&!v){C.dispatchAction({type:"downplay",batch:x.payloadBatch})}if(!v){C.dispatchAction({type:"highlight",batch:r});x.payloadBatch=r}C.dispatchAction({type:"showTip",dataIndex:r[0].dataIndex,seriesIndex:r[0].seriesIndex,from:this.uid});if(z&&s.get("showContent")&&s.get("show")){var H=s.get("formatter");var q=s.get("position");var y;var B=f.map(F,function(L,K){return L.getDataParams(r[K].dataIndex)});w.show(s);var J=r[0].dataIndex;if(!v){this._ticket="";if(!H){var A=F[0].getData().getName(J);y=(A?A+"<br />":"")+f.map(F,function(L,K){return L.formatTooltip(r[K].dataIndex,true)}).join("<br />")}else{if(typeof H==="string"){y=b.formatTpl(H,B)}else{if(typeof H==="function"){var D=this;var I="axis_"+u.name+"_"+J;var t=function(L,K){if(L===D._ticket){w.setContent(K);h(q,G[0],G[1],w,B,null,C)}};D._ticket=I;y=H(B,I,t)}}}w.setContent(y)}h(q,G[0],G[1],w,B,null,C)}},_showItemTooltipContent:function(q,z,A,w){var v=this._api;var t=q.getData(A);var G=t.getItemModel(z);var s=this._tooltipModel;var D=this._tooltipContent;var C=G.getModel("tooltip");if(C.parentModel){C.parentModel.parentModel=s}else{C.parentModel=this._tooltipModel}if(C.get("showContent")&&C.get("show")){var B=C.get("formatter");var y=C.get("position");var r=q.getDataParams(z,A);var u;if(!B){u=q.formatTooltip(z,false,A)}else{if(typeof B==="string"){u=b.formatTpl(B,r)}else{if(typeof B==="function"){var F=this;var x="item_"+q.name+"_"+z;var E=function(I,H){if(I===F._ticket){D.setContent(H);h(y,w.offsetX,w.offsetY,D,r,w.target,v)}};F._ticket=x;u=B(r,x,E)}}}D.show(C);D.setContent(u);h(y,w.offsetX,w.offsetY,D,r,w.target,v)}},_showAxisPointer:function(r){if(r){var q=this._axisPointers[r];q&&f.each(q,function(s){s.show()})}else{this.group.eachChild(function(s){s.show()});this.group.show()}},_resetLastHover:function(){var q=this._lastHover;if(q.payloadBatch){this._api.dispatchAction({type:"downplay",batch:q.payloadBatch})}this._lastHover={}},_hideAxisPointer:function(r){if(r){var q=this._axisPointers[r];q&&f.each(q,function(s){s.hide()})}else{this.group.hide()}},_hide:function(){clearTimeout(this._showTimeout);this._hideAxisPointer();this._resetLastHover();if(!this._alwaysShowContent){this._tooltipContent.hideLater(this._tooltipModel.get("hideDelay"))}this._api.dispatchAction({type:"hideTip",from:this.uid});this._lastX=this._lastY=null},dispose:function(q,r){if(i.node){return}var s=r.getZr();this._tooltipContent.hide();s.off("click",this._tryShow);s.off("mousemove",this._mousemove);s.off("mouseout",this._hide);s.off("globalout",this._hide);r.off("showTip",this._manuallyShowTip);r.off("hideTip",this._manuallyHideTip)}})});