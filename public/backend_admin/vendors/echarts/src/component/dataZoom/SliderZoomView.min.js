define(function(j){var r=j("zrender/core/util");var n=j("../../util/graphic");var e=j("../../util/throttle");var q=j("./DataZoomView");var g=n.Rect;var i=j("../../util/number");var a=i.linearMap;var v=j("../../util/layout");var p=j("../helper/sliderMove");var t=i.asc;var x=r.bind;var u=Math.round;var l=Math.max;var c=r.each;var k=7;var h=1;var o=30;var w="horizontal";var s="vertical";var d=5;var f=["line","bar","candlestick","scatter"];var b=q.extend({type:"dataZoom.slider",init:function(y,z){this._displayables={};this._orient;this._range;this._handleEnds;this._size;this._halfHandleSize;this._location;this._dragging;this._dataShadowInfo;this.api=z},render:function(B,y,z,A){b.superApply(this,"render",arguments);e.createOrUpdate(this,"_dispatchZoomAction",this.dataZoomModel.get("throttle"),"fixRate");this._orient=B.get("orient");this._halfHandleSize=u(B.get("handleSize")/2);if(this.dataZoomModel.get("show")===false){this.group.removeAll();return}if(!A||A.type!=="dataZoom"||A.from!==this.uid){this._buildView()}this._updateView()},remove:function(){b.superApply(this,"remove",arguments);e.clear(this,"_dispatchZoomAction")},dispose:function(){b.superApply(this,"dispose",arguments);e.clear(this,"_dispatchZoomAction")},_buildView:function(){var y=this.group;y.removeAll();this._resetLocation();this._resetInterval();var z=this._displayables.barGroup=new n.Group();this._renderBackground();this._renderDataShadow();this._renderHandle();y.add(z);this._positionGroup()},_resetLocation:function(){var E=this.dataZoomModel;var C=this.api;var B=this._findCoordRect();var y={width:C.getWidth(),height:C.getHeight()};var z=this._orient===w?{right:y.width-B.x-B.width,top:(y.height-o-k),width:B.width,height:o}:{right:k,top:B.y,width:o,height:B.height};var A=v.getLayoutParams(E.option);r.each(["right","top","width","height"],function(F){if(A[F]==="ph"){A[F]=z[F]}});var D=v.getLayoutRect(A,y,E.padding);this._location={x:D.x,y:D.y};this._size=[D.width,D.height];this._orient===s&&this._size.reverse()},_positionGroup:function(){var B=this.group;var z=this._location;var C=this._orient;var F=this.dataZoomModel.getFirstTargetAxisModel();var y=F&&F.get("inverse");var E=this._displayables.barGroup;var A=(this._dataShadowInfo||{}).otherAxisInverse;E.attr((C===w&&!y)?{scale:A?[1,1]:[1,-1]}:(C===w&&y)?{scale:A?[-1,1]:[-1,-1]}:(C===s&&!y)?{scale:A?[1,-1]:[1,1],rotation:Math.PI/2}:{scale:A?[-1,-1]:[-1,1],rotation:Math.PI/2});var D=B.getBoundingRect([E]);B.position[0]=z.x-D.x;B.position[1]=z.y-D.y},_getViewExtent:function(){var y=this._halfHandleSize;var A=l(this._size[0],y*4);var z=[y,A-y];return z},_renderBackground:function(){var z=this.dataZoomModel;var y=this._size;this._displayables.barGroup.add(new g({silent:true,shape:{x:0,y:0,width:y[0],height:y[1]},style:{fill:z.get("backgroundColor")}}))},_renderDataShadow:function(){var B=this._dataShadowInfo=this._prepareDataShadowInfo();if(!B){return}var K=this._size;var C=B.series;var D=C.getRawData();var H=C.getShadowDim?C.getShadowDim():B.otherDim;var E=D.getDataExtent(H);var J=(E[1]-E[0])*0.3;E=[E[0]-J,E[1]+J];var I=[0,K[1]];var G=[0,K[0]];var F=[[K[0],0],[0,0]];var A=G[1]/(D.count()-1);var y=0;var z=Math.round(D.count()/K[0]);D.each([H],function(N,L){if(z>0&&(L%z)){y+=A;return}var M=(N==null||isNaN(N)||N==="")?null:a(N,E,I,true);M!=null&&F.push([y,M]);y+=A});this._displayables.barGroup.add(new n.Polyline({shape:{points:F},style:{fill:this.dataZoomModel.get("dataBackgroundColor"),lineWidth:0},silent:true,z2:-20}))},_prepareDataShadowInfo:function(){var B=this.dataZoomModel;var A=B.get("showDataShadow");if(A===false){return}var z;var y=this.ecModel;B.eachTargetAxis(function(C,D){var E=B.getAxisProxy(C.name,D).getTargetSeriesModels();r.each(E,function(G){if(z){return}if(A!==true&&r.indexOf(f,G.get("type"))<0){return}var F=m(C.name);var H=y.getComponent(C.axis,D).axis;z={thisAxis:H,series:G,thisDim:C.name,otherDim:F,otherAxisInverse:G.coordinateSystem.getOtherAxis(H).inverse}},this)},this);return z},_renderHandle:function(){var C=this._displayables;var A=C.handles=[];var y=C.handleLabels=[];var B=this._displayables.barGroup;var z=this._size;B.add(C.filler=new g({draggable:true,cursor:"move",drift:x(this._onDragMove,this,"all"),ondragend:x(this._onDragEnd,this),onmouseover:x(this._showDataInfo,this,true),onmouseout:x(this._showDataInfo,this,false),style:{fill:this.dataZoomModel.get("fillerColor"),textPosition:"inside"}}));B.add(new g(n.subPixelOptimizeRect({silent:true,shape:{x:0,y:0,width:z[0],height:z[1]},style:{stroke:this.dataZoomModel.get("dataBackgroundColor"),lineWidth:h,fill:"rgba(0,0,0,0)"}})));c([0,1],function(E){B.add(A[E]=new g({style:{fill:this.dataZoomModel.get("handleColor")},cursor:"move",draggable:true,drift:x(this._onDragMove,this,E),ondragend:x(this._onDragEnd,this),onmouseover:x(this._showDataInfo,this,true),onmouseout:x(this._showDataInfo,this,false)}));var D=this.dataZoomModel.textStyleModel;this.group.add(y[E]=new n.Text({silent:true,invisible:true,style:{x:0,y:0,text:"",textVerticalAlign:"middle",textAlign:"center",fill:D.getTextColor(),textFont:D.getFont()}}))},this)},_resetInterval:function(){var y=this._range=this.dataZoomModel.getPercentRange();var z=this._getViewExtent();this._handleEnds=[a(y[0],[0,100],z,true),a(y[1],[0,100],z,true)]},_updateInterval:function(B,A){var z=this._handleEnds;var y=this._getViewExtent();p(A,z,y,(B==="all"||this.dataZoomModel.get("zoomLock"))?"rigid":"cross",B);this._range=t([a(z[0],y,[0,100],true),a(z[1],y,[0,100],true)])},_updateView:function(){var C=this._displayables;var B=this._handleEnds;var z=t(B.slice());var A=this._size;var y=this._halfHandleSize;c([0,1],function(E){var D=C.handles[E];D.setShape({x:B[E]-y,y:-1,width:y*2,height:A[1]+2,r:1})},this);C.filler.setShape({x:z[0],y:0,width:z[1]-z[0],height:this._size[1]});this._updateDataInfo()},_updateDataInfo:function(){var D=this.dataZoomModel;var y=this._displayables;var B=y.handleLabels;var C=this._orient;var F=["",""];if(D.get("showDetail")){var E;var A;D.eachTargetAxis(function(H,I){if(!E){E=D.getAxisProxy(H.name,I).getDataValueWindow();A=this.ecModel.getComponent(H.axis,I).axis}},this);if(E){F=[this._formatLabel(E[0],A),this._formatLabel(E[1],A)]}}var G=t(this._handleEnds.slice());z.call(this,0);z.call(this,1);function z(L){var J=n.getTransform(y.handles[L],this.group);var I=n.transformDirection(L===0?"right":"left",J);var K=this._halfHandleSize+d;var H=n.applyTransform([G[L]+(L===0?-K:K),this._size[1]/2],J);B[L].setStyle({x:H[0],y:H[1],textVerticalAlign:C===w?"middle":I,textAlign:C===w?I:"center",text:F[L]})}},_formatLabel:function(B,A){var C=this.dataZoomModel;var z=C.get("labelFormatter");if(r.isFunction(z)){return z(B)}var y=C.get("labelPrecision");if(y==null||y==="auto"){y=A.getPixelPrecision()}B=(B==null&&isNaN(B))?"":(A.type==="category"||A.type==="time")?A.scale.getLabel(Math.round(B)):B.toFixed(Math.min(y,20));if(r.isString(z)){B=z.replace("{value}",B)}return B},_showDataInfo:function(y){y=this._dragging||y;var z=this._displayables.handleLabels;z[0].attr("invisible",!y);z[1].attr("invisible",!y)},_onDragMove:function(B,z,y){this._dragging=true;var A=this._applyBarTransform([z,y],true);this._updateInterval(B,A[0]);this._updateView();if(this.dataZoomModel.get("realtime")){this._dispatchZoomAction()}},_onDragEnd:function(){this._dragging=false;this._showDataInfo(false);this._dispatchZoomAction()},_dispatchZoomAction:function(){var y=this._range;this.api.dispatchAction({type:"dataZoom",from:this.uid,dataZoomId:this.dataZoomModel.id,start:y[0],end:y[1]})},_applyBarTransform:function(z,y){var A=this._displayables.barGroup.getLocalTransform();return n.applyTransform(z,A,y)},_findCoordRect:function(){var B=this.getTargetInfo();var A;if(B.cartesians.length){A=B.cartesians[0].model.coordinateSystem.getRect()}else{var z=this.api.getWidth();var y=this.api.getHeight();A={x:z*0.2,y:y*0.2,width:z*0.6,height:y*0.6}}return A}});function m(y){return y==="x"?"y":"x"}return b});