define(function(g){var j=g("zrender/core/util");var h=g("../../util/graphic");var q=g("../../util/layout");var i=g("./TimelineView");var c=g("./TimelineAxis");var e=g("../../util/symbol");var r=g("../../coord/axisHelper");var a=g("zrender/core/BoundingRect");var p=g("zrender/core/matrix");var f=g("../../util/number");var m=g("../../util/format");var d=m.encodeHTML;var t=j.bind;var b=j.each;var l=Math.PI;return i.extend({type:"timeline.slider",init:function(u,v){this.api=v;this._axis;this._viewRect;this._timer;this._currentPointer;this._mainGroup;this._labelGroup},render:function(z,u,y,B){this.model=z;this.api=y;this.ecModel=u;this.group.removeAll();if(z.get("show",true)){var A=this._layout(z,y);var w=this._createGroup("mainGroup");var v=this._createGroup("labelGroup");var x=this._axis=this._createAxis(A,z);z.formatTooltip=function(C){return d(x.scale.getLabel(C))};b(["AxisLine","AxisTick","Control","CurrentPointer"],function(C){this["_render"+C](A,w,x,z)},this);this._renderAxisLabel(A,v,x,z);this._position(A,z)}this._doPlayStop()},remove:function(){this._clearTimer();this.group.removeAll()},dispose:function(){this._clearTimer()},_layout:function(B,F){var w=B.get("label.normal.position");var C=B.get("orient");var M=n(B,F);if(w==null||w==="auto"){w=C==="horizontal"?((M.y+M.height/2)<F.getHeight()/2?"-":"+"):((M.x+M.width/2)<F.getWidth()/2?"+":"-")}else{if(isNaN(w)){w=({horizontal:{top:"-",bottom:"+"},vertical:{left:"-",right:"+"}})[C][w]}}var J={horizontal:"center",vertical:(w>=0||w==="+")?"left":"right"};var y={horizontal:(w>=0||w==="+")?"top":"bottom",vertical:"middle"};var S={horizontal:0,vertical:l/2};var v=C==="vertical"?M.height:M.width;var H=B.getModel("controlStyle");var A=H.get("show");var G=A?H.get("itemSize"):0;var O=A?H.get("itemGap"):0;var Q=G+O;var N=B.get("label.normal.rotate")||0;N=N*l/180;var P;var x;var L;var z;var I=H.get("position",true);var A=H.get("show",true);var E=A&&H.get("showPlayBtn",true);var K=A&&H.get("showPrevBtn",true);var u=A&&H.get("showNextBtn",true);var D=0;var R=v;if(I==="left"||I==="bottom"){E&&(P=[0,0],D+=Q);K&&(x=[D,0],D+=Q);u&&(L=[R-G,0],R-=Q)}else{E&&(P=[R-G,0],R-=Q);K&&(x=[0,0],D+=Q);u&&(L=[R-G,0],R-=Q)}z=[D,R];if(B.get("inverse")){z.reverse()}return{viewRect:M,mainLength:v,orient:C,rotation:S[C],labelRotation:N,labelPosOpt:w,labelAlign:J[C],labelBaseline:y[C],playPosition:P,prevBtnPosition:x,nextBtnPosition:L,axisExtent:z,controlSize:G,controlGap:O}},_position:function(F,B){var y=this._mainGroup;var E=this._labelGroup;var I=F.viewRect;if(F.orient==="vertical"){var H=p.create();var v=I.x;var u=I.y+I.height;p.translate(H,H,[-v,-u]);p.rotate(H,H,-l/2);p.translate(H,H,[v,u]);I=I.clone();I.applyTransform(H)}var w=C(I);var L=C(y.getBoundingRect());var z=C(E.getBoundingRect());var K=y.position;var J=E.position;J[0]=K[0]=w[0][0];var x=F.labelPosOpt;if(isNaN(x)){var D=x==="+"?0:1;A(K,L,w,1,D);A(J,z,w,1,1-D)}else{var D=x>=0?0:1;A(K,L,w,1,D);J[1]=K[1]+x}y.position=K;E.position=J;y.rotation=E.rotation=F.rotation;G(y);G(E);function G(M){var N=M.position;M.origin=[w[0][0]-N[0],w[1][0]-N[1]]}function C(M){return[[M.x,M.x+M.width],[M.y,M.y+M.height]]}function A(O,Q,P,N,M){O[N]+=P[N][M]-Q[N][M]}},_createAxis:function(z,w){var y=w.getData();var u=w.get("axisType");var A=r.createScaleByModel(w,u);var x=y.getDataExtent("value");A.setExtent(x[0],x[1]);this._customizeScale(A,y);A.niceTicks();var v=new c("value",A,z.axisExtent,u);v.model=w;return v},_customizeScale:function(v,u){v.getTicks=function(){return u.mapArray(["value"],function(w){return w})};v.getTicksLabels=function(){return j.map(this.getTicks(),v.getLabel,v)}},_createGroup:function(u){var v=this["_"+u]=new h.Group();this.group.add(v);return v},_renderAxisLine:function(x,w,u,v){var y=u.getExtent();if(!v.get("lineStyle.show")){return}w.add(new h.Line({shape:{x1:y[0],y1:0,x2:y[1],y2:0},style:j.extend({lineCap:"round"},v.getModel("lineStyle").getLineStyle()),silent:true,z2:1}))},_renderAxisTick:function(z,y,u,w){var x=w.getData();var v=u.scale.getTicks();b(v,function(H,C){var F=u.dataToCoord(H);var E=x.getItemModel(C);var G=E.getModel("itemStyle.normal");var B=E.getModel("itemStyle.emphasis");var A={position:[F,0],onclick:t(this._changeTimeline,this,C)};var D=o(E,G,y,A);h.setHoverStyle(D,B.getItemStyle());if(E.get("tooltip")){D.dataIndex=C;D.dataModel=w}else{D.dataIndex=D.dataModel=null}},this)},_renderAxisLabel:function(x,B,w,u){var C=u.getModel("label.normal");if(!C.get("show")){return}var y=u.getData();var A=w.scale.getTicks();var z=r.getFormattedLabels(w,C.get("formatter"));var v=w.getLabelInterval();b(A,function(F,E){if(w.isLabelIgnored(E,v)){return}var I=y.getItemModel(E);var D=I.getModel("label.normal.textStyle");var J=I.getModel("label.emphasis.textStyle");var H=w.dataToCoord(F);var G=new h.Text({style:{text:z[E],textAlign:x.labelAlign,textVerticalAlign:x.labelBaseline,textFont:D.getFont(),fill:D.getTextColor()},position:[H,0],rotation:x.labelRotation-x.rotation,onclick:t(this._changeTimeline,this,E),silent:false});B.add(G);h.setHoverStyle(G,J.getItemStyle())},this)},_renderControl:function(w,E,v,u){var z=w.controlSize;var F=w.rotation;var B=u.getModel("controlStyle.normal").getItemStyle();var x=u.getModel("controlStyle.emphasis").getItemStyle();var C=[0,-z/2,z,z];var D=u.getPlayState();var y=u.get("inverse",true);A(w.nextBtnPosition,"controlStyle.nextIcon",t(this._changeTimeline,this,y?"-":"+"));A(w.prevBtnPosition,"controlStyle.prevIcon",t(this._changeTimeline,this,y?"+":"-"));A(w.playPosition,"controlStyle."+(D?"stopIcon":"playIcon"),t(this._handlePlayClick,this,!D),true);function A(G,K,H,L){if(!G){return}var J={position:G,origin:[z/2,0],rotation:L?-F:0,rectHover:true,style:B,onclick:H};var I=k(u,K,C,J);E.add(I);h.setHoverStyle(I,x)}},_renderCurrentPointer:function(x,B,w,u){var y=u.getData();var z=u.getCurrentIndex();var v=y.getItemModel(z).getModel("checkpointStyle");var A=this;var C={onCreate:function(D){D.draggable=true;D.drift=t(A._handlePointerDrag,A);D.ondragend=t(A._handlePointerDragend,A);s(D,z,w,u,true)},onUpdate:function(D){s(D,z,w,u)}};this._currentPointer=o(v,v,this._mainGroup,{},this._currentPointer,C)},_handlePlayClick:function(u){this._clearTimer();this.api.dispatchAction({type:"timelinePlayChange",playState:u,from:this.uid})},_handlePointerDrag:function(v,u,w){this._clearTimer();this._pointerChangeTimeline([w.offsetX,w.offsetY])},_handlePointerDragend:function(u){this._pointerChangeTimeline([u.offsetX,u.offsetY],true)},_pointerChangeTimeline:function(u,v){var w=this._toAxisCoord(u)[0];var x=this._axis;var A=f.asc(x.getExtent().slice());w>A[1]&&(w=A[1]);w<A[0]&&(w=A[0]);this._currentPointer.position[0]=w;this._currentPointer.dirty();var z=this._findNearestTick(w);var y=this.model;if(v||(z!==y.getCurrentIndex()&&y.get("realtime"))){this._changeTimeline(z)}},_doPlayStop:function(){this._clearTimer();if(this.model.getPlayState()){this._timer=setTimeout(t(u,this),this.model.get("playInterval"))}function u(){var v=this.model;this._changeTimeline(v.getCurrentIndex()+(v.get("rewind",true)?-1:1))}},_toAxisCoord:function(v){var u=this._mainGroup.getLocalTransform();return h.applyTransform(v,u,true)},_findNearestTick:function(u){var w=this.model.getData();var y=Infinity;var x;var v=this._axis;w.each(["value"],function(A,z){var C=v.dataToCoord(A);var B=Math.abs(C-u);if(B<y){y=B;x=z}});return x},_clearTimer:function(){if(this._timer){clearTimeout(this._timer);this._timer=null}},_changeTimeline:function(u){var v=this.model.getCurrentIndex();if(u==="+"){u=v+1}else{if(u==="-"){u=v-1}}this.api.dispatchAction({type:"timelineChange",currentIndex:u,from:this.uid})}});function n(u,v){return q.getLayoutRect(u.getBoxLayoutParams(),{width:v.getWidth(),height:v.getHeight()},u.get("padding"))}function k(y,u,x,w){var v=h.makePath(y.get(u).replace(/^path:\/\//,""),j.clone(w||{}),new a(x[0],x[1],x[2],x[3]),"center");return v}function o(v,z,B,u,x,D){var E=v.get("symbol");var y=z.get("color");var w=v.get("symbolSize");var C=w/2;var A=z.getItemStyle(["color","symbol","symbolSize"]);if(!x){x=e.createSymbol(E,-C,-C,w,w,y);B.add(x);D&&D.onCreate(x)}else{x.setStyle(A);x.setColor(y);B.add(x);D&&D.onUpdate(x)}u=j.merge({rectHover:true,style:A,z2:100},u,true);x.attr(u);return x}function s(A,x,y,z,v){if(A.dragging){return}var u=z.getModel("checkpointStyle");var w=y.dataToCoord(z.getData().get(["value"],x));if(v||!u.get("animation",true)){A.attr({position:[w,0]})}else{A.stopAnimation(true);A.animateTo({position:[w,0]},u.get("animationDuration",true),u.get("animationEasing",true))}}});