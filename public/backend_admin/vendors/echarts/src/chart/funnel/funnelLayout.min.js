define(function(a){var e=a("../../util/layout");var d=a("../../util/number");var c=d.parsePercent;function g(h,i){return e.getLayoutRect(h.getBoxLayoutParams(),{width:i.getWidth(),height:i.getHeight()})}function f(m,l){var j=m.mapArray("value",function(i){return i});var o=[];var n=l==="ascending";for(var k=0,h=m.count();k<h;k++){o[k]=k}o.sort(function(p,i){return n?j[p]-j[i]:j[i]-j[p]});return o}function b(h){h.each(function(v){var x=h.getItemModel(v);var y=x.getModel("label.normal");var o=y.get("position");var l=x.getModel("labelLine.normal");var p=h.getItemLayout(v);var w=p.points;var q=o==="inner"||o==="inside"||o==="center";var k;var n;var m;var t;if(q){n=(w[0][0]+w[1][0]+w[2][0]+w[3][0])/4;m=(w[0][1]+w[1][1]+w[2][1]+w[3][1])/4;k="center";t=[[n,m],[n,m]]}else{var j;var s;var i;var u=l.get("length");if(o==="left"){j=(w[3][0]+w[0][0])/2;s=(w[3][1]+w[0][1])/2;i=j-u;n=i-5;k="right"}else{j=(w[1][0]+w[2][0])/2;s=(w[1][1]+w[2][1])/2;i=j+u;n=i+5;k="left"}var r=s;t=[[j,s],[i,r]];m=r}p.label={linePoints:t,x:n,y:m,verticalAlign:"middle",textAlign:k,inside:q}})}return function(h,i){h.eachSeriesByType("funnel",function(s){var C=s.getData();var A=s.get("sort");var w=g(s,i);var m=f(C,A);var o=[c(s.get("minSize"),w.width),c(s.get("maxSize"),w.width)];var t=C.getDataExtent("value");var u=s.get("min");var x=s.get("max");if(u==null){u=Math.min(t[0],0)}if(x==null){x=t[1]}var j=s.get("funnelAlign");var r=s.get("gap");var v=(w.height-r*(C.count()-1))/C.count();var n=w.y;var q=function(D,y){var G=C.get("value",D)||0;var F=d.linearMap(G,[u,x],o,true);var E;switch(j){case"left":E=w.x;break;case"center":E=w.x+(w.width-F)/2;break;case"right":E=w.x+w.width-F;break}return[[E,y],[E+F,y]]};if(A==="ascending"){v=-v;r=-r;n+=w.height;m=m.reverse()}for(var z=0;z<m.length;z++){var p=m[z];var B=m[z+1];var l=q(p,n);var k=q(B,n+v);n+=v+r;C.setItemLayout(p,{points:l.concat(k.slice().reverse())})}b(C)})}});