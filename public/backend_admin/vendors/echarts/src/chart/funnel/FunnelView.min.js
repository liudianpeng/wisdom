define(function(b){var h=b("../../util/graphic");var a=b("zrender/core/util");function d(m,k){h.Group.call(this);var l=new h.Polygon();var o=new h.Polyline();var n=new h.Text();this.add(l);this.add(o);this.add(n);this.updateData(m,k,true);function j(){o.ignore=o.hoverIgnore;n.ignore=n.hoverIgnore}function i(){o.ignore=o.normalIgnore;n.ignore=n.normalIgnore}this.on("emphasis",j).on("normal",i).on("mouseover",j).on("mouseout",i)}var e=d.prototype;function c(n,j,m,o){var k=o.getModel("textStyle");var i=o.get("position");var l=i==="inside"||i==="inner"||i==="center";return{fill:k.getTextColor()||(l?"#fff":n.getItemVisual(j,"color")),textFont:k.getFont(),text:a.retrieve(n.hostModel.getFormattedLabel(j,m),n.getName(j))}}var f=["itemStyle","normal","opacity"];e.updateData=function(k,p,n){var o=this.childAt(0);var i=k.hostModel;var r=k.getItemModel(p);var l=k.getItemLayout(p);var m=k.getItemModel(p).get(f);m=m==null?1:m;o.useStyle({});if(n){o.setShape({points:l.points});o.setStyle({opacity:0});h.initProps(o,{style:{opacity:m}},i,p)}else{h.updateProps(o,{style:{opacity:m},shape:{points:l.points}},i,p)}var j=r.getModel("itemStyle");var q=k.getItemVisual(p,"color");o.setStyle(a.defaults({fill:q},j.getModel("normal").getItemStyle(["opacity"])));o.hoverStyle=j.getModel("emphasis").getItemStyle();this._updateLabel(k,p);h.setHoverStyle(this)};e._updateLabel=function(n,q){var m=this.childAt(1);var j=this.childAt(2);var k=n.hostModel;var s=n.getItemModel(q);var p=n.getItemLayout(q);var u=p.label;var r=n.getItemVisual(q,"color");h.updateProps(m,{shape:{points:u.linePoints||u.linePoints}},k,q);h.updateProps(j,{style:{x:u.x,y:u.y}},k,q);j.attr({style:{textAlign:u.textAlign,textVerticalAlign:u.verticalAlign,textFont:u.font},rotation:u.rotation,origin:[u.x,u.y],z2:10});var t=s.getModel("label.normal");var o=s.getModel("label.emphasis");var l=s.getModel("labelLine.normal");var i=s.getModel("labelLine.emphasis");j.setStyle(c(n,q,"normal",t));j.ignore=j.normalIgnore=!t.get("show");j.hoverIgnore=!o.get("show");m.ignore=m.normalIgnore=!l.get("show");m.hoverIgnore=!i.get("show");m.setStyle({stroke:r});m.setStyle(l.getModel("lineStyle").getLineStyle());j.hoverStyle=c(n,q,"emphasis",o);m.hoverStyle=i.getModel("lineStyle").getLineStyle()};a.inherits(d,h.Group);var g=b("../../view/Chart").extend({type:"funnel",render:function(j,i,k){var l=j.getData();var n=this._data;var m=this.group;l.diff(n).add(function(o){var p=new d(l,o);l.setItemGraphicEl(o,p);m.add(p)}).update(function(q,p){var o=n.getItemGraphicEl(p);o.updateData(l,q);m.add(o);l.setItemGraphicEl(q,o)}).remove(function(o){var p=n.getItemGraphicEl(o);m.remove(p)}).execute();this._data=l},remove:function(){this.group.removeAll();this._data=null}});return g});