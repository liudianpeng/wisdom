define(function(e){var m=e("../../util/symbol");var c=e("zrender/core/vector");var i=e("./LinePath");var a=e("../../util/graphic");var f=e("zrender/core/util");var b=e("../../util/number");var d=["fromSymbol","toSymbol"];function k(p){return"_"+p+"Type"}function j(s,v,q){var r=v.getItemVisual(q,"color");var u=v.getItemVisual(q,s);var t=v.getItemVisual(q,s+"Size");if(!u||u==="none"){return}if(!f.isArray(t)){t=[t,t]}var p=m.createSymbol(u,-t[0]/2,-t[1]/2,t[0],t[1],r);p.name=s;return p}function h(q){var p=new i({name:"line"});l(p.shape,q);return p}function l(p,q){var t=q[0];var r=q[1];var s=q[2];p.x1=t[0];p.y1=t[1];p.x2=r[0];p.y2=r[1];p.percent=1;if(s){p.cpx1=s[0];p.cpy1=s[1]}}function o(){var G=this;var p=G.childOfName("fromSymbol");var I=G.childOfName("toSymbol");var x=G.childOfName("label");if(!p&&!I&&x.ignore){return}var r=1;var y=this.parent;while(y){if(y.scale){r/=y.scale[0]}y=y.parent}var A=G.childOfName("line");if(!this.__dirty&&!A.__dirty){return}var q=A.shape.percent;var F=A.pointAt(0);var E=A.pointAt(q);var H=c.sub([],E,F);c.normalize(H,H);if(p){p.attr("position",F);var z=A.tangentAt(0);p.attr("rotation",Math.PI/2-Math.atan2(z[1],z[0]));p.attr("scale",[r*q,r*q])}if(I){I.attr("position",E);var z=A.tangentAt(1);I.attr("rotation",-Math.PI/2-Math.atan2(z[1],z[0]));I.attr("scale",[r*q,r*q])}if(!x.ignore){x.attr("position",E);var u;var v;var B;var t=5*r;if(x.__position==="end"){u=[H[0]*t+E[0],H[1]*t+E[1]];v=H[0]>0.8?"left":(H[0]<-0.8?"right":"center");B=H[1]>0.8?"top":(H[1]<-0.8?"bottom":"middle")}else{if(x.__position==="middle"){var s=q/2;var z=A.tangentAt(s);var C=[z[1],-z[0]];var w=A.pointAt(s);if(C[1]>0){C[0]=-C[0];C[1]=-C[1]}u=[w[0]+C[0]*t,w[1]+C[1]*t];v="center";B="bottom";var D=-Math.atan2(z[1],z[0]);if(E[0]<F[0]){D=Math.PI+D}x.attr("rotation",D)}else{u=[-H[0]*t+F[0],-H[1]*t+F[1]];v=H[0]>0.8?"right":(H[0]<-0.8?"left":"center");B=H[1]>0.8?"bottom":(H[1]<-0.8?"top":"middle")}}x.attr({style:{textVerticalAlign:x.__verticalAlign||B,textAlign:x.__textAlign||v},position:u,scale:[r,r]})}}function g(q,p){a.Group.call(this);this._createLine(q,p)}var n=g.prototype;n.beforeUpdate=o;n._createLine=function(u,p){var r=u.hostModel;var t=u.getItemLayout(p);var q=h(t);q.shape.percent=0;a.initProps(q,{shape:{percent:1}},r,p);this.add(q);var s=new a.Text({name:"label"});this.add(s);f.each(d,function(v){var w=j(v,u,p);this.add(w);this[k(v)]=u.getItemVisual(p,v)},this);this._updateCommonStl(u,p)};n.updateData=function(u,p){var r=u.hostModel;var q=this.childOfName("line");var t=u.getItemLayout(p);var s={shape:{}};l(s.shape,t);a.updateProps(q,s,r,p);f.each(d,function(w){var y=u.getItemVisual(p,w);var v=k(w);if(this[v]!==y){var x=j(w,u,p);this.remove(this.childOfName(w));this.add(x)}this[v]=y},this);this._updateCommonStl(u,p)};n._updateCommonStl=function(q,x){var r=q.hostModel;var A=this.childOfName("line");var y=q.getItemModel(x);var z=y.getModel("label.normal");var u=z.getModel("textStyle");var s=y.getModel("label.emphasis");var w=s.getModel("textStyle");var t=b.round(r.getRawValue(x));if(isNaN(t)){t=q.getName(x)}A.useStyle(f.extend({strokeNoScale:true,fill:"none",stroke:q.getItemVisual(x,"color")},y.getModel("lineStyle.normal").getLineStyle()));A.hoverStyle=y.getModel("lineStyle.emphasis").getLineStyle();var p=q.getItemVisual(x,"color")||"#000";var v=this.childOfName("label");v.setStyle({text:z.get("show")?f.retrieve(r.getFormattedLabel(x,"normal",q.dataType),t):"",textFont:u.getFont(),fill:u.getTextColor()||p});v.hoverStyle={text:s.get("show")?f.retrieve(r.getFormattedLabel(x,"emphasis",q.dataType),t):"",textFont:w.getFont(),fill:w.getTextColor()||p};v.__textAlign=u.get("align");v.__verticalAlign=u.get("baseline");v.__position=z.get("position");v.ignore=!v.style.text&&!v.hoverStyle.text;a.setHoverStyle(this)};n.updateLayout=function(s,q){var r=s.getItemLayout(q);var p=this.childOfName("line");l(p.shape,r);p.dirty(true)};n.setLinePoints=function(q){var p=this.childOfName("line");l(p.shape,q);p.dirty()};f.inherits(g,a.Group);return g});