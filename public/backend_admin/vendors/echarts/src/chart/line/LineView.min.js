define(function(d){var e=d("zrender/core/util");var q=d("../helper/SymbolDraw");var k=d("../helper/Symbol");var g=d("./lineAnimationDiff");var a=d("../../util/graphic");var i=d("./poly");var p=d("../../view/Chart");function c(s,r){if(s.length!==r.length){return}for(var t=0;t<s.length;t++){var v=s[t];var u=r[t];if(v[0]!==u[0]||v[1]!==u[1]){return}}return true}function o(r){return typeof(r)==="number"?r:(r?0.3:0)}function n(u){var t=u.getGlobalExtent();if(u.onBand){var r=u.getBandWidth()/2-1;var s=t[1]>t[0]?1:-1;t[0]+=s*r;t[1]-=s*r}return t}function b(r){return r>=0?1:-1}function f(s,v){var u=s.getBaseAxis();var x=s.getOtherAxis(u);var t=u.onZero?0:x.scale.getExtent()[0];var w=x.dim;var r=w==="x"||w==="radius"?1:0;return v.mapArray([w],function(C,y){var z;var B=v.stackedOn;while(B&&b(B.get(w,y))===b(C)){z=B;break}var A=[];A[r]=v.get(u.dim,y);A[1-r]=z?z.get(w,y,true):t;return s.dataToPoint(A)},true)}function h(r,s){if(s.dataIndex!=null){return s.dataIndex}else{if(s.name!=null){return r.indexOfName(s.name)}}}function m(v,z,t){var s=n(v.getAxis("x"));var A=n(v.getAxis("y"));var D=v.getBaseAxis().isHorizontal();var E=Math.min(s[0],s[1]);var C=Math.min(A[0],A[1]);var r=Math.max(s[0],s[1])-E;var F=Math.max(A[0],A[1])-C;var w=t.get("lineStyle.normal.width")||2;var u=t.get("clipOverflow")?w/2:Math.max(r,F);if(D){C-=u;F+=u*2}else{E-=u;r+=u*2}var B=new a.Rect({shape:{x:E,y:C,width:r,height:F}});if(z){B.shape[D?"width":"height"]=0;a.initProps(B,{shape:{width:r,height:F}},t)}return B}function l(r,v,s){var z=r.getAngleAxis();var t=r.getRadiusAxis();var u=t.getExtent();var y=z.getExtent();var x=Math.PI/180;var w=new a.Sector({shape:{cx:r.cx,cy:r.cy,r0:u[0],r:u[1],startAngle:-y[0]*x,endAngle:-y[1]*x,clockwise:z.inverse}});if(v){w.shape.endAngle=-y[0]*x;a.initProps(w,{shape:{endAngle:-y[1]*x}},s)}return w}function j(s,t,r){return s.type==="polar"?l(s,t,r):m(s,t,r)}return p.extend({type:"line",init:function(){var s=new a.Group();var r=new q();this.group.add(r.group);this._symbolDraw=r;this._lineGroup=s},render:function(G,P,C){var w=G.coordinateSystem;var x=this.group;var O=G.getData();var H=G.getModel("lineStyle.normal");var B=G.getModel("areaStyle.normal");var J=O.mapArray(O.getItemLayout,true);var L=w.type==="polar";var y=this._coordSys;var K=this._symbolDraw;var F=this._polyline;var A=this._polygon;var I=this._lineGroup;var t=G.get("animation");var u=!B.isEmpty();var v=f(w,O);var z=G.get("showSymbol");var D=z&&!L&&!G.get("showAllSymbol")&&this._getSymbolIgnoreFunc(O,w);var N=this._data;N&&N.eachItemGraphicEl(function(R,Q){if(R.__temp){x.remove(R);N.setItemGraphicEl(Q,null)}});if(!z){K.remove()}x.add(I);if(!(F&&y.type===w.type)){z&&K.updateData(O,D);F=this._newPolyline(J,w,t);if(u){A=this._newPolygon(J,v,w,t)}I.setClipPath(j(w,true,G))}else{if(u&&!A){A=this._newPolygon(J,v,w,t)}else{if(A&&!u){I.remove(A);A=this._polygon=null}}I.setClipPath(j(w,false,G));z&&K.updateData(O,D);O.eachItemGraphicEl(function(Q){Q.stopAnimation(true)});if(!c(this._stackedOnPoints,v)||!c(this._points,J)){if(t){this._updateAnimation(O,v,w,C)}else{F.setShape({points:J});A&&A.setShape({points:J,stackedOnPoints:v})}}}F.useStyle(e.defaults(H.getLineStyle(),{fill:"none",stroke:O.getVisual("color"),lineJoin:"bevel"}));var E=G.get("smooth");E=o(G.get("smooth"));F.setShape({smooth:E,smoothMonotone:G.get("smoothMonotone"),connectNulls:G.get("connectNulls")});if(A){var r=O.stackedOn;var s=0;A.useStyle(e.defaults(B.getAreaStyle(),{fill:O.getVisual("color"),opacity:0.7,lineJoin:"bevel"}));if(r){var M=r.hostModel;s=o(M.get("smooth"))}A.setShape({smooth:E,stackedOnSmooth:s,smoothMonotone:G.get("smoothMonotone"),connectNulls:G.get("connectNulls")})}this._data=O;this._coordSys=w;this._stackedOnPoints=v;this._points=J},highlight:function(s,r,u,y){var w=s.getData();var t=h(w,y);if(t!=null&&t>=0){var v=w.getItemGraphicEl(t);if(!v){var x=w.getItemLayout(t);v=new k(w,t,u);v.position=x;v.setZ(s.get("zlevel"),s.get("z"));v.ignore=isNaN(x[0])||isNaN(x[1]);v.__temp=true;w.setItemGraphicEl(t,v);v.stopSymbolAnimation(true);this.group.add(v)}v.highlight()}else{p.prototype.highlight.call(this,s,r,u,y)}},downplay:function(s,r,u,x){var w=s.getData();var t=h(w,x);if(t!=null&&t>=0){var v=w.getItemGraphicEl(t);if(v){if(v.__temp){w.setItemGraphicEl(t,null);this.group.remove(v)}else{v.downplay()}}}else{p.prototype.downplay.call(this,s,r,u,x)}},_newPolyline:function(s){var r=this._polyline;if(r){this._lineGroup.remove(r)}r=new i.Polyline({shape:{points:s},silent:true,z2:10});this._lineGroup.add(r);this._polyline=r;return r},_newPolygon:function(t,r){var s=this._polygon;if(s){this._lineGroup.remove(s)}s=new i.Polygon({shape:{points:t,stackedOnPoints:r},silent:true});this._lineGroup.add(s);this._polygon=s;return s},_getSymbolIgnoreFunc:function(s,r){var t=r.getAxesByScale("ordinal")[0];if(t&&t.isLabelIgnored){return e.bind(t.isLabelIgnored,t)}},_updateAnimation:function(y,z,w,A){var C=this._polyline;var B=this._polygon;var v=y.hostModel;var D=g(this._data,y,this._stackedOnPoints,z,this._coordSys,w);C.shape.points=D.current;a.updateProps(C,{shape:{points:D.next}},v);if(B){B.setShape({points:D.current,stackedOnPoints:D.stackedOnCurrent});a.updateProps(B,{shape:{points:D.next,stackedOnPoints:D.stackedOnNext}},v)}var u=[];var r=D.status;for(var x=0;x<r.length;x++){var t=r[x].cmd;if(t==="="){var s=y.getItemGraphicEl(r[x].idx1);if(s){u.push({el:s,ptIdx:x})}}}if(C.animators&&C.animators.length){C.animators[0].during(function(){for(var E=0;E<u.length;E++){var F=u[E].el;F.attr("position",C.shape.points[u[E].ptIdx])}})}},remove:function(r){var s=this.group;var t=this._data;this._lineGroup.removeAll();this._symbolDraw.remove(true);t&&t.eachItemGraphicEl(function(v,u){if(v.__temp){s.remove(v);t.setItemGraphicEl(u,null)}});this._polyline=this._polygon=this._coordSys=this._points=this._stackedOnPoints=this._data=null}})});