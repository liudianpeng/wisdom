define(function(a){var f=a("../helper/SymbolDraw");var c=a("../helper/LineDraw");var b=a("../../component/helper/RoamController");var e=a("../../util/graphic");var d=a("./adjustEdge");a("../../echarts").extendChartView({type:"graph",init:function(g,k){var j=new f();var i=new c();var l=this.group;var h=new b(k.getZr(),l);l.add(j.group);l.add(i.group);this._symbolDraw=j;this._lineDraw=i;this._controller=h;this._firstRender=true},render:function(h,k,l){var i=h.coordinateSystem;this._model=h;this._nodeScaleRatio=h.get("nodeScaleRatio");var g=this._symbolDraw;var n=this._lineDraw;var q=this.group;if(i.type==="view"){var o={position:i.position,scale:i.scale};if(this._firstRender){q.attr(o)}else{e.updateProps(q,o,h)}}d(h.getGraph(),this._getNodeGlobalScale(h));var j=h.getData();g.updateData(j);var m=h.getEdgeData();n.updateData(m);this._updateNodeAndLinkScale();this._updateController(h,l);clearTimeout(this._layoutTimeout);var p=h.forceLayout;var r=h.get("force.layoutAnimation");if(p){this._startForceLayoutIteration(p,r)}j.eachItemGraphicEl(function(u,t){var s=j.getItemModel(t).get("draggable");if(s){u.on("drag",function(){if(p){p.warmUp();!this._layouting&&this._startForceLayoutIteration(p,r);p.setFixed(t);j.setItemLayout(t,u.position)}},this).on("dragend",function(){if(p){p.setUnfixed(t)}},this)}else{u.off("drag")}u.setDraggable(s&&p)},this);this._firstRender=false},_startForceLayoutIteration:function(j,i){var g=this;(function h(){j.step(function(k){g.updateLayout(g._model);(g._layouting=!k)&&(i?(g._layoutTimeout=setTimeout(h,16)):h())})})()},_updateController:function(h,i){var g=this._controller;var j=this.group;g.rectProvider=function(){var k=j.getBoundingRect();k.applyTransform(j.transform);return k};if(h.coordinateSystem.type!=="view"){g.disable();return}g.enable(h.get("roam"));g.zoomLimit=h.get("scaleLimit");g.zoom=h.coordinateSystem.getZoom();g.off("pan").off("zoom").on("pan",function(l,k){i.dispatchAction({seriesId:h.id,type:"graphRoam",dx:l,dy:k})}).on("zoom",function(m,l,k){i.dispatchAction({seriesId:h.id,type:"graphRoam",zoom:m,originX:l,originY:k});this._updateNodeAndLinkScale();d(h.getGraph(),this._getNodeGlobalScale(h));this._lineDraw.updateLayout()},this)},_updateNodeAndLinkScale:function(){var g=this._model;var j=g.getData();var h=this._getNodeGlobalScale(g);var i=[h,h];j.eachItemGraphicEl(function(l,k){l.attr("scale",i)})},_getNodeGlobalScale:function(i){var j=i.coordinateSystem;if(j.type!=="view"){return 1}var m=this._nodeScaleRatio;var h=this.group.scale;var g=(h&&h[0])||1;var l=j.getZoom();var k=(l-1)*m+1;return k/g},updateLayout:function(g){this._symbolDraw.updateLayout();this._lineDraw.updateLayout();d(g.getGraph(),this._getNodeGlobalScale(g))},remove:function(g,h){this._symbolDraw&&this._symbolDraw.remove();this._lineDraw&&this._lineDraw.remove()}})});