define(function(m){var t=m("../../util/layout");var y=m("../../util/array/nest");var o=m("zrender/core/util");return function(z,A){z.eachSeriesByType("sankey",function(G){var J=G.get("nodeWidth");var I=G.get("nodeGap");var F=q(G,A);G.layoutInfo=F;var C=F.width;var L=F.height;var K=G.getGraph();var B=K.nodes;var H=K.edges;l(B);var D=B.filter(function(M){return M.getLayout().value===0});var E=D.length!==0?0:G.get("layoutIterations");w(B,H,J,I,C,L,E)})};function q(z,A){return t.getLayoutRect(z.getBoxLayoutParams(),{width:A.getWidth(),height:A.getHeight()})}function w(C,B,A,F,D,z,E){a(C,A,D);e(C,B,z,F,E);d(C)}function l(z){o.each(z,function(C){var B=c(C.outEdges,k);var A=c(C.inEdges,k);var D=Math.max(B,A);C.setLayout({value:D},true)})}function a(A,J,B){var z=A;var D=null;var I=0;var H=0;while(z.length){D=[];for(var F=0,G=z.length;F<G;F++){var C=z[F];C.setLayout({x:I},true);C.setLayout({dx:J},true);for(var E=0,K=C.outEdges.length;E<K;E++){D.push(C.outEdges[E].node2)}}z=D;++I}r(A,I);H=(B-J)/(I-1);p(A,H)}function r(A,z){o.each(A,function(B){if(!B.outEdges.length){B.setLayout({x:z-1},true)}})}function p(z,A){o.each(z,function(B){var C=B.getLayout().x*A;B.setLayout({x:C},true)})}function e(C,B,z,F,D){var A=y().key(function(G){return G.getLayout().x}).sortKeys(f).entries(C).map(function(G){return G.values});i(C,A,B,z,F);b(A,F,z);for(var E=1;D>0;D--){E*=0.99;j(A,E);b(A,F,z);h(A,E);b(A,F,z)}}function i(D,B,C,z,F){var A=[];o.each(B,function(G){var J=G.length;var I=0;o.each(G,function(K){I+=K.getLayout().value});var H=(z-(J-1)*F)/I;A.push(H)});A.sort(function(H,G){return H-G});var E=A[0];o.each(B,function(G){o.each(G,function(J,I){J.setLayout({y:I},true);var H=J.getLayout().value*E;J.setLayout({dy:H},true)})});o.each(C,function(H){var G=+H.getValue()*E;H.setLayout({dy:G},true)})}function b(A,B,z){o.each(A,function(D){var H;var C;var G=0;var I=D.length;var E;D.sort(s);for(E=0;E<I;E++){H=D[E];C=G-H.getLayout().y;if(C>0){var F=H.getLayout().y+C;H.setLayout({y:F},true)}G=H.getLayout().y+H.getLayout().dy+B}C=G-B-z;if(C>0){var F=H.getLayout().y-C;H.setLayout({y:F},true);G=H.getLayout().y;for(E=I-2;E>=0;--E){H=D[E];C=H.getLayout().y+H.getLayout().dy+B-G;if(C>0){F=H.getLayout().y-C;H.setLayout({y:F},true)}G=H.getLayout().y}}})}function j(z,A){o.each(z.slice().reverse(),function(B){o.each(B,function(D){if(D.outEdges.length){var E=c(D.outEdges,g)/c(D.outEdges,k);var C=D.getLayout().y+(E-u(D))*A;D.setLayout({y:C},true)}})})}function g(z){return u(z.node2)*z.getValue()}function h(z,A){o.each(z,function(B){o.each(B,function(D){if(D.inEdges.length){var E=c(D.inEdges,x)/c(D.inEdges,k);var C=D.getLayout().y+(E-u(D))*A;D.setLayout({y:C},true)}})})}function x(z){return u(z.node1)*z.getValue()}function d(z){o.each(z,function(A){A.outEdges.sort(v);A.inEdges.sort(n)});o.each(z,function(B){var C=0;var A=0;o.each(B.outEdges,function(D){D.setLayout({sy:C},true);C+=D.getLayout().dy});o.each(B.inEdges,function(D){D.setLayout({ty:A},true);A+=D.getLayout().dy})})}function v(A,z){return A.node2.getLayout().y-z.node2.getLayout().y}function n(A,z){return A.node1.getLayout().y-z.node1.getLayout().y}function c(E,C){var B=0;var D=E.length;var z;var A=-1;if(arguments.length===1){while(++A<D){z=+E[A];if(!isNaN(z)){B+=z}}}else{while(++A<D){z=+C.call(E,E[A],A);if(!isNaN(z)){B+=z}}}return B}function u(z){return z.getLayout().y+z.getLayout().dy/2}function s(A,z){return A.getLayout().y-z.getLayout().y}function f(A,z){return A<z?-1:A>z?1:A==z?0:NaN}function k(z){return z.getValue()}});