define(function(b){var g=b("../../util/graphic");var c=b("./HeatmapLayer");var a=b("zrender/core/util");function f(l,i,k){var j=l[1]-l[0];i=a.map(i,function(n){return{interval:[(n.interval[0]-l[0])/j,(n.interval[1]-l[0])/j]}});var h=i.length;var m=0;return function(p){for(var o=m;o<h;o++){var n=i[o].interval;if(n[0]<=p&&p<=n[1]){m=o;break}}if(o===h){for(var o=m-1;o>=0;o--){var n=i[o].interval;if(n[0]<=p&&p<=n[1]){m=o;break}}}return o>=0&&o<h&&k[o]}}function d(j,i){var h=j[1]-j[0];i=[(i[0]-j[0])/h,(i[1]-j[0])/h];return function(k){return k>=i[0]&&k<=i[1]}}function e(h){var i=h.dimensions;return i[0]==="lng"&&i[1]==="lat"}return b("../../echarts").extendChartView({type:"heatmap",render:function(i,h,k){var l;h.eachComponent("visualMap",function(m){m.eachTargetSeries(function(n){if(n===i){l=m}})});if(!l){throw new Error("Heatmap must use with visualMap")}this.group.removeAll();var j=i.coordinateSystem;if(j.type==="cartesian2d"){this._renderOnCartesian(j,i,k)}else{if(e(j)){this._renderOnGeo(j,i,l,k)}}},_renderOnCartesian:function(m,k,n){var j=m.getAxis("x");var h=m.getAxis("y");var o=this.group;if(!(j.type==="category"&&h.type==="category")){throw new Error("Heatmap on cartesian must have two category axes")}if(!(j.onBand&&h.onBand)){throw new Error("Heatmap on cartesian must have two axes with boundaryGap true")}var i=j.getBandWidth();var p=h.getBandWidth();var l=k.getData();l.each(["x","y","z"],function(B,w,t,C){var E=l.getItemModel(C);var D=m.dataToPoint([B,w]);if(isNaN(t)){return}var A=new g.Rect({shape:{x:D[0]-i/2,y:D[1]-p/2,width:i,height:p},style:{fill:l.getItemVisual(C,"color"),opacity:l.getItemVisual(C,"opacity")}});var q=E.getModel("itemStyle.normal").getItemStyle(["color"]);var r=E.getModel("itemStyle.emphasis").getItemStyle();var F=E.getModel("label.normal");var v=E.getModel("label.emphasis");var s=k.getRawValue(C);var u="-";if(s&&s[2]!=null){u=s[2]}if(F.get("show")){g.setText(q,F);q.text=k.getFormattedLabel(C,"normal")||u}if(v.get("show")){g.setText(r,v);r.text=k.getFormattedLabel(C,"emphasis")||u}A.setStyle(q);g.setHoverStyle(A,r);o.add(A);l.setItemGraphicEl(C,A)})},_renderOnGeo:function(C,t,o,r){var l=o.targetVisuals.inRange;var q=o.targetVisuals.outOfRange;var A=t.getData();var m=this._hmLayer||(this._hmLayer||new c());m.blurSize=t.get("blurSize");m.pointSize=t.get("pointSize");m.minOpacity=t.get("minOpacity");m.maxOpacity=t.get("maxOpacity");var i=C.getViewRect().clone();var k=C.getRoamTransform().transform;i.applyTransform(k);var p=Math.max(i.x,0);var n=Math.max(i.y,0);var z=Math.min(i.width+i.x,r.getWidth());var j=Math.min(i.height+i.y,r.getHeight());var u=z-p;var s=j-n;var w=A.mapArray(["lng","lat","value"],function(x,E,y){var D=C.dataToPoint([x,E]);D[0]-=p;D[1]-=n;D.push(y);return D});var v=o.getExtent();var h=o.type==="visualMap.continuous"?d(v,o.option.range):f(v,o.getPieceList(),o.option.selected);m.update(w,u,s,l.color.getNormalizer(),{inRange:l.color.getColorMapper(),outOfRange:q.color.getColorMapper()},h);var B=new g.Image({style:{width:u,height:s,x:p,y:n,image:m.canvas},silent:true});this.group.add(B)}})});