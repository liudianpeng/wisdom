define(function(d){var a=d("../../visual/VisualMapping");var b=d("zrender/tool/color");var e=d("zrender/core/util");var j=e.isArray;var g="itemStyle.normal";return function(o,p){var q={mainType:"series",subType:"treemap",query:p};o.eachComponent(q,function(u){var r=u.getData().tree;var s=r.root;var v=u.getModel(g);if(s.isRemoved()){return}var t=e.map(r.levelModels,function(w){return w?w.get(g):null});k(s,{},t,v,u.getViewRoot().getAncestors(),u)})};function k(s,D,p,C,A,u){var q=s.getModel();var x=s.getLayout();if(!x||x.invisible||!x.isInView){return}var y=s.getModel(g);var z=p[s.depth];var t=n(y,D,z,C);var r=y.get("borderColor");var w=y.get("borderColorSaturation");var v;if(w!=null){v=h(t,s);r=f(w,v)}s.setVisual("borderColor",r);var B=s.viewChildren;if(!B||!B.length){v=h(t,s);s.setVisual("color",v)}else{var o=l(s,q,x,y,t,B);e.each(B,function(G,E){if(G.depth>=A.length||G===A[G.depth]){var F=m(q,t,G,E,o,u);k(G,F,p,C,A,u)}})}}function n(s,o,r,p){var q=e.extend({},o);e.each(["color","colorAlpha","colorSaturation"],function(t){var u=s.get(t,true);u==null&&r&&(u=r[t]);u==null&&(u=o[t]);u==null&&(u=p.get(t));u!=null&&(q[t]=u)});return q}function h(r){var p=i(r,"color");if(p){var q=i(r,"colorAlpha");var o=i(r,"colorSaturation");if(o){p=b.modifyHSL(p,null,null,o)}if(q){p=b.modifyAlpha(p,q)}return p}}function f(p,o){return o!=null?b.modifyHSL(o,null,null,p):null}function i(q,o){var p=q[o];if(p!=null&&p!=="none"){return p}}function l(s,r,v,w,t,x){if(!x||!x.length){return}var p=c(r,"color")||(t.color!=null&&t.color!=="none"&&(c(r,"colorAlpha")||c(r,"colorSaturation")));if(!p){return}var u=r.get("colorMappingBy");var q={type:p.name,dataExtent:v.dataExtent,visual:p.range};if(q.type==="color"&&(u==="index"||u==="id")){q.mappingMethod="category";q.loop=true}else{q.mappingMethod="linear"}var o=new a(q);o.__drColorMappingBy=u;return o}function c(q,p){var o=q.get(p);return(j(o)&&o.length)?{name:p,range:o}:null}function m(r,t,p,w,o,u){var q=e.extend({},t);if(o){var v=o.type;var s=v==="color"&&o.__drColorMappingBy;var x=s==="index"?w:s==="id"?u.mapIdToIndex(p.getId()):p.getValue(r.get("visualDimension"));q[v]=o.mapValueToVisual(x)}return q}});