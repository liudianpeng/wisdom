define(function(k){var o=k("zrender/core/util");var h=k("../../util/number");var s=k("../../util/layout");var a=k("./helper");var e=k("zrender/core/BoundingRect");var a=k("./helper");var m=Math.max;var i=Math.min;var u=h.parsePercent;var b=o.retrieve;var g=o.each;function j(w,x,y){var z={mainType:"series",subType:"treemap",query:y};w.eachComponent(z,function(O){var K=x.getWidth();var B=x.getHeight();var E=O.option;var M=E.size||[];var J=u(b(E.width,M[0]),K);var L=u(b(E.height,M[1]),B);var N=s.getLayoutRect(O.getBoxLayoutParams(),{width:x.getWidth(),height:x.getHeight()});var A=y&&y.type;var I=a.retrieveTargetInfo(y,O);var F=(A==="treemapRender"||A==="treemapMove")?y.rootRect:null;var H=O.getViewRoot();var G=a.getPathToRoot(H);if(A!=="treemapMove"){var Q=A==="treemapZoomToNode"?q(O,I,H,J,L):F?[F.width,F.height]:[J,L];var R=E.sort;if(R&&R!=="asc"&&R!=="desc"){R="desc"}var D={squareRatio:E.squareRatio,sort:R,leafDepth:E.leafDepth};H.hostTree.clearLayouts();var C={x:0,y:0,width:Q[0],height:Q[1],area:Q[0]*Q[1]};H.setLayout(C);c(H,D,false,0);var C=H.getLayout();g(G,function(U,T){var S=(G[T+1]||H).getValue();U.setLayout(o.extend({dataExtent:[S,S],borderWidth:0},C))})}var P=O.getData().tree.root;P.setLayout(d(N,F,I),true);O.setLayoutInfo(N);n(P,new e(-N.x,-N.y,K,B),G,H,0)})}function c(G,z,M,R){var F;var D;if(G.isRemoved()){return}var P=G.getLayout();F=P.width;D=P.height;var w=G.getModel("itemStyle.normal");var S=w.get("borderWidth");var I=w.get("gapWidth")/2;var Q=S-I;var E=G.getModel();G.setLayout({borderWidth:S},true);F=m(F-2*Q,0);D=m(D-2*Q,0);var O=F*D;var H=f(G,E,O,z,M,R);if(!H.length){return}var x={x:Q,y:Q,width:F,height:D};var C=i(F,D);var y=Infinity;var B=[];B.area=0;for(var L=0,N=H.length;L<N;){var A=H[L];B.push(A);B.area+=A.getLayout().area;var K=p(B,C,z.squareRatio);if(K<=y){L++;y=K}else{B.area-=B.pop().getLayout().area;v(B,C,x,I,false);C=i(x.width,x.height);B.length=B.area=0;y=Infinity}}if(B.length){v(B,C,x,I,true)}if(!M){var J=E.get("childrenVisibleMin");if(J!=null&&O<J){M=true}}for(var L=0,N=H.length;L<N;L++){c(H[L],z,M,R+1)}}function f(z,y,H,I,C,B){var G=z.children||[];var E=I.sort;E!=="asc"&&E!=="desc"&&(E=null);var F=I.leafDepth!=null&&I.leafDepth<=B;if(C&&!F){return(z.viewChildren=[])}G=o.filter(G,function(J){return !J.isRemoved()});t(G,E);var x=l(y,G,E);if(x.sum===0){return(z.viewChildren=[])}x.sum=r(y,H,x.sum,E,G);if(x.sum===0){return(z.viewChildren=[])}for(var A=0,D=G.length;A<D;A++){var w=G[A].getValue()/x.sum*H;G[A].setLayout({area:w})}if(F){G.length&&z.setLayout({isLeafRoot:true},true);G.length=0}z.viewChildren=G;z.setLayout({dataExtent:x.dataExtent},true);return G}function r(w,F,A,C,z){if(!C){return A}var E=w.get("visibleMin");var B=z.length;var y=B;for(var x=B-1;x>=0;x--){var D=z[C==="asc"?B-x-1:x].getValue();if(D/A*F<E){y=x;A-=D}}C==="asc"?z.splice(0,B-y):z.splice(y,B-y);return A}function t(w,x){if(x){w.sort(function(z,y){return x==="asc"?z.getValue()-y.getValue():y.getValue()-z.getValue()})}return w}function l(D,y,C){var z=0;for(var x=0,w=y.length;x<w;x++){z+=y[x].getValue()}var B=D.get("visualDimension");var A;if(!y||!y.length){A=[NaN,NaN]}else{if(B==="value"&&C){A=[y[y.length-1].getValue(),y[0].getValue()];C==="asc"&&A.reverse()}else{var A=[Infinity,-Infinity];g(y,function(F){var E=F.getValue(B);E<A[0]&&(A[0]=E);E>A[1]&&(A[1]=E)})}}return{sum:z,dataExtent:A}}function p(F,D,C){var x=0;var E=Infinity;for(var z=0,w,B=F.length;z<B;z++){w=F[z].getLayout().area;if(w){w<E&&(E=w);w>x&&(x=w)}}var y=F.area*F.area;var A=D*D*C;return y?m((A*x)/y,y/(A*E)):Infinity}function v(E,F,w,L,J){var M=F===w.width?0:1;var O=1-M;var A=["x","y"];var D=["width","height"];var G=w[A[M]];var P=F?E.area/F:0;if(J||P>w[D[O]]){P=w[D[O]]}for(var N=0,B=E.length;N<B;N++){var K=E[N];var I={};var C=P?K.getLayout().area/P:0;var y=I[D[O]]=m(P-2*L,0);var H=w[A[M]]+w[D[M]]-G;var x=(N===B-1||H<C)?H:C;var z=I[D[M]]=m(x-2*L,0);I[A[O]]=w[A[O]]+i(L,y/2);I[A[M]]=G+i(L,z/2);G+=x;K.setLayout(I,true)}w[A[O]]+=P;w[D[O]]-=P}function q(z,F,C,H,M){var B=(F||{}).node;var I=[H,M];if(!B||B===C){return I}var J;var K=H*M;var x=K*z.option.zoomToNodeRatio;while(J=B.parentNode){var E=0;var G=J.children;for(var A=0,D=G.length;A<D;A++){E+=G[A].getValue()}var L=B.getValue();if(L===0){return I}x*=E/L;var w=J.getModel("itemStyle.normal").get("borderWidth");if(isFinite(w)){x+=4*w*w+4*w*Math.pow(x,0.5)}x>h.MAX_SAFE_INTEGER&&(x=h.MAX_SAFE_INTEGER);B=J}x<K&&(x=K);var y=Math.pow(x/K,0.5);return[H*y,M*y]}function d(x,C,z){if(C){return{x:C.x,y:C.y}}var E={x:0,y:0};if(!z){return E}var A=z.node;var y=A.getLayout();if(!y){return E}var B=[y.width/2,y.height/2];var w=A;while(w){var D=w.getLayout();B[0]+=D.x;B[1]+=D.y;w=w.parentNode}return{x:x.width/2-B[0],y:x.height/2-B[1]}}function n(x,A,y,C,B){var D=x.getLayout();var E=y[B];var z=E&&E===x;if((E&&!z)||(B===y.length&&x!==C)){return}x.setLayout({isInView:true,invisible:!z&&!A.intersect(D),isAboveViewRoot:z},true);var w=new e(A.x-D.x,A.y-D.y,A.width,A.height);g(x.viewChildren||[],function(F){n(F,w,y,C,B+1)})}return j});