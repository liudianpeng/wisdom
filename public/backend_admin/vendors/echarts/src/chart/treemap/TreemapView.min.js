define(function(j){var r=j("zrender/core/util");var p=j("../../util/graphic");var d=j("../../data/DataDiffer");var a=j("./helper");var o=j("./Breadcrumb");var m=j("../../component/helper/RoamController");var c=j("zrender/core/BoundingRect");var t=j("zrender/core/matrix");var l=j("../../util/animation");var w=r.bind;var q=p.Group;var i=p.Rect;var e=r.each;var f=3;var s=["label","normal"];var u=["label","emphasis"];var b=10;var v=1;var n=2;return j("../../echarts").extendChartView({type:"treemap",init:function(y,x){this._containerGroup;this._storage=k();this._oldTree;this._breadcrumb;this._controller;this._state="ready";this._mayClick},render:function(B,E,G,H){var x=E.findComponents({mainType:"series",subType:"treemap",query:H});if(r.indexOf(x,B)<0){return}this.seriesModel=B;this.api=G;this.ecModel=E;var F=a.retrieveTargetInfo(H,B);var I=H&&H.type;var A=B.layoutInfo;var D=!this._oldTree;var z=this._storage;var y=(I==="treemapRootToNode"&&F&&z)?{rootNodeGroup:z.nodeGroup[F.node.getRawIndex()],direction:H.direction}:null;var C=this._giveContainerGroup(A);var J=this._doRender(C,B,y);(!D&&(!I||I==="treemapZoomToNode"||I==="treemapRootToNode"))?this._doAnimation(C,J,B,y):J.renderFinally();this._resetController(G);this._renderBreadcrumb(B,G,F)},_giveContainerGroup:function(x){var y=this._containerGroup;if(!y){y=this._containerGroup=new q();this._initEvents(y);this.group.add(y)}y.position=[x.x,x.y];return y},_doRender:function(G,C,B){var A=C.getData().tree;var x=this._oldTree;var J=k();var D=k();var E=this._storage;var z=[];var K=r.curry(h,C,D,E,B,J,z);y(A.root?[A.root]:[],(x&&x.root)?[x.root]:[],G,A===x||!x,0);var I=H(E);this._oldTree=A;this._storage=D;return{lastsForAnimation:J,willDeleteEls:I,renderFinally:F};function y(R,Q,N,L,P){if(L){Q=R;e(R,function(T,S){!T.isRemoved()&&O(S,S)})}else{(new d(Q,R,M,M)).add(O).update(O).remove(r.curry(O,null)).execute()}function M(S){return S.getId()}function O(T,W){var S=T!=null?R[T]:null;var V=W!=null?Q[W]:null;var U=K(S,V,N,P);U&&y(S&&S.viewChildren||[],V&&V.viewChildren||[],U,L,P+1)}}function H(M){var L=k();M&&e(M,function(N,O){var P=L[O];e(N,function(Q){Q&&(P.push(Q),Q.__tmWillDelete=1)})});return L}function F(){e(I,function(L){e(L,function(M){M.parent&&M.parent.remove(M)})});e(z,function(L){L.invisible=true;L.dirty()})}},_doAnimation:function(D,C,x,A){if(!x.get("animation")){return}var z=x.get("animationDurationUpdate");var B=x.get("animationEasing");var y=l.createWrap();e(C.willDeleteEls,function(E,F){e(E,function(J,G){if(J.invisible){return}var I=J.parent;var L;if(A&&A.direction==="drillDown"){L=I===A.rootNodeGroup?{shape:{x:0,y:0,width:I.__tmNodeWidth,height:I.__tmNodeHeight},style:{opacity:0}}:{style:{opacity:0}}}else{var K=0;var H=0;if(!I.__tmWillDelete){K=I.__tmNodeWidth/2;H=I.__tmNodeHeight/2}L=F==="nodeGroup"?{position:[K,H],style:{opacity:0}}:{shape:{x:K,y:H,width:0,height:0},style:{opacity:0}}}L&&y.add(J,L,z,B)})});e(this._storage,function(E,F){e(E,function(H,G){var I=C.lastsForAnimation[F][G];var J={};if(!I){return}if(F==="nodeGroup"){if(I.old){J.position=H.position.slice();H.position=I.old}}else{if(I.old){J.shape=r.extend({},H.shape);H.setShape(I.old)}if(I.fadein){H.setStyle("opacity",0);J.style={opacity:1}}else{if(H.style.opacity!==1){J.style={opacity:1}}}}y.add(H,J,z,B)})},this);this._state="animating";y.done(w(function(){this._state="ready";C.renderFinally()},this)).start()},_resetController:function(y){var x=this._controller;if(!x){x=this._controller=new m(y.getZr());x.enable(this.seriesModel.get("roam"));x.on("pan",w(this._onPan,this));x.on("zoom",w(this._onZoom,this))}var z=new c(0,0,y.getWidth(),y.getHeight());x.rectProvider=function(){return z}},_clearController:function(){var x=this._controller;if(x){x.off("pan").off("zoom");x=null}},_onPan:function(A,z){this._mayClick=false;if(this._state!=="animating"&&(Math.abs(A)>f||Math.abs(z)>f)){var y=this.seriesModel.getData().tree.root;if(!y){return}var x=y.getLayout();if(!x){return}this.api.dispatchAction({type:"treemapMove",from:this.uid,seriesId:this.seriesModel.id,rootRect:{x:x.x+A,y:x.y+z,width:x.width,height:x.height}})}},_onZoom:function(E,B,A){this._mayClick=false;if(this._state!=="animating"){var z=this.seriesModel.getData().tree.root;if(!z){return}var y=z.getLayout();if(!y){return}var C=new c(y.x,y.y,y.width,y.height);var D=this.seriesModel.layoutInfo;B-=D.x;A-=D.y;var x=t.create();t.translate(x,x,[-B,-A]);t.scale(x,x,[E,E]);t.translate(x,x,[B,A]);C.applyTransform(x);this.api.dispatchAction({type:"treemapRender",from:this.uid,seriesId:this.seriesModel.id,rootRect:{x:C.x,y:C.y,width:C.width,height:C.height}})}},_initEvents:function(y){y.on("mousedown",function(z){this._state==="ready"&&(this._mayClick=true)},this);y.on("mouseup",function(z){if(this._mayClick){this._mayClick=false;this._state==="ready"&&x.call(this,z)}},this);function x(D){var z=this.seriesModel.get("nodeClick",true);if(!z){return}var F=this.findTarget(D.offsetX,D.offsetY);if(!F){return}var C=F.node;if(C.getLayout().isLeafRoot){this._rootToNode(F)}else{if(z==="zoomToNode"){this._zoomToNode(F)}else{if(z==="link"){var A=C.hostTree.data.getItemModel(C.dataIndex);var B=A.get("link",true);var E=A.get("target",true)||"blank";B&&window.open(B,E)}}}}},_renderBreadcrumb:function(x,z,A){if(!A){A=this.findTarget(z.getWidth()/2,z.getHeight()/2);if(!A){A={node:x.getData().tree.root}}}(this._breadcrumb||(this._breadcrumb=new o(this.group,w(y,this)))).render(x,z,A.node);function y(B){if(this._state!=="animating"){a.aboveViewRoot(x.getViewRoot(),B)?this._rootToNode({node:B}):this._zoomToNode({node:B})}}},remove:function(){this._clearController();this._containerGroup&&this._containerGroup.removeAll();this._storage=k();this._state="ready";this._breadcrumb&&this._breadcrumb.remove()},dispose:function(){this._clearController()},_zoomToNode:function(x){this.api.dispatchAction({type:"treemapZoomToNode",from:this.uid,seriesId:this.seriesModel.id,targetNode:x.node})},_rootToNode:function(x){this.api.dispatchAction({type:"treemapRootToNode",from:this.uid,seriesId:this.seriesModel.id,targetNode:x.node})},findTarget:function(z,C){var B;var A=this.seriesModel.getViewRoot();A.eachNode({attr:"viewChildren",order:"preorder"},function(E){var D=this._storage.background[E.getRawIndex()];if(D){var x=D.transformCoordToLocal(z,C);var y=D.shape;if(y.x<=x[0]&&x[0]<=y.x+y.width&&y.y<=x[1]&&x[1]<=y.y+y.height){B={node:E,offsetX:x[0],offsetY:x[1]}}else{return false}}},this);return B}});function k(){return{nodeGroup:[],background:[],content:[]}}function h(L,A,D,E,K,F,I,N,C,W){if(!I){return}var R=I.getLayout();if(!R||!R.isInView){return}var X=R.width;var J=R.height;var H=R.invisible;var y=I.getRawIndex();var V=N&&N.getRawIndex();var G=z("nodeGroup",q);if(!G){return}C.add(G);G.position=[R.x||0,R.y||0];G.__tmNodeWidth=X;G.__tmNodeHeight=J;if(R.isAboveViewRoot){return G}var B=z("background",i,W,v);if(B){B.setShape({x:0,y:0,width:X,height:J});M(B,function(){B.setStyle("fill",I.getVisual("borderColor",true))});G.add(B)}var x=I.viewChildren;if(!x||!x.length){var O=z("content",i,W,n);O&&T(G)}return G;function T(ac){O.dataIndex=I.dataIndex;O.seriesIndex=L.seriesIndex;var Z=R.borderWidth;var Y=Math.max(X-2*Z,0);var ab=Math.max(J-2*Z,0);O.culling=true;O.setShape({x:Z,y:Z,width:Y,height:ab});var aa=I.getVisual("color",true);M(O,function(){var ae={fill:aa};var ad=I.getModel("itemStyle.emphasis").getItemStyle();U(ae,ad,aa,Y,ab);O.setStyle(ae);p.setHoverStyle(O,ad)});ac.add(O)}function M(Z,Y){if(!H){Y();if(!Z.__tmWillVisible){Z.invisible=false}}else{!Z.invisible&&F.push(Z)}}function U(af,Z,ab,aa,ac){var ae=I.getModel();var ad=ae.get("name");if(R.isLeafRoot){var Y=L.get("drillDownIcon",true);ad+=Y?"  "+Y:""}Q(ad,af,ae,s,ab,aa,ac);Q(ad,Z,ae,u,ab,aa,ac)}function Q(af,Z,ab,ac,ag,Y,ae){var ah=ab.getModel(ac);var aa=ah.getModel("textStyle");p.setText(Z,ah,ag);Z.textAlign=aa.get("align");Z.textVerticalAlign=aa.get("baseline");var ad=aa.getTextRect(af);if(!ah.getShallow("show")||ad.height>ae){Z.text=""}else{if(ad.width>Y){Z.text=aa.get("ellipsis")?aa.ellipsis(af,Y):""}else{Z.text=af}}}function z(ab,Z,ad,ac){var aa=V!=null&&D[ab][V];var Y=K[ab];if(aa){D[ab][V]=null;S(Y,aa,ab)}else{if(!H){aa=new Z({z:g(ad,ac)});aa.__tmDepth=ad;aa.__tmStorageName=ab;P(Y,aa,ab)}}return(A[ab][y]=aa)}function S(Y,aa,Z){var ab=Y[y]={};ab.old=Z==="nodeGroup"?aa.position.slice():r.extend({},aa.shape)}function P(aa,ad,ac){var ae=aa[y]={};var Z=I.parentNode;if(Z&&(!E||E.direction==="drillDown")){var Y=0;var af=0;var ab=K.background[Z.getRawIndex()];if(!E&&ab&&ab.old){Y=ab.old.width;af=ab.old.height}ae.old=ac==="nodeGroup"?[0,af]:{x:Y,y:af,width:0,height:0}}ae.fadein=ac!=="nodeGroup"}}function g(z,y){var x=z*b+y;return(x-1)/x}});