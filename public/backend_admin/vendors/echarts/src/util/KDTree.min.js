define(function(c){var d=c("./quickSelect");function b(e,f){this.left=null;this.right=null;this.axis=e;this.data=f}var a=function(e,f){if(!e.length){return}if(!f){f=e[0].array.length}this.dimension=f;this.root=this._buildTree(e,0,e.length-1,0);this._stack=[];this._nearstNList=[]};a.prototype._buildTree=function(h,k,e,g){if(e<k){return null}var j=Math.floor((k+e)/2);j=d(h,k,e,j,function(m,l){return m.array[g]-l.array[g]});var f=h[j];var i=new b(g,f);g=(g+1)%this.dimension;if(e>k){i.left=this._buildTree(h,k,j-1,g);i.right=this._buildTree(h,j+1,e,g)}return i};a.prototype.nearest=function(f,m){var n=this.root;var h=this._stack;var k=0;var j=Infinity;var g=null;if(n.data!==f){j=m(n.data,f);g=n}if(f.array[n.axis]<n.data.array[n.axis]){n.right&&(h[k++]=n.right);n.left&&(h[k++]=n.left)}else{n.left&&(h[k++]=n.left);n.right&&(h[k++]=n.right)}while(k--){n=h[k];var l=f.array[n.axis]-n.data.array[n.axis];var i=l<0;var e=false;l=l*l;if(l<j){l=m(n.data,f);if(l<j&&n.data!==f){j=l;g=n}e=true}if(i){if(e){n.right&&(h[k++]=n.right)}n.left&&(h[k++]=n.left)}else{if(e){n.left&&(h[k++]=n.left)}n.right&&(h[k++]=n.right)}}return g.data};a.prototype._addNearest=function(h,j,g){var f=this._nearstNList;for(var e=h-1;e>0;e--){if(j>=f[e-1].dist){break}else{f[e].dist=f[e-1].dist;f[e].node=f[e-1].node}}f[e].dist=j;f[e].node=g};a.prototype.nearestN=function(k,j,p,f){if(j<=0){f.length=0;return f}var r=this.root;var l=this._stack;var n=0;var e=this._nearstNList;for(var h=0;h<j;h++){if(!e[h]){e[h]={}}e[h].dist=0;e[h].node=null}var o=p(r.data,k);var q=0;if(r.data!==k){q++;this._addNearest(q,o,r)}if(k.array[r.axis]<r.data.array[r.axis]){r.right&&(l[n++]=r.right);r.left&&(l[n++]=r.left)}else{r.left&&(l[n++]=r.left);r.right&&(l[n++]=r.right)}while(n--){r=l[n];var o=k.array[r.axis]-r.data.array[r.axis];var m=o<0;var g=false;o=o*o;if(q<j||o<e[q-1].dist){o=p(r.data,k);if((q<j||o<e[q-1].dist)&&r.data!==k){if(q<j){q++}this._addNearest(q,o,r)}g=true}if(m){if(g){r.right&&(l[n++]=r.right)}r.left&&(l[n++]=r.left)}else{if(g){r.left&&(l[n++]=r.left)}r.right&&(l[n++]=r.right)}}for(var h=0;h<q;h++){f[h]=e[h].node.data}f.length=q;return f};return a});