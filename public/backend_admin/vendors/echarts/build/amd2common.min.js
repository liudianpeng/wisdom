var glob=require("glob");var fsExtra=require("fs-extra");var esprima=require("esprima");function run(a){glob("**/*.js",{cwd:__dirname+"/../src/"},function(c,b){b.forEach(function(d){var e=parse(fsExtra.readFileSync(__dirname+"/../src/"+d,"utf-8"));e=e.replace(/require\(([\'"])zrender\//g,"require($1zrender/lib/");fsExtra.outputFileSync(__dirname+"/../lib/"+d,e,"utf-8")});a&&a()})}if(require.main===module){run()}else{module.exports=run}var MAGIC_DEPS={exports:true,module:true,require:true};var SIMPLIFIED_CJS=["require","exports","module"];function parse(e){var c="";var a=esprima.parse(e,{range:true,raw:true});var f=a.body.filter(isDefine);if(f.length>1){throw new Error('Each file can have only a single define call. Found "'+f.length+'"')}else{if(!f.length){return e}}var h=f[0];var d=h.expression["arguments"];var b=getFactory(d);var g=getUseStrict(b);if(g){c+=g.expression.raw+";\n"}c+=e.substring(0,h.range[0]);c+=getRequires(d,b);c+=getBody(e,b.body,g);c+=e.substring(h.range[1],e.length);return c}function getRequires(b,a){var c=[];var e=getDependenciesNames(b);var d=a.params.map(function(g,f){return{name:g.name,dep:(e.length)?e[f]:SIMPLIFIED_CJS[f]}});d.forEach(function(f){if(MAGIC_DEPS[f.dep]&&!MAGIC_DEPS[f.name]){c.push("var "+f.name+" = "+f.dep+";")}else{if(f.dep&&!MAGIC_DEPS[f.dep]){c.push("var "+f.name+" = require('"+f.dep+"');")}}});return c.join("\n")}function getDependenciesNames(b){var c=[];var a=b.filter(function(d){return d.type==="ArrayExpression"})[0];if(a){c=a.elements.map(function(d){return d.value})}return c}function isDefine(a){return a.type==="ExpressionStatement"&&a.expression.type==="CallExpression"&&a.expression.callee.type==="Identifier"&&a.expression.callee.name==="define"}function getFactory(a){return a.filter(function(b){return b.type==="FunctionExpression"})[0]}function getBody(d,b,f){var c=b.body.filter(function(g){return g.type==="ReturnStatement"})[0];var a="";var e=f?f.expression.range[1]+1:b.range[0]+1;if(c){a+=d.substring(e,c.range[0]);a+="module.exports ="+d.substring(c.range[0]+6,b.range[1]-1)}else{a=d.substring(e,b.range[1]-1)}return a}function getUseStrict(a){return a.body.body.filter(isUseStrict)[0]}function isUseStrict(a){return a.type==="ExpressionStatement"&&a.expression.type==="Literal"&&a.expression.value==="use strict"};