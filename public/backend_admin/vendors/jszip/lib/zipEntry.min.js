"use strict";var StringReader=require("./stringReader");var utils=require("./utils");var CompressedObject=require("./compressedObject");var jszipProto=require("./object");var support=require("./support");var MADE_BY_DOS=0;var MADE_BY_UNIX=3;function ZipEntry(a,b){this.options=a;this.loadOptions=b}ZipEntry.prototype={isEncrypted:function(){return(this.bitFlag&1)===1},useUTF8:function(){return(this.bitFlag&2048)===2048},prepareCompressedContent:function(a,c,b){return function(){var e=a.index;a.setIndex(c);var d=a.readData(b);a.setIndex(e);return d}},prepareContent:function(a,e,d,c,b){return function(){var f=utils.transformTo(c.uncompressInputType,this.getCompressedContent());var g=c.uncompress(f);if(g.length!==b){throw new Error("Bug : uncompressed data size mismatch")}return g}},readLocalPart:function(a){var b,c;a.skip(22);this.fileNameLength=a.readInt(2);c=a.readInt(2);this.fileName=a.readData(this.fileNameLength);a.skip(c);if(this.compressedSize==-1||this.uncompressedSize==-1){throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize == -1 || uncompressedSize == -1)")}b=utils.findCompression(this.compressionMethod);if(b===null){throw new Error("Corrupted zip : compression "+utils.pretty(this.compressionMethod)+" unknown (inner file : "+utils.transformTo("string",this.fileName)+")")}this.decompressed=new CompressedObject();this.decompressed.compressedSize=this.compressedSize;this.decompressed.uncompressedSize=this.uncompressedSize;this.decompressed.crc32=this.crc32;this.decompressed.compressionMethod=this.compressionMethod;this.decompressed.getCompressedContent=this.prepareCompressedContent(a,a.index,this.compressedSize,b);this.decompressed.getContent=this.prepareContent(a,a.index,this.compressedSize,b,this.uncompressedSize);if(this.loadOptions.checkCRC32){this.decompressed=utils.transformTo("string",this.decompressed.getContent());if(jszipProto.crc32(this.decompressed)!==this.crc32){throw new Error("Corrupted zip : CRC32 mismatch")}}},readCentralPart:function(a){this.versionMadeBy=a.readInt(2);this.versionNeeded=a.readInt(2);this.bitFlag=a.readInt(2);this.compressionMethod=a.readString(2);this.date=a.readDate();this.crc32=a.readInt(4);this.compressedSize=a.readInt(4);this.uncompressedSize=a.readInt(4);this.fileNameLength=a.readInt(2);this.extraFieldsLength=a.readInt(2);this.fileCommentLength=a.readInt(2);this.diskNumberStart=a.readInt(2);this.internalFileAttributes=a.readInt(2);this.externalFileAttributes=a.readInt(4);this.localHeaderOffset=a.readInt(4);if(this.isEncrypted()){throw new Error("Encrypted zip are not supported")}this.fileName=a.readData(this.fileNameLength);this.readExtraFields(a);this.parseZIP64ExtraField(a);this.fileComment=a.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null;this.dosPermissions=null;var a=this.versionMadeBy>>8;this.dir=this.externalFileAttributes&16?true:false;if(a===MADE_BY_DOS){this.dosPermissions=this.externalFileAttributes&63}if(a===MADE_BY_UNIX){this.unixPermissions=(this.externalFileAttributes>>16)&65535}if(!this.dir&&this.fileNameStr.slice(-1)==="/"){this.dir=true}},parseZIP64ExtraField:function(a){if(!this.extraFields[1]){return}var b=new StringReader(this.extraFields[1].value);if(this.uncompressedSize===utils.MAX_VALUE_32BITS){this.uncompressedSize=b.readInt(8)}if(this.compressedSize===utils.MAX_VALUE_32BITS){this.compressedSize=b.readInt(8)}if(this.localHeaderOffset===utils.MAX_VALUE_32BITS){this.localHeaderOffset=b.readInt(8)}if(this.diskNumberStart===utils.MAX_VALUE_32BITS){this.diskNumberStart=b.readInt(4)}},readExtraFields:function(b){var e=b.index,c,d,a;this.extraFields=this.extraFields||{};while(b.index<e+this.extraFieldsLength){c=b.readInt(2);d=b.readInt(2);a=b.readString(d);this.extraFields[c]={id:c,length:d,value:a}}},handleUTF8:function(){var d=support.uint8array?"uint8array":"array";if(this.useUTF8()){this.fileNameStr=jszipProto.utf8decode(this.fileName);this.fileCommentStr=jszipProto.utf8decode(this.fileComment)}else{var b=this.findExtraFieldUnicodePath();if(b!==null){this.fileNameStr=b}else{var c=utils.transformTo(d,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(c)}var e=this.findExtraFieldUnicodeComment();if(e!==null){this.fileCommentStr=e}else{var a=utils.transformTo(d,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(a)}}},findExtraFieldUnicodePath:function(){var b=this.extraFields[28789];if(b){var a=new StringReader(b.value);if(a.readInt(1)!==1){return null}if(jszipProto.crc32(this.fileName)!==a.readInt(4)){return null}return jszipProto.utf8decode(a.readString(b.length-5))}return null},findExtraFieldUnicodeComment:function(){var b=this.extraFields[25461];if(b){var a=new StringReader(b.value);if(a.readInt(1)!==1){return null}if(jszipProto.crc32(this.fileComment)!==a.readInt(4)){return null}return jszipProto.utf8decode(a.readString(b.length-5))}return null}};module.exports=ZipEntry;