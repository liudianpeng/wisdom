"use strict";var StringReader=require("./stringReader");var NodeBufferReader=require("./nodeBufferReader");var Uint8ArrayReader=require("./uint8ArrayReader");var ArrayReader=require("./arrayReader");var utils=require("./utils");var sig=require("./signature");var ZipEntry=require("./zipEntry");var support=require("./support");var jszipProto=require("./object");function ZipEntries(b,a){this.files=[];this.loadOptions=a;if(b){this.load(b)}}ZipEntries.prototype={checkSignature:function(b){var a=this.reader.readString(4);if(a!==b){throw new Error("Corrupted zip or bug : unexpected signature ("+utils.pretty(a)+", expected "+utils.pretty(b)+")")}},isSignature:function(e,d){var c=this.reader.index;this.reader.setIndex(e);var b=this.reader.readString(4);var a=b===d;this.reader.setIndex(c);return a},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2);this.diskWithCentralDirStart=this.reader.readInt(2);this.centralDirRecordsOnThisDisk=this.reader.readInt(2);this.centralDirRecords=this.reader.readInt(2);this.centralDirSize=this.reader.readInt(4);this.centralDirOffset=this.reader.readInt(4);this.zipCommentLength=this.reader.readInt(2);var a=this.reader.readData(this.zipCommentLength);var c=support.uint8array?"uint8array":"array";var b=utils.transformTo(c,a);this.zipComment=this.loadOptions.decodeFileName(b)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8);this.versionMadeBy=this.reader.readString(2);this.versionNeeded=this.reader.readInt(2);this.diskNumber=this.reader.readInt(4);this.diskWithCentralDirStart=this.reader.readInt(4);this.centralDirRecordsOnThisDisk=this.reader.readInt(8);this.centralDirRecords=this.reader.readInt(8);this.centralDirSize=this.reader.readInt(8);this.centralDirOffset=this.reader.readInt(8);this.zip64ExtensibleData={};var e=this.zip64EndOfCentralSize-44,b=0,c,d,a;while(b<e){c=this.reader.readInt(2);d=this.reader.readInt(4);a=this.reader.readString(d);this.zip64ExtensibleData[c]={id:c,length:d,value:a}}},readBlockZip64EndOfCentralLocator:function(){this.diskWithZip64CentralDirStart=this.reader.readInt(4);this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8);this.disksCount=this.reader.readInt(4);if(this.disksCount>1){throw new Error("Multi-volumes zip are not supported")}},readLocalFiles:function(){var b,a;for(b=0;b<this.files.length;b++){a=this.files[b];this.reader.setIndex(a.localHeaderOffset);this.checkSignature(sig.LOCAL_FILE_HEADER);a.readLocalPart(this.reader);a.handleUTF8();a.processAttributes()}},readCentralDir:function(){var a;this.reader.setIndex(this.centralDirOffset);while(this.reader.readString(4)===sig.CENTRAL_FILE_HEADER){a=new ZipEntry({zip64:this.zip64},this.loadOptions);a.readCentralPart(this.reader);this.files.push(a)}if(this.centralDirRecords!==this.files.length){if(this.centralDirRecords!==0&&this.files.length===0){throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)}else{}}},readEndOfCentral:function(){var e=this.reader.lastIndexOfSignature(sig.CENTRAL_DIRECTORY_END);if(e<0){var c=!this.isSignature(0,sig.LOCAL_FILE_HEADER);if(c){throw new Error("Can't find end of central directory : is this a zip file ? If it is, see http://stuk.github.io/jszip/documentation/howto/read_zip.html")}else{throw new Error("Corrupted zip : can't find end of central directory")}}this.reader.setIndex(e);var a=e;this.checkSignature(sig.CENTRAL_DIRECTORY_END);this.readBlockEndOfCentral();if(this.diskNumber===utils.MAX_VALUE_16BITS||this.diskWithCentralDirStart===utils.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===utils.MAX_VALUE_16BITS||this.centralDirRecords===utils.MAX_VALUE_16BITS||this.centralDirSize===utils.MAX_VALUE_32BITS||this.centralDirOffset===utils.MAX_VALUE_32BITS){this.zip64=true;e=this.reader.lastIndexOfSignature(sig.ZIP64_CENTRAL_DIRECTORY_LOCATOR);if(e<0){throw new Error("Corrupted zip : can't find the ZIP64 end of central directory locator")}this.reader.setIndex(e);this.checkSignature(sig.ZIP64_CENTRAL_DIRECTORY_LOCATOR);this.readBlockZip64EndOfCentralLocator();if(!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,sig.ZIP64_CENTRAL_DIRECTORY_END)){this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(sig.ZIP64_CENTRAL_DIRECTORY_END);if(this.relativeOffsetEndOfZip64CentralDir<0){throw new Error("Corrupted zip : can't find the ZIP64 end of central directory")}}this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir);this.checkSignature(sig.ZIP64_CENTRAL_DIRECTORY_END);this.readBlockZip64EndOfCentral()}var d=this.centralDirOffset+this.centralDirSize;if(this.zip64){d+=20;d+=12+this.zip64EndOfCentralSize}var b=a-d;if(b>0){if(this.isSignature(a,sig.CENTRAL_FILE_HEADER)){}else{this.reader.zero=b}}else{if(b<0){throw new Error("Corrupted zip: missing "+Math.abs(b)+" bytes.")}}},prepareReader:function(b){var a=utils.getTypeOf(b);utils.checkSupport(a);if(a==="string"&&!support.uint8array){this.reader=new StringReader(b,this.loadOptions.optimizedBinaryString)}else{if(a==="nodebuffer"){this.reader=new NodeBufferReader(b)}else{if(support.uint8array){this.reader=new Uint8ArrayReader(utils.transformTo("uint8array",b))}else{if(support.array){this.reader=new ArrayReader(utils.transformTo("array",b))}else{throw new Error("Unexpected error: unsupported type '"+a+"'")}}}}},load:function(a){this.prepareReader(a);this.readEndOfCentral();this.readCentralDir();this.readLocalFiles()}};module.exports=ZipEntries;