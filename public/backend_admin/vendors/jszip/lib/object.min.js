"use strict";var support=require("./support");var utils=require("./utils");var crc32=require("./crc32");var signature=require("./signature");var defaults=require("./defaults");var base64=require("./base64");var compressions=require("./compressions");var CompressedObject=require("./compressedObject");var nodeBuffer=require("./nodeBuffer");var utf8=require("./utf8");var StringWriter=require("./stringWriter");var Uint8ArrayWriter=require("./uint8ArrayWriter");var getRawData=function(a){if(a._data instanceof CompressedObject){a._data=a._data.getContent();a.options.binary=true;a.options.base64=false;if(utils.getTypeOf(a._data)==="uint8array"){var b=a._data;a._data=new Uint8Array(b.length);if(b.length!==0){a._data.set(b,0)}}}return a._data};var getBinaryData=function(b){var a=getRawData(b),c=utils.getTypeOf(a);if(c==="string"){if(!b.options.binary){if(support.nodebuffer){return nodeBuffer(a,"utf-8")}}return b.asBinary()}return a};var dataToString=function(b){var a=getRawData(this);if(a===null||typeof a==="undefined"){return""}if(this.options.base64){a=base64.decode(a)}if(b&&this.options.binary){a=out.utf8decode(a)}else{a=utils.transformTo("string",a)}if(!b&&!this.options.binary){a=utils.transformTo("string",out.utf8encode(a))}return a};var ZipObject=function(b,c,a){this.name=b;this.dir=a.dir;this.date=a.date;this.comment=a.comment;this.unixPermissions=a.unixPermissions;this.dosPermissions=a.dosPermissions;this._data=c;this.options=a;this._initialMetadata={dir:a.dir,date:a.date}};ZipObject.prototype={asText:function(){return dataToString.call(this,true)},asBinary:function(){return dataToString.call(this,false)},asNodeBuffer:function(){var a=getBinaryData(this);return utils.transformTo("nodebuffer",a)},asUint8Array:function(){var a=getBinaryData(this);return utils.transformTo("uint8array",a)},asArrayBuffer:function(){return this.asUint8Array().buffer}};var decToHex=function(d,a){var c="",b;for(b=0;b<a;b++){c+=String.fromCharCode(d&255);d=d>>>8}return c};var prepareFileAttrs=function(a){a=a||{};if(a.base64===true&&(a.binary===null||a.binary===undefined)){a.binary=true}a=utils.extend(a,defaults);a.date=a.date||new Date();if(a.compression!==null){a.compression=a.compression.toUpperCase()}return a};var fileAdd=function(c,e,f){var a=utils.getTypeOf(e),d;f=prepareFileAttrs(f);if(typeof f.unixPermissions==="string"){f.unixPermissions=parseInt(f.unixPermissions,8)}if(f.unixPermissions&&(f.unixPermissions&16384)){f.dir=true}if(f.dosPermissions&&(f.dosPermissions&16)){f.dir=true}if(f.dir){c=forceTrailingSlash(c)}if(f.createFolders&&(d=parentFolder(c))){folderAdd.call(this,d,true)}if(f.dir||e===null||typeof e==="undefined"){f.base64=false;f.binary=false;e=null;a=null}else{if(a==="string"){if(f.binary&&!f.base64){if(f.optimizedBinaryString!==true){e=utils.string2binary(e)}}}else{f.base64=false;f.binary=true;if(!a&&!(e instanceof CompressedObject)){throw new Error("The data of '"+c+"' is in an unsupported format !")}if(a==="arraybuffer"){e=utils.transformTo("uint8array",e)}}}var b=new ZipObject(c,e,f);this.files[c]=b;return b};var parentFolder=function(b){if(b.slice(-1)=="/"){b=b.substring(0,b.length-1)}var a=b.lastIndexOf("/");return(a>0)?b.substring(0,a):""};var forceTrailingSlash=function(a){if(a.slice(-1)!="/"){a+="/"}return a};var folderAdd=function(a,b){b=(typeof b!=="undefined")?b:false;a=forceTrailingSlash(a);if(!this.files[a]){fileAdd.call(this,a,null,{dir:true,createFolders:b})}return this.files[a]};var generateCompressedObjectFrom=function(c,b,e){var a=new CompressedObject(),d;if(c._data instanceof CompressedObject){a.uncompressedSize=c._data.uncompressedSize;a.crc32=c._data.crc32;if(a.uncompressedSize===0||c.dir){b=compressions.STORE;a.compressedContent="";a.crc32=0}else{if(c._data.compressionMethod===b.magic){a.compressedContent=c._data.getCompressedContent()}else{d=c._data.getContent();a.compressedContent=b.compress(utils.transformTo(b.compressInputType,d),e)}}}else{d=getBinaryData(c);if(!d||d.length===0||c.dir){b=compressions.STORE;d=""}a.uncompressedSize=d.length;a.crc32=crc32(d);a.compressedContent=b.compress(utils.transformTo(b.compressInputType,d),e)}a.compressedSize=a.compressedContent.length;a.compressionMethod=b.magic;return a};var generateUnixExternalFileAttr=function(b,c){var a=b;if(!b){a=c?16893:33204}return(a&65535)<<16};var generateDosExternalFileAttr=function(a,b){return(a||0)&63};var generateZipParts=function(C,u,c,g,A,h){var z=c.compressedContent,m=h!==utf8.utf8encode,v=utils.transformTo("string",h(u.name)),a=utils.transformTo("string",utf8.utf8encode(u.name)),b=u.comment||"",j=utils.transformTo("string",h(b)),f=utils.transformTo("string",utf8.utf8encode(b)),y=a.length!==u.name.length,w=f.length!==b.length,l=u.options,d,r,i="",x="",e="",k,t;if(u._initialMetadata.dir!==u.dir){k=u.dir}else{k=l.dir}if(u._initialMetadata.date!==u.date){t=u.date}else{t=l.date}var B=0;var s=0;if(k){B|=16}if(A==="UNIX"){s=798;B|=generateUnixExternalFileAttr(u.unixPermissions,k)}else{s=20;B|=generateDosExternalFileAttr(u.dosPermissions,k)}d=t.getHours();d=d<<6;d=d|t.getMinutes();d=d<<5;d=d|t.getSeconds()/2;r=t.getFullYear()-1980;r=r<<4;r=r|(t.getMonth()+1);r=r<<5;r=r|t.getDate();if(y){x=decToHex(1,1)+decToHex(crc32(v),4)+a;i+="\x75\x70"+decToHex(x.length,2)+x}if(w){e=decToHex(1,1)+decToHex(this.crc32(j),4)+f;i+="\x75\x63"+decToHex(e.length,2)+e}var q="";q+="\x0A\x00";q+=!m&&(y||w)?"\x00\x08":"\x00\x00";q+=c.compressionMethod;q+=decToHex(d,2);q+=decToHex(r,2);q+=decToHex(c.crc32,4);q+=decToHex(c.compressedSize,4);q+=decToHex(c.uncompressedSize,4);q+=decToHex(v.length,2);q+=decToHex(i.length,2);var p=signature.LOCAL_FILE_HEADER+q+v+i;var n=signature.CENTRAL_FILE_HEADER+decToHex(s,2)+q+decToHex(j.length,2)+"\x00\x00\x00\x00"+decToHex(B,4)+decToHex(g,4)+v+i+j;return{fileRecord:p,dirRecord:n,compressedObject:c}};var out={load:function(b,a){throw new Error("Load method is not defined. Is the file jszip-load.js included ?")},filter:function(f){var a=[],c,b,e,d;for(c in this.files){if(!this.files.hasOwnProperty(c)){continue}e=this.files[c];d=new ZipObject(e.name,e._data,utils.extend(e.options));b=c.slice(this.root.length,c.length);if(c.slice(0,this.root.length)===this.root&&f(b,d)){a.push(d)}}return a},file:function(a,c,d){if(arguments.length===1){if(utils.isRegExp(a)){var b=a;return this.filter(function(e,f){return !f.dir&&b.test(e)})}else{return this.filter(function(e,f){return !f.dir&&e===a})[0]||null}}else{a=this.root+a;fileAdd.call(this,a,c,d)}return this},folder:function(a){if(!a){return this}if(utils.isRegExp(a)){return this.filter(function(e,f){return f.dir&&a.test(e)})}var c=this.root+a;var d=folderAdd.call(this,c);var b=this.clone();b.root=d.name;return b},remove:function(b){b=this.root+b;var d=this.files[b];if(!d){if(b.slice(-1)!="/"){b+="/"}d=this.files[b]}if(d&&!d.dir){delete this.files[b]}else{var a=this.filter(function(e,f){return f.name.slice(0,b.length)===b});for(var c=0;c<a.length;c++){delete this.files[a[c].name]}}return this},generate:function(r){r=utils.extend(r||{},{base64:true,compression:"STORE",compressionOptions:null,type:"base64",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:utf8.utf8encode});utils.checkSupport(r.type);if(r.platform==="darwin"||r.platform==="freebsd"||r.platform==="linux"||r.platform==="sunos"){r.platform="UNIX"}if(r.platform==="win32"){r.platform="DOS"}var j=[],k=0,e=0,h,l,c=utils.transformTo("string",r.encodeFileName(r.comment||this.comment||""));for(var b in this.files){if(!this.files.hasOwnProperty(b)){continue}var g=this.files[b];var m=g.options.compression||r.compression.toUpperCase();var q=compressions[m];if(!q){throw new Error(m+" is not a valid compression method !")}var o=g.options.compressionOptions||r.compressionOptions||{};var n=generateCompressedObjectFrom.call(this,g,q,o);var a=generateZipParts.call(this,b,g,n,k,r.platform,r.encodeFileName);k+=a.fileRecord.length+n.compressedSize;e+=a.dirRecord.length;j.push(a)}var f="";f=signature.CENTRAL_DIRECTORY_END+"\x00\x00\x00\x00"+decToHex(j.length,2)+decToHex(j.length,2)+decToHex(e,4)+decToHex(k,4)+decToHex(c.length,2)+c;var p=r.type.toLowerCase();if(p==="uint8array"||p==="arraybuffer"||p==="blob"||p==="nodebuffer"){h=new Uint8ArrayWriter(k+e+f.length)}else{h=new StringWriter(k+e+f.length)}for(l=0;l<j.length;l++){h.append(j[l].fileRecord);h.append(j[l].compressedObject.compressedContent)}for(l=0;l<j.length;l++){h.append(j[l].dirRecord)}h.append(f);var d=h.finalize();switch(r.type.toLowerCase()){case"uint8array":case"arraybuffer":case"nodebuffer":return utils.transformTo(r.type.toLowerCase(),d);case"blob":return utils.arrayBuffer2Blob(utils.transformTo("arraybuffer",d),r.mimeType);case"base64":return(r.base64)?base64.encode(d):d;default:return d}},crc32:function(a,b){return crc32(a,b)},utf8encode:function(a){return utils.transformTo("string",utf8.utf8encode(a))},utf8decode:function(a){return utf8.utf8decode(a)}};module.exports=out;