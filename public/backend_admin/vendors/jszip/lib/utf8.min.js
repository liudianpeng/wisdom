"use strict";var utils=require("./utils");var support=require("./support");var nodeBuffer=require("./nodeBuffer");var _utf8len=new Array(256);for(var i=0;i<256;i++){_utf8len[i]=(i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1)}_utf8len[254]=_utf8len[254]=1;var string2buf=function(h){var a,j,d,e,b,g=h.length,f=0;for(e=0;e<g;e++){j=h.charCodeAt(e);if((j&64512)===55296&&(e+1<g)){d=h.charCodeAt(e+1);if((d&64512)===56320){j=65536+((j-55296)<<10)+(d-56320);e++}}f+=j<128?1:j<2048?2:j<65536?3:4}if(support.uint8array){a=new Uint8Array(f)}else{a=new Array(f)}for(b=0,e=0;b<f;e++){j=h.charCodeAt(e);if((j&64512)===55296&&(e+1<g)){d=h.charCodeAt(e+1);if((d&64512)===56320){j=65536+((j-55296)<<10)+(d-56320);e++}}if(j<128){a[b++]=j}else{if(j<2048){a[b++]=192|(j>>>6);a[b++]=128|(j&63)}else{if(j<65536){a[b++]=224|(j>>>12);a[b++]=128|(j>>>6&63);a[b++]=128|(j&63)}else{a[b++]=240|(j>>>18);a[b++]=128|(j>>>12&63);a[b++]=128|(j>>>6&63);a[b++]=128|(j&63)}}}}return a};var utf8border=function(b,a){var c;a=a||b.length;if(a>b.length){a=b.length}c=a-1;while(c>=0&&(b[c]&192)===128){c--}if(c<0){return a}if(c===0){return a}return(c+_utf8len[b[c]]>a)?c:a};var buf2string=function(f){var h,g,e,j,d;var b=f.length;var a=new Array(b*2);for(e=0,g=0;g<b;){j=f[g++];if(j<128){a[e++]=j;continue}d=_utf8len[j];if(d>4){a[e++]=65533;g+=d-1;continue}j&=d===2?31:d===3?15:7;while(d>1&&g<b){j=(j<<6)|(f[g++]&63);d--}if(d>1){a[e++]=65533;continue}if(j<65536){a[e++]=j}else{j-=65536;a[e++]=55296|((j>>10)&1023);a[e++]=56320|(j&1023)}}if(a.length!==e){if(a.subarray){a=a.subarray(0,e)}else{a.length=e}}return utils.applyFromCharCode(a)};exports.utf8encode=function utf8encode(a){if(support.nodebuffer){return nodeBuffer(a,"utf-8")}return string2buf(a)};exports.utf8decode=function utf8decode(e){if(support.nodebuffer){return utils.transformTo("nodebuffer",e).toString("utf-8")}e=utils.transformTo(support.uint8array?"uint8array":"array",e);var b=[],c=0,a=e.length,d=65536;while(c<a){var f=utf8border(e,Math.min(c+d,a));if(support.uint8array){b.push(buf2string(e.subarray(c,f)))}else{b.push(buf2string(e.slice(c,f)))}c=f}return b.join("")};